<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تحديث حالة الطلب | Order Status Update</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg:#f5f2ee;
      --fg:#2b2b2b;
      --accent:#8b5e3c;
      --muted:#777;
      --error:#c0392b;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#121212; --fg:#f5f2ee; --muted:#bdbdbd; --error:#ef5350; }
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--fg);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:24px;
    }
    main{
      max-width:420px;
      width:100%;
      background:rgba(255,255,255,0.84);
      color:inherit;
      border-radius:18px;
      padding:24px 22px;
      box-shadow:0 12px 32px rgba(0,0,0,0.12);
      backdrop-filter:saturate(160%) blur(12px);
    }
    @media (prefers-color-scheme: dark){
      main{ background:rgba(32,32,32,0.82); }
    }
    h1{
      margin:0 0 12px;
      font-size:20px;
    }
    p{ margin:0 0 12px; line-height:1.6; }
    .status{ font-weight:600; }
    .status.success{ color:var(--accent); }
    .status.error{ color:var(--error); }
    .hint{ color:var(--muted); font-size:13px; margin-top:6px; }
    button{
      appearance:none;
      border:none;
      border-radius:10px;
      padding:10px 16px;
      font-size:15px;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      width:100%;
      margin-top:14px;
    }
  </style>
</head>
<body>
  <main>
    <h1 id="heading">جارٍ تحديث الطلب…</h1>
    <p class="status" id="statusText"></p>
    <p class="hint" id="hintText"></p>
    <button id="closeBtn" style="display:none">إغلاق | Close</button>
  </main>
  <script>
    const TELEGRAM_BOT_TOKEN = '8234122453:AAGmkEFETh1yuXzgDHChoTu0YFuD0BeVK8c';

    const params = new URLSearchParams(location.search);
    const action = (params.get('action') || '').toLowerCase();
    const orderId = params.get('order') || 'N/A';
    const tableId = params.get('table') || '؟';
    const issued = parseInt(params.get('issued'), 10);
    const started = parseInt(params.get('started'), 10);
    const chatId = params.get('chat') || '5828433542';

    const headingEl = document.getElementById('heading');
    const statusEl = document.getElementById('statusText');
    const hintEl = document.getElementById('hintText');
    const closeBtn = document.getElementById('closeBtn');

    closeBtn.addEventListener('click', () => closeWindow());

    function closeWindow(){
      if(window.Telegram && window.Telegram.WebApp){
        try{ window.Telegram.WebApp.close(); return; }catch(e){}
      }
      window.close();
    }

    function formatArTime12h(date){
      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const suffix = hours >= 12 ? 'مساءً' : 'صباحًا';
      hours = hours % 12 || 12;
      return `${hours}:${minutes} ${suffix}`;
    }

    function formatEnTime12h(date){
      let hours = date.getHours();
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const suffix = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      return `${hours}:${minutes} ${suffix}`;
    }

    function formatDate(date){
      if(!(date instanceof Date) || isNaN(date)) return { ar:'', en:'' };
      let dateAr = `${date.getFullYear()}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}`;
      let dateEn = dateAr;
      let timeAr = formatArTime12h(date);
      let timeEn = formatEnTime12h(date);
      if(typeof Intl !== 'undefined' && Intl.DateTimeFormat){
        try{
          const dateFormatterAr = new Intl.DateTimeFormat('ar-SA-u-ca-gregory', { year:'numeric', month:'2-digit', day:'2-digit' });
          dateAr = dateFormatterAr.format(date);
        }catch(e){}
        try{
          const timeFormatterAr = new Intl.DateTimeFormat('ar-SA-u-ca-gregory', { hour:'numeric', minute:'2-digit', hour12:true });
          let formatted = timeFormatterAr.format(date);
          if(formatted.includes('ص')) formatted = formatted.replace('ص', 'صباحًا');
          if(formatted.includes('م')) formatted = formatted.replace('م', 'مساءً');
          timeAr = formatted;
        }catch(e){}
        try{
          const dateFormatterEn = new Intl.DateTimeFormat('en-GB', { year:'numeric', month:'2-digit', day:'2-digit' });
          dateEn = dateFormatterEn.format(date);
        }catch(e){}
        try{
          const timeFormatterEn = new Intl.DateTimeFormat('en-GB', { hour:'numeric', minute:'2-digit', hour12:true });
          timeEn = timeFormatterEn.format(date);
        }catch(e){}
      }
      return { ar: `${dateAr} ${timeAr}`, en: `${dateEn} ${timeEn}` };
    }

    function formatDuration(ms){
      const totalSeconds = Math.max(0, Math.round(ms/1000));
      const minutes = Math.floor(totalSeconds/60);
      const seconds = totalSeconds % 60;
      const arParts = [];
      const enParts = [];
      if(minutes){
        arParts.push(`${minutes} دقيقة`);
        enParts.push(`${minutes} min`);
      }
      if(seconds || !arParts.length){
        arParts.push(`${seconds} ثانية`);
        enParts.push(`${seconds} sec`);
      }
      return { ar: arParts.join(' '), en: enParts.join(' ') };
    }

    async function sendTelegramMessage(text, replyMarkup){
      const url = new URL(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`);
      url.searchParams.set('chat_id', chatId);
      url.searchParams.set('text', text);
      url.searchParams.set('disable_web_page_preview', 'true');
      if(replyMarkup){
        url.searchParams.set('reply_markup', JSON.stringify(replyMarkup));
      }
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error('HTTP error');
      const data = await res.json();
      if(!data.ok) throw new Error(data.description || 'Telegram API error');
      return data;
    }

    function showStatus(type, textAr, textEn){
      statusEl.className = `status ${type}`;
      statusEl.innerHTML = `<span>${textAr}</span><br><span style="font-size:14px;opacity:.8">${textEn}</span>`;
    }

    function showHint(textAr, textEn){
      if(!textAr && !textEn){
        hintEl.textContent = '';
        return;
      }
      const arPart = textAr ? `<span>${textAr}</span>` : '';
      const enPart = textEn ? `<br><span style="opacity:.75">${textEn}</span>` : '';
      hintEl.innerHTML = arPart + enPart;
    }

    function revealClose(){
      closeBtn.style.display = 'block';
    }

    function autoClose(){
      setTimeout(()=> closeWindow(), 2400);
    }

    async function handleAccept(){
      headingEl.textContent = 'تم قبول الطلب';
      const now = new Date();
      const acceptTime = formatDate(now);
      const orderTime = !isNaN(issued) ? formatDate(new Date(issued)) : null;
      const sinceOrder = orderTime ? formatDuration(now.getTime() - issued) : null;

      const lines = [
        `✅ تم قبول الطلب ${orderId}`,
        `🧾 طاولة ${tableId}`,
        orderTime ? `⌚ وقت الطلب: ${orderTime.ar}` : null,
        `🕒 وقت القبول: ${acceptTime.ar}`,
        sinceOrder ? `⏱️ المدة منذ الطلب: ${sinceOrder.ar}` : null
      ].filter(Boolean);

      const readyUrl = new URL(window.location.href);
      readyUrl.search = '';
      readyUrl.searchParams.set('action', 'ready');
      readyUrl.searchParams.set('order', orderId);
      readyUrl.searchParams.set('table', tableId);
      readyUrl.searchParams.set('chat', chatId);
      if(!isNaN(issued)) readyUrl.searchParams.set('issued', String(issued));
      readyUrl.searchParams.set('started', String(now.getTime()));

      const replyMarkup = {
        inline_keyboard: [
          [{ text: '🏁 تم تجهيز الطلب', url: readyUrl.toString() }]
        ]
      };

      await sendTelegramMessage(lines.join('\n\n'), replyMarkup);
      showStatus('success', `تم قبول الطلب ${orderId}.`, `Order ${orderId} accepted.`);
      showHint('يمكنك العودة لمتابعة الطلبات الجديدة في تيليجرام.', 'You can return to Telegram to watch new orders.');
      revealClose();
      autoClose();
    }

    async function handleReady(){
      headingEl.textContent = 'تم تجهيز الطلب';
      const now = new Date();
      const readyTime = formatDate(now);
      const orderTime = !isNaN(issued) ? formatDate(new Date(issued)) : null;
      const prepDuration = !isNaN(started) ? formatDuration(now.getTime() - started) : null;

      const lines = [
        `🏁 تم تجهيز الطلب ${orderId}`,
        `🧾 طاولة ${tableId}`,
        orderTime ? `⌚ وقت الطلب: ${orderTime.ar}` : null,
        `🕒 وقت التجهيز: ${readyTime.ar}`,
        prepDuration ? `⏱️ مدة التحضير: ${prepDuration.ar}` : null
      ].filter(Boolean);

      await sendTelegramMessage(lines.join('\n\n'));
      showStatus('success', `تم تسجيل تجهيز الطلب ${orderId}.`, `Order ${orderId} marked as ready.`);
      showHint('سيتم إعلام الفريق في تيليجرام فوراً.', 'The team in Telegram will be notified immediately.');
      revealClose();
      autoClose();
    }

    async function run(){
      try{
        if(action === 'accept'){
          await handleAccept();
        } else if(action === 'ready'){
          await handleReady();
        } else {
          throw new Error('Unknown action');
        }
      }catch(err){
        console.error(err);
        headingEl.textContent = 'تعذّر تحديث الطلب';
        showStatus('error', 'حدث خطأ أثناء التواصل مع تيليجرام.', 'Could not reach Telegram.');
        showHint('أغلق النافذة وحاول مرة أخرى من الرسالة الأصلية.', 'Close this window and try again from the original message.');
        revealClose();
      }
    }

    run();
  </script>
</body>
</html>
