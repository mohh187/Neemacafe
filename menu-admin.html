<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم – منيو نيمة</title>
  <style>
    :root{
      --brand:#8b5e3c; --brand-2:#d4a373; --brand-dark:#70492d;
      --bg:#f8f6f3; --card:#ffffff; --text:#1f1f1f; --muted:#6b6b6b; --border:#e0d8cf;
      --radius:16px; --shadow:0 8px 20px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.92);
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);
      box-shadow:0 6px 16px rgba(0,0,0,.04);
    }
    .wrap{max-width:1080px;margin-inline:auto;padding:18px 20px;display:flex;flex-wrap:wrap;align-items:center;gap:14px;justify-content:space-between;}
    h1{margin:0;font-size:24px;display:flex;align-items:center;gap:10px;}
    h1 span{font-size:16px;font-weight:400;color:var(--muted);}
    .actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;align-items:center;}
    button, label.buttonlike{
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      font-size:14px;
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    button.primary{background:var(--brand);border-color:var(--brand-dark);color:#fff;}
    button.danger{background:#d6336c;color:#fff;border-color:#c2255c;}
    button.soft{background:#f4ede6;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    button:hover:not(:disabled){box-shadow:0 6px 18px rgba(0,0,0,.1);transform:translateY(-1px);}
    main{max-width:1080px;margin:20px auto 120px;padding:0 20px;display:grid;grid-template-columns:1fr 320px;gap:20px;}
    @media(max-width:1024px){main{grid-template-columns:1fr;}}
    .editor{display:flex;flex-direction:column;gap:18px;}
    .category{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .category-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;}
    .category-header h2{margin:0;font-size:18px;display:flex;align-items:center;gap:10px;}
    .group{border-top:1px solid var(--border);}
    .group summary{list-style:none;padding:16px 20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:12px;font-weight:600;}
    .group summary::marker{display:none;}
    .group[open]{background:rgba(139,94,60,.05);}
    .group-content{padding:0 20px 20px;display:flex;flex-direction:column;gap:16px;}
    .empty-state{border:1px dashed var(--border);border-radius:14px;padding:18px;text-align:center;color:var(--muted);}
    .item-card{border:1px solid var(--border);border-radius:14px;background:#fff;padding:16px;display:flex;flex-direction:column;gap:14px;box-shadow:0 4px 14px rgba(0,0,0,.04);}
    .item-header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .item-header .name{font-weight:700;font-size:15px;display:flex;align-items:center;gap:8px;}
    .item-header small{color:var(--muted);font-weight:400;}
    .item-actions{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .item-actions button{padding:6px 8px;font-size:13px;border-radius:10px;}
    .item-actions button.icon{width:32px;height:32px;justify-content:center;padding:0;}
    .fields{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
    .field{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--muted);}
    .field input,.field textarea,.field select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:14px;}
    .field textarea{min-height:70px;resize:vertical;}
    .muted{color:var(--muted);font-size:13px;line-height:1.7;}
    .hint-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:14px;}
    .hint-card h3{margin:0;font-size:18px;}
    .hint-card ul{margin:0;padding:0 18px;display:flex;flex-direction:column;gap:8px;}
    .hint-card li{line-height:1.6;}
    .status-bar{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#1f1f1f;color:#fff;padding:10px 18px;border-radius:999px;font-size:13px;box-shadow:0 10px 26px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .3s ease;}
    .status-bar.show{opacity:1;}
    .variants{border-top:1px dashed var(--border);padding-top:12px;display:flex;flex-direction:column;gap:12px;}
    .variants h4{margin:0;font-size:14px;display:flex;align-items:center;gap:8px;}
    .variant-card{border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;background:rgba(139,94,60,.04);} 
    .variant-card .variant-header{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .variant-card .variant-header strong{font-size:14px;}
    .variant-card .variant-fields{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;}
    .badge{display:inline-flex;align-items:center;gap:6px;background:rgba(139,94,60,.15);color:var(--brand-dark);padding:4px 8px;border-radius:999px;font-size:12px;}
    .category-extra-note{padding:16px 20px;color:#9c6644;font-size:13px;border-top:1px dashed rgba(139,94,60,.35);background:rgba(139,94,60,.08);}
    input[type="file"]{display:none;}
    .import-label{cursor:pointer;}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>لوحة التحكم <span>إدارة أصناف المنيو</span></h1>
      <div class="actions">
        <button class="soft" id="copyJson">📋 نسخ JSON</button>
        <label for="importFile" class="buttonlike soft import-label">📥 استيراد JSON</label>
        <input type="file" id="importFile" accept="application/json" />
        <button class="primary" id="exportJson">💾 تحميل ملف</button>
        <button class="primary" id="saveBtn">✅ حفظ التعديلات</button>
        <button class="danger" id="resetBtn">⟳ إعادة للوضع الأساسي</button>
      </div>
    </div>
  </header>

  <main>
    <div class="editor" id="editor"></div>
    <aside class="hint-card">
      <h3>كيف تعمل اللوحة؟</h3>
      <p class="muted">تتيح لك هذه الصفحة تحديث جميع بيانات الأصناف المستخدمة في المنيو الرئيسي. يتم حفظ التعديلات في المتصفح نفسه ويمكن تصديرها كملف JSON لمشاركتها أو دمجها في الكود.</p>
      <ul>
        <li>كل قسم (ساخن، بارد، حلا) يحتوي على مجموعات أصناف. يمكنك إضافة أو حذف العناصر داخل كل مجموعة.</li>
        <li>احفظ التعديلات لتُخزَّن محليًا. عند فتح المنيو العادي سيقرأ البيانات المحدثة تلقائيًا.</li>
        <li>استخدم زر «تحميل ملف» لتنزيل نسخة من البيانات، أو «استيراد» لتحميل ملف JSON سبق تصديره.</li>
        <li>إعادة التعيين تمسح التعديلات المحلية وتعيد بيانات `menu-data.js` الأصلية.</li>
      </ul>
      <div class="badge">📌 ملاحظة</div>
      <p class="muted">في حال أضفت مجموعة جديدة بالكامل ستحتاج إلى تحديث صفحة المنيو نفسها لعرضها. المجموعات الحالية مهيأة مسبقًا: قهوة وشاي ساخن، قهوة وموهيتو ومشروبات باردة، كيك وحلا جانبي.</p>
    </aside>
  </main>

  <div class="status-bar" id="statusBar"></div>

  <script src="menu-data.js"></script>
  <script>
    const STORAGE_KEY = 'neema.menuData.custom';
    const SHARED = window.NEEMA_SHARED || {};
    const IMG_DEFAULT = SHARED.IMG_DEFAULT || 'https://i.postimg.cc/Y0GT5M1f/image.png';
    const DEFAULT_DATA = (()=>{
      try{
        return JSON.parse(JSON.stringify(SHARED.MENU_DATA || {}));
      }catch(e){
        console.warn('تعذر نسخ البيانات الافتراضية', e);
        return {};
      }
    })();

    const MENU_STRUCTURE = [
      {
        key:'hot',
        icon:'🔥',
        label:'المشروبات الساخنة',
        groups:[
          { key:'coffee', label:'قهوة ساخنة' },
          { key:'tea', label:'شاي ومشروبات' }
        ]
      },
      {
        key:'cold',
        icon:'❄️',
        label:'المشروبات الباردة',
        groups:[
          { key:'coffee', label:'قهوة باردة' },
          { key:'mojito', label:'موهيتو ومنكهات' },
          { key:'other', label:'مشروبات إضافية' }
        ]
      },
      {
        key:'dessert',
        icon:'🍰',
        label:'الحلا',
        groups:[
          { key:'cake', label:'كيك وحلويات' },
          { key:'side', label:'أطباق جانبية' }
        ]
      }
    ];

    function clone(obj){
      return JSON.parse(JSON.stringify(obj));
    }

    function loadData(){
      try{
        const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
        if(stored && typeof stored === 'object'){ return stored; }
      }catch(e){
        console.warn('تعذر قراءة البيانات المحفوظة', e);
      }
      return clone(DEFAULT_DATA);
    }

    let data = loadData();
    const statusBar = document.getElementById('statusBar');
    const editor = document.getElementById('editor');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportJson');
    const copyBtn = document.getElementById('copyJson');
    const importInput = document.getElementById('importFile');

    function showStatus(message, variant='default'){
      if(!statusBar) return;
      statusBar.textContent = message;
      statusBar.style.background = variant==='error' ? '#b02a37' : '#1f1f1f';
      statusBar.classList.add('show');
      clearTimeout(showStatus._timer);
      showStatus._timer = setTimeout(()=> statusBar.classList.remove('show'), 2800);
    }

    function scheduleSave(){
      clearTimeout(scheduleSave._timer);
      scheduleSave._timer = setTimeout(()=> saveData(), 400);
    }

    function saveData(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        showStatus('تم حفظ التعديلات بنجاح ✅');
      }catch(e){
        console.error('تعذر حفظ البيانات', e);
        showStatus('تعذر حفظ البيانات في المتصفح', 'error');
      }
    }

    function resetData(){
      if(!window.confirm('سيتم حذف جميع التعديلات المحلية وإعادة البيانات الأصلية. هل أنت متأكد؟')) return;
      data = clone(DEFAULT_DATA);
      saveData();
      render();
    }

    function createEmptyItem(){
      return { ar:'صنف جديد', en:'New Item', price:0, cal:0, img:IMG_DEFAULT };
    }

    function createEmptyVariant(){
      return { key:'option', ar:'خيار', en:'Option', price:0, cal:0 };
    }

    function ensureStructure(){
      MENU_STRUCTURE.forEach(cat=>{
        if(!data[cat.key] || typeof data[cat.key] !== 'object'){ data[cat.key] = {}; }
        cat.groups.forEach(group=>{
          if(!Array.isArray(data[cat.key][group.key])) data[cat.key][group.key] = [];
        });
      });
    }

    function updateField(obj, key, value, { number=false, allowEmpty=false }={}){
      if(number){
        const num = Number(value);
        if(Number.isFinite(num)){
          obj[key] = num;
        }else if(allowEmpty){
          delete obj[key];
        }
        return;
      }
      const trimmed = typeof value === 'string' ? value.trim() : value;
      if(trimmed || allowEmpty){
        obj[key] = trimmed;
      }else{
        delete obj[key];
      }
    }

    function moveItem(catKey, groupKey, index, direction){
      const list = data?.[catKey]?.[groupKey];
      if(!Array.isArray(list)) return;
      const newIndex = index + direction;
      if(newIndex < 0 || newIndex >= list.length) return;
      const [item] = list.splice(index, 1);
      list.splice(newIndex, 0, item);
      render();
      scheduleSave();
    }

    function removeItem(catKey, groupKey, index){
      const list = data?.[catKey]?.[groupKey];
      if(!Array.isArray(list)) return;
      if(!window.confirm('سيتم حذف هذا الصنف. هل تريد المتابعة؟')) return;
      list.splice(index, 1);
      render();
      scheduleSave();
    }

    function duplicateItem(catKey, groupKey, index){
      const list = data?.[catKey]?.[groupKey];
      if(!Array.isArray(list)) return;
      const copy = clone(list[index] || {});
      copy.ar = (copy.ar || '') + ' (نسخة)';
      copy.en = (copy.en || '') + ' (copy)';
      list.splice(index + 1, 0, copy);
      render();
      scheduleSave();
    }

    function addItem(catKey, groupKey){
      if(!data[catKey] || !Array.isArray(data[catKey][groupKey])) data[catKey][groupKey] = [];
      data[catKey][groupKey].push(createEmptyItem());
      render();
      scheduleSave();
    }

    function addVariant(item){
      if(!Array.isArray(item.variants)) item.variants = [];
      const baseKey = 'option-' + (item.variants.length + 1);
      const variant = Object.assign(createEmptyVariant(), { key: baseKey });
      item.variants.push(variant);
      if(!item.defaultVariantKey) item.defaultVariantKey = variant.key;
      render();
      scheduleSave();
    }

    function removeVariant(item, index){
      if(!Array.isArray(item.variants)) return;
      if(item.variants.length <= index) return;
      item.variants.splice(index, 1);
      if(item.variants.length === 0){
        delete item.variants;
        delete item.defaultVariantKey;
      }else if(item.defaultVariantKey && !item.variants.find(v=>v.key===item.defaultVariantKey)){
        item.defaultVariantKey = item.variants[0].key;
      }
      render();
      scheduleSave();
    }

    function createField(label, value, options){
      const wrap = document.createElement('label');
      wrap.className = 'field';
      wrap.innerHTML = `<span>${label}</span>`;
      const input = document.createElement(options && options.type === 'textarea' ? 'textarea' : 'input');
      if(options && options.type && options.type !== 'textarea'){ input.type = options.type; }
      if(options && options.placeholder) input.placeholder = options.placeholder;
      if(value !== undefined && value !== null){ input.value = value; }
      if(options && options.dir){ input.dir = options.dir; }
      if(options && options.step){ input.step = options.step; }
      input.addEventListener('input', (event)=>{
        if(options && typeof options.onInput === 'function'){
          options.onInput(event.target.value);
        }
      });
      wrap.appendChild(input);
      return { wrap, input };
    }

    function renderVariant(item, variant, index){
      const card = document.createElement('div');
      card.className = 'variant-card';
      const header = document.createElement('div');
      header.className = 'variant-header';
      const title = document.createElement('strong');
      title.textContent = variant.ar || variant.en || `خيار ${index+1}`;
      const removeBtn = document.createElement('button');
      removeBtn.className = 'danger';
      removeBtn.textContent = 'حذف';
      removeBtn.addEventListener('click', ()=> removeVariant(item, index));
      header.appendChild(title);
      header.appendChild(removeBtn);
      card.appendChild(header);

      const fields = document.createElement('div');
      fields.className = 'variant-fields';

      const keyField = createField('المعرف (key)', variant.key || '', {
        onInput:(val)=>{ updateField(variant, 'key', val, { allowEmpty:true }); scheduleSave(); }
      });
      fields.appendChild(keyField.wrap);

      const arField = createField('الاسم (عربي)', variant.ar || '', {
        onInput:(val)=>{ updateField(variant, 'ar', val, { allowEmpty:true }); scheduleSave(); }
      });
      arField.input.dir = 'rtl';
      fields.appendChild(arField.wrap);

      const enField = createField('الاسم (إنجليزي)', variant.en || '', {
        onInput:(val)=>{ updateField(variant, 'en', val, { allowEmpty:true }); scheduleSave(); }
      });
      enField.input.dir = 'ltr';
      fields.appendChild(enField.wrap);

      const priceField = createField('السعر', variant.price ?? '', {
        type:'number', step:'0.5',
        onInput:(val)=>{ updateField(variant, 'price', val, { number:true, allowEmpty:true }); scheduleSave(); }
      });
      fields.appendChild(priceField.wrap);

      const calField = createField('السعرات', variant.cal ?? '', {
        type:'number', step:'1',
        onInput:(val)=>{ updateField(variant, 'cal', val, { number:true, allowEmpty:true }); scheduleSave(); }
      });
      fields.appendChild(calField.wrap);

      const imgField = createField('صورة خاصة', variant.img || '', {
        placeholder:'رابط صورة اختياري',
        onInput:(val)=>{ updateField(variant, 'img', val, { allowEmpty:true }); scheduleSave(); }
      });
      fields.appendChild(imgField.wrap);

      card.appendChild(fields);
      return card;
    }

    function renderItem(catKey, groupKey, item, index){
      const card = document.createElement('div');
      card.className = 'item-card';
      const header = document.createElement('div');
      header.className = 'item-header';
      const title = document.createElement('div');
      title.className = 'name';
      title.innerHTML = `<span>${item.ar || item.en || '—'}</span><small>#${index+1}</small>`;
      header.appendChild(title);

      const actions = document.createElement('div');
      actions.className = 'item-actions';

      const upBtn = document.createElement('button');
      upBtn.className = 'icon';
      upBtn.textContent = '↑';
      upBtn.title = 'تحريك لأعلى';
      upBtn.disabled = index === 0;
      upBtn.addEventListener('click', ()=> moveItem(catKey, groupKey, index, -1));
      actions.appendChild(upBtn);

      const downBtn = document.createElement('button');
      downBtn.className = 'icon';
      downBtn.textContent = '↓';
      downBtn.title = 'تحريك لأسفل';
      downBtn.disabled = index === (data?.[catKey]?.[groupKey]?.length || 0) - 1;
      downBtn.addEventListener('click', ()=> moveItem(catKey, groupKey, index, 1));
      actions.appendChild(downBtn);

      const duplicateBtn = document.createElement('button');
      duplicateBtn.textContent = 'استنساخ';
      duplicateBtn.addEventListener('click', ()=> duplicateItem(catKey, groupKey, index));
      actions.appendChild(duplicateBtn);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'danger';
      removeBtn.textContent = 'حذف';
      removeBtn.addEventListener('click', ()=> removeItem(catKey, groupKey, index));
      actions.appendChild(removeBtn);

      header.appendChild(actions);
      card.appendChild(header);

      const fields = document.createElement('div');
      fields.className = 'fields';

      const arField = createField('الاسم (عربي)', item.ar || '', {
        placeholder:'مثال: لاتيه',
        onInput:(val)=>{ updateField(item, 'ar', val, { allowEmpty:true }); title.querySelector('span').textContent = val || item.en || '—'; scheduleSave(); }
      });
      arField.input.dir = 'rtl';
      fields.appendChild(arField.wrap);

      const enField = createField('الاسم (إنجليزي)', item.en || '', {
        placeholder:'Example: Latte',
        onInput:(val)=>{ updateField(item, 'en', val, { allowEmpty:true }); if(!(arField.input.value || '').trim()){ title.querySelector('span').textContent = val || '—'; } scheduleSave(); }
      });
      enField.input.dir = 'ltr';
      fields.appendChild(enField.wrap);

      const priceField = createField('السعر (ريال)', item.price ?? '', {
        type:'number', step:'0.5',
        onInput:(val)=>{ updateField(item, 'price', val, { number:true, allowEmpty:true }); scheduleSave(); }
      });
      fields.appendChild(priceField.wrap);

      const calField = createField('السعرات الحرارية', item.cal ?? '', {
        type:'number', step:'1',
        onInput:(val)=>{ updateField(item, 'cal', val, { number:true, allowEmpty:true }); scheduleSave(); }
      });
      fields.appendChild(calField.wrap);

      const imgField = createField('رابط الصورة', item.img || '', {
        placeholder:'https://',
        onInput:(val)=>{ updateField(item, 'img', val, { allowEmpty:true }); scheduleSave(); }
      });
      fields.appendChild(imgField.wrap);

      const descArField = createField('وصف مختصر (عربي)', item.desc_ar || '', {
        type:'textarea',
        placeholder:'نص اختياري يظهر تحت الاسم',
        onInput:(val)=>{ updateField(item, 'desc_ar', val, { allowEmpty:true }); scheduleSave(); }
      });
      descArField.input.dir = 'rtl';
      fields.appendChild(descArField.wrap);

      const descEnField = createField('وصف مختصر (إنجليزي)', item.desc_en || '', {
        type:'textarea',
        placeholder:'Optional description shown under the name',
        onInput:(val)=>{ updateField(item, 'desc_en', val, { allowEmpty:true }); scheduleSave(); }
      });
      descEnField.input.dir = 'ltr';
      fields.appendChild(descEnField.wrap);

      card.appendChild(fields);

      const variantContainer = document.createElement('div');
      variantContainer.className = 'variants';
      const variantHeader = document.createElement('div');
      variantHeader.style.display = 'flex';
      variantHeader.style.alignItems = 'center';
      variantHeader.style.justifyContent = 'space-between';
      const variantTitle = document.createElement('h4');
      variantTitle.textContent = 'خيارات / إضافات';
      const addVariantBtn = document.createElement('button');
      addVariantBtn.textContent = '➕ إضافة خيار';
      addVariantBtn.addEventListener('click', ()=> addVariant(item));
      variantHeader.appendChild(variantTitle);
      variantHeader.appendChild(addVariantBtn);
      variantContainer.appendChild(variantHeader);

      if(Array.isArray(item.variants) && item.variants.length){
        const select = document.createElement('select');
        select.appendChild(new Option('— بدون تحديد —', ''));
        item.variants.forEach(v=>{
          select.appendChild(new Option(v.key || '(بدون معرف)', v.key || ''));
        });
        select.value = item.defaultVariantKey || '';
        select.addEventListener('change', ()=>{
          updateField(item, 'defaultVariantKey', select.value, { allowEmpty:true });
          scheduleSave();
        });
        const selectFieldWrap = document.createElement('label');
        selectFieldWrap.className = 'field';
        selectFieldWrap.innerHTML = '<span>الخيار الافتراضي</span>';
        selectFieldWrap.appendChild(select);
        variantContainer.appendChild(selectFieldWrap);

        item.variants.forEach((variant, idx)=>{
          variantContainer.appendChild(renderVariant(item, variant, idx));
        });
      }else{
        const hint = document.createElement('p');
        hint.className = 'muted';
        hint.textContent = 'لا توجد خيارات إضافية. أضف خيارًا إذا كان المشروب يسمح باختيار نكهة أو حجم.';
        variantContainer.appendChild(hint);
      }

      card.appendChild(variantContainer);
      return card;
    }

    function renderGroup(catKey, group){
      const detailsEl = document.createElement('details');
      detailsEl.className = 'group';
      detailsEl.open = true;
      const summary = document.createElement('summary');
      summary.innerHTML = `${group.icon || '•'} <span>${group.label}</span>`;
      const addBtn = document.createElement('button');
      addBtn.textContent = '➕ إضافة صنف';
      addBtn.addEventListener('click', (event)=>{ event.preventDefault(); event.stopPropagation(); addItem(catKey, group.key); });
      summary.appendChild(addBtn);
      detailsEl.appendChild(summary);

      const content = document.createElement('div');
      content.className = 'group-content';
      const list = Array.isArray(data?.[catKey]?.[group.key]) ? data[catKey][group.key] : [];
      if(list.length === 0){
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = 'لا توجد أصناف بعد. أضف صنفًا جديدًا أو استورد من ملف.';
        content.appendChild(empty);
      }else{
        list.forEach((item, idx)=>{
          content.appendChild(renderItem(catKey, group.key, item, idx));
        });
      }
      detailsEl.appendChild(content);
      return detailsEl;
    }

    function render(){
      ensureStructure();
      editor.innerHTML = '';
      MENU_STRUCTURE.forEach(cat=>{
        const section = document.createElement('section');
        section.className = 'category';
        const header = document.createElement('div');
        header.className = 'category-header';
        const title = document.createElement('h2');
        title.textContent = `${cat.icon} ${cat.label}`;
        header.appendChild(title);
        const addBtn = document.createElement('button');
        addBtn.textContent = '➕ إضافة صنف';
        addBtn.addEventListener('click', ()=> addItem(cat.key, cat.groups[0]?.key || 'items'));
        header.appendChild(addBtn);
        section.appendChild(header);

        const groupsWrap = document.createElement('div');
        cat.groups.forEach(groupInfo=>{
          const group = Object.assign({ icon:'•' }, groupInfo);
          groupsWrap.appendChild(renderGroup(cat.key, group));
        });

        const extraGroups = Object.keys(data?.[cat.key] || {}).filter(k=> !cat.groups.find(g=> g.key===k));
        if(extraGroups.length){
          const note = document.createElement('div');
          note.className = 'category-extra-note';
          note.innerHTML = `هناك مجموعات إضافية (${extraGroups.join(', ')}) غير معروضة في هذه اللوحة. سيحتاج عرضها إلى تعديل صفحة المنيو.`;
          groupsWrap.appendChild(note);
        }

        section.appendChild(groupsWrap);
        editor.appendChild(section);
      });
    }

    function exportJson(){
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'neema-menu-data.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      showStatus('تم تنزيل الملف 💾');
    }

    async function copyJson(){
      try{
        await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        showStatus('تم نسخ البيانات إلى الحافظة 📋');
      }catch(e){
        console.warn('تعذر النسخ إلى الحافظة', e);
        showStatus('تعذر نسخ البيانات تلقائيًا', 'error');
      }
    }

    function handleImport(event){
      const file = event.target.files && event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const imported = JSON.parse(reader.result);
          if(!imported || typeof imported !== 'object') throw new Error('صيغة غير صحيحة');
          data = imported;
          saveData();
          render();
          showStatus('تم استيراد البيانات بنجاح 📥');
        }catch(err){
          console.error('تعذر استيراد الملف', err);
          showStatus('تعذر قراءة ملف JSON المحدد', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    saveBtn.addEventListener('click', ()=> saveData());
    resetBtn.addEventListener('click', ()=> resetData());
    exportBtn.addEventListener('click', ()=> exportJson());
    copyBtn.addEventListener('click', ()=> copyJson());
    importInput.addEventListener('change', handleImport);

    render();
  </script>
</body>
</html>
