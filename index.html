<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>منيو نيمة | Neema Menu</title>
  <style>
/* Theme */
:root{
  --brand:#8b5e3c; --brand-2:#d4a373; --brand-dark:#70492d;
  --bg:#faf8f6; --card:#ffffff; --text:#1f1f1f; --muted:#6b6b6b; --border:#e9e6e3;
  --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.08);
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text);}
body.dark{ --bg:#0f0f0f; --card:#1a1a1a; --text:#f3f3f3; --muted:#b7b7b7; --border:#2a2a2a; }

/* Header */
header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
body.dark header{background:rgba(20,20,20,.82)}
.wrap{max-width:960px;margin-inline:auto;padding:12px 14px}
.top{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px;flex:1 1 auto;min-width:220px}
.brand-text{display:flex;flex-direction:column;gap:4px;min-width:0;align-items:flex-start}
.brand img{width:48px;height:48px;border-radius:12px;border:1px solid var(--border);background:#fff;object-fit:contain}
.brand h1{font-size:18px;margin:0;line-height:1.2}

.header-side{display:flex;flex-direction:column;gap:10px;align-items:flex-end;flex:1 1 auto;min-width:260px}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;font-size:14px;cursor:pointer}
.btn.small{padding:6px 8px;font-size:12px}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.ghost{background:transparent}
.greeting{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;text-align:right;width:100%}
.greeting span{font-size:13px;color:var(--muted)}
.greeting .welcome-name{font-weight:700;color:var(--brand)}

@media(max-width:680px){
  .top{flex-direction:column;align-items:stretch;gap:14px}
  .brand{justify-content:center;text-align:center}
  .brand-text{align-items:center}
  .header-side{align-items:stretch;gap:12px;min-width:0}
  .greeting{justify-content:space-between;text-align:inherit}
  .actions{justify-content:space-between}
  .actions .btn{flex:1 1 0;min-width:110px}
}

/* Search */
.search{display:flex;gap:8px;margin:10px 0 8px}
.search input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:15px}

/* Sections */
main{max-width:960px;margin-inline:auto;padding:10px 14px 120px}
details{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin:10px 0}
summary{list-style:none;padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;font-weight:700}
summary::marker{display:none}
.pill{display:inline-block;background:#efe6de;color:#5a3a22;border-radius:999px;padding:3px 8px;font-size:12px;margin-inline-start:6px}
body.dark .pill{background:#2b221b;color:#d9c3ad}

.grid{display:grid;grid-template-columns:1fr;gap:10px;padding:8px 12px 14px}
@media(min-width:520px){.grid{grid-template-columns:repeat(2,1fr)}}

.item{display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;cursor:pointer}
.item:hover{box-shadow:0 6px 18px rgba(0,0,0,.06)}
.thumb{width:72px;height:72px;border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#fafafa}
.thumb img{width:100%;height:100%;object-fit:contain;background:#fafafa}
.line{display:flex;align-items:center;gap:8px}
.name{font-weight:700}
.dots{flex:1 1 auto;border-bottom:1px dotted #c9c3bd;transform:translateY(-4px);opacity:.6}
.price{font-weight:800;color:var(--brand)}
.sub{font-size:12px;color:var(--muted)}
.cals{font-size:12px;color:#888;margin-top:2px}

/* SAR symbol (SVG mask) */
.price .sar {
  display:inline-block; width:1.05em; height:1em; margin-inline-start:.25em;
  background-color: currentColor;
  -webkit-mask: url("https://upload.wikimedia.org/wikipedia/commons/9/98/Saudi_Riyal_Symbol.svg") no-repeat center / contain;
  mask: url("https://upload.wikimedia.org/wikipedia/commons/9/98/Saudi_Riyal_Symbol.svg") no-repeat center / contain;
  vertical-align:-0.1em;
}
.price .sar-fallback{display:none;}
@supports not (mask: url("")) {
  .price .sar{display:none;}
  .price .sar-fallback{display:inline; font-weight:700; margin-inline-start:.25em;}
}

/* Bottom bar */
.bar{position:fixed;bottom:0;left:0;right:0;z-index:25;background:var(--card);border-top:1px solid var(--border);padding:10px}
.bar .inner{max-width:960px;margin-inline:auto;display:flex;gap:8px}
select, .bar .inner .btn{flex:1}

footer{color:var(--muted);text-align:center;margin:18px 0 120px}

/* -------- Product Modal -------- */
.modal, .cart{position:fixed;inset:0;display:none;z-index:300;align-items:flex-end;justify-content:center}
.modal .backdrop, .cart .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
.sheet{
  position:relative;background:var(--card);color:var(--text);
  width:100%;max-width:560px;max-height:88vh;overflow:auto;
  border-top-left-radius:18px;border-top-right-radius:18px;
  box-shadow:var(--shadow);padding:14px
}
.sheet .row{display:flex;gap:12px}
.sheet .bigimg{width:120px;height:120px;border-radius:14px;border:1px solid var(--border);overflow:hidden;background:#fafafa;flex:0 0 auto}
.sheet .bigimg img{width:100%;height:100%;object-fit:contain}
.sheet h3{margin:6px 0 4px}
.sheet .desc{color:var(--muted);font-size:14px;line-height:1.6}
.qty{display:flex;align-items:center;gap:10px;margin-top:8px}
.qty button{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer}
.sheet .line{margin-top:6px}
.sheet .actions{display:flex;gap:8px;margin-top:12px}
.sheet .actions .btn{flex:1}

/* Customization section */
.custom{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
.custom h4{margin:0 0 8px;font-size:14px;color:var(--muted)}
.custom .opts{display:flex;flex-wrap:wrap;gap:8px}
.custom label{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:var(--card);cursor:pointer;font-size:13px}
.custom .radios{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

/* -------- Floating Cart Button -------- */
.fab{
  position:fixed; right:16px; bottom:86px; z-index:260;
  background:var(--brand); color:#fff; border:none; border-radius:999px;
  padding:12px 16px; box-shadow:0 10px 24px rgba(0,0,0,.18); cursor:pointer; display:flex; align-items:center; gap:8px
}
.fab .count{background:#fff;color:var(--brand);border-radius:999px;padding:2px 8px;font-weight:800}

/* -------- Cart Sheet -------- */
.cart .sheet h3{margin:0 0 10px}
.cart-item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:8px;margin:6px 0}
.cart-item .thumb{width:56px;height:56px;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.cart-item .thumb img{width:100%;height:100%;object-fit:cover}
.cart-item .title{font-weight:700}
.cart-item .meta{font-size:12px;color:var(--muted)}
.cart-item .qty{justify-content:flex-end}
.cart .summary{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-weight:800}
.cart .loyalty-summary{margin-top:6px;font-size:13px;color:var(--brand);font-weight:600}
.cart .actions{display:flex;gap:8px;margin-top:12px}
.cart .discount{display:flex;flex-direction:column;gap:6px;margin-top:12px}
.cart .discount label{font-size:13px;color:var(--muted)}
.cart .discount input{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px}
.empty{color:var(--muted);text-align:center;margin:12px 0}

/* -------- Table Modal -------- */
.table-modal{align-items:center}
.table-modal .sheet{max-width:420px;border-radius:18px;max-height:80vh;text-align:center;padding:18px}
.table-modal .sheet h3{margin:4px 0 10px}
.table-modal .sheet p{margin:0 0 16px;color:var(--muted);font-size:14px;line-height:1.6}
.table-modal .sheet select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:15px}
.table-modal .sheet .note{margin:4px 0 14px;color:var(--muted);font-size:13px;line-height:1.5}
.table-modal .sheet .actions{margin-top:16px}
.table-modal .sheet .error{color:#c0392b;font-size:13px;margin-top:10px;display:none}
body.dark .table-modal .sheet .error{color:#e57373}

/* -------- Profile Modal -------- */
.profile-modal{align-items:center}
.profile-modal .sheet{max-width:420px;border-radius:18px;max-height:80vh;text-align:start;padding:18px;display:flex;flex-direction:column;gap:12px}
.profile-modal .sheet h3{margin:0}
.profile-modal .sheet p{margin:0;color:var(--muted);font-size:14px;line-height:1.6}
.profile-modal .sheet label{font-size:13px;color:var(--muted)}
.profile-modal .sheet input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px}
.profile-modal .sheet .note{font-size:12px;color:var(--muted);margin-top:-4px}
.profile-modal .sheet .actions{display:flex;gap:8px;margin-top:4px}

/* -------- Loyalty Modal -------- */
.loyalty-modal{align-items:center}
.loyalty-modal .sheet{max-width:420px;border-radius:18px;max-height:80vh;text-align:center;padding:22px;display:flex;flex-direction:column;gap:14px}
.loyalty-modal .sheet h3{margin:0}
.loyalty-modal .sheet p{margin:0;font-size:14px;line-height:1.6;color:var(--muted)}
.loyalty-modal .sheet strong{color:var(--brand);font-size:16px}
.loyalty-modal .sheet .actions{display:flex;justify-content:center}

/* -------- Order Log Modal -------- */
.log-modal{align-items:center}
.log-modal .sheet{max-width:520px;border-radius:18px;max-height:82vh;padding:18px;display:flex;flex-direction:column;gap:12px}
.log-modal .sheet h3{margin:0}
.log-modal .sheet p{margin:0;color:var(--muted);font-size:14px;line-height:1.6}
.log-modal .sheet .log-empty{color:var(--muted);text-align:center;padding:22px 0;font-size:14px}
.log-modal .sheet .log-list{flex:1 1 auto;overflow:auto;display:flex;flex-direction:column;gap:12px;padding:2px}
.log-entry{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--card);box-shadow:0 6px 16px rgba(0,0,0,.04)}
.log-entry h4{margin:0;font-size:15px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.log-entry h4 .total{font-weight:800;color:var(--brand)}
.log-entry .meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;flex-wrap:wrap;gap:8px}
.log-entry .items{margin:10px 0 0;padding-inline-start:20px;font-size:13px;color:var(--text)}
.log-entry .items li{margin-bottom:4px;line-height:1.5}
.log-entry .loyalty-note{margin-top:8px;font-size:12px;color:var(--brand);font-weight:600}
.log-modal .sheet .actions{margin-top:6px;display:flex;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <img src="https://i.postimg.cc/g0g9RwM0/Untitled-design-9.png" alt="Neema Menu">
          <div class="brand-text">
            <h1 id="title">منيو نيمة</h1>
            <span class="pill" id="tagline">مذاق ينبت من الجذور</span>
          </div>
        </div>
        <div class="header-side">
          <div class="greeting" id="greetingBar">
            <span id="greetingText">مرحبا ضيفنا العزيز</span>
            <button class="btn ghost small" id="profileBtn">👤 تحديث البيانات</button>
          </div>
          <div class="actions">
            <button class="btn ghost" id="orderLogBtn">📜 <span id="orderLogBtnLabel">سجل الطلبات</span></button>
            <button class="btn" id="langBtn">E</button>
            <button class="btn" id="modeBtn">🌙</button>
          </div>
        </div>
      </div>
      <div class="search">
        <input id="search" placeholder="ابحث باسم الصنف… (مثال: لاتيه، موهيتو)">
      </div>
    </div>
  </header>

  <main>
    <details open>
      <summary>🔥 <span data-i18n="hot_drinks">المشروبات الساخنة</span></summary>
      <div class="grid" id="hot-coffee"></div>
      <div class="grid" id="hot-tea"></div>
    </details>

    <details>
      <summary>❄️ <span data-i18n="cold_drinks">المشروبات الباردة</span></summary>
      <div class="grid" id="cold-coffee"></div>
      <div class="grid" id="cold-mojito"></div>
      <div class="grid" id="cold-other"></div>
    </details>

    <details>
      <summary>🍰 <span data-i18n="dessert">الحلا</span></summary>
      <div class="grid" id="dessert-cake"></div>
      <div class="grid" id="dessert-side"></div>
    </details>

    <footer>
      <div id="foot">جميع الحقوق محفوظة - نيمة كافيه ©</div>
    </footer>
  </main>

  <!-- Floating Cart Button -->
  <button class="fab" id="cartFab">🛒 <span data-i18n="cart">السلة</span> <span class="count" id="cartCount">0</span></button>

  <!-- Product Modal -->
  <div class="modal" id="productModal" aria-hidden="true">
    <div class="backdrop" onclick="closeProduct()"></div>
    <div class="sheet">
      <div class="row">
        <div class="bigimg"><img id="pImg" alt=""></div>
        <div style="flex:1">
          <h3 id="pName">اسم المنتج</h3>
          <div class="line">
            <span class="price" id="pPrice">0
              <span class="sar" aria-label="ريال سعودي"></span>
              <span class="sar-fallback">ريال</span>
            </span>
            <span class="cals" id="pCal">0 سعرة حرارية</span>
          </div>
        </div>
      </div>

      <p class="desc" id="pDesc"></p>

      <!-- Customization -->
      <div class="custom">
        <h4 id="customTitle">التخصيص</h4>

        <!-- Sugar options -->
        <div class="radios" id="sugarGroup">
          <label><input type="radio" name="sugar" value="external" checked> <span id="lblSugarExternal">سكر خارجي</span></label>
          <label><input type="radio" name="sugar" value="none"> <span id="lblSugarNone">بدون سكر</span></label>
          <label><input type="radio" name="sugar" value="less"> <span id="lblSugarLess">سكر قليل</span></label>
          <label><input type="radio" name="sugar" value="normal"> <span id="lblSugarNormal">سكر عادي</span></label>
        </div>

        <!-- Water temperature (water only) -->
        <div class="radios" id="waterTempGroup" style="display:none">
          <label><input type="radio" name="waterTemp" value="cold" checked> <span id="lblWaterCold">بارد (من الثلاجة)</span></label>
          <label><input type="radio" name="waterTemp" value="room"> <span id="lblWaterRoom">غير مبرد (درجة الغرفة)</span></label>
        </div>

        <!-- Base opts -->
        <div class="opts" id="customBase" style="margin-top:6px">
          <label id="wrapLessIce"><input type="checkbox" id="optLessIce"> <span id="lblLessIce">ثلج أقل</span></label>
        </div>

        <!-- Jabana-only -->
        <div class="opts" id="customJabana" style="display:none">
          <label><input type="checkbox" id="optGinger"> <span id="lblGinger">زنجبيل</span></label>
          <label><input type="checkbox" id="optCardamom"> <span id="lblCardamom">هبهان</span></label>
        </div>

        <div class="radios" id="strengthGroup" style="display:none">
          <label><input type="radio" name="strength" value="heavy"> <span id="lblHeavy">ثقيلة</span></label>
          <label><input type="radio" name="strength" value="light"> <span id="lblLight">خفيفة</span></label>
          <label><input type="radio" name="strength" value="balanced" checked> <span id="lblBalanced">موزونة</span></label>
        </div>
      </div>

      <div class="qty">
        <button onclick="decQty()">−</button>
        <span id="pQty" style="min-width:24px;text-align:center">1</span>
        <button onclick="incQty()">+</button>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeProduct()" id="backBtn">رجوع</button>
        <button class="btn primary" onclick="addCurrentToCart()" id="addBtn">إضافة للسلة</button>
      </div>
    </div>
  </div>

  <!-- Cart Sheet -->
  <div class="cart" id="cartSheet" aria-hidden="true">
    <div class="backdrop" onclick="closeCart()"></div>
    <div class="sheet">
      <h3><span data-i18n="your_cart">سلة طلباتك</span></h3>
      <div id="cartItems"></div>
      <div class="summary">
        <div><span data-i18n="total">الإجمالي</span>:</div>
        <div class="price" id="cartTotal">0 <span class="sar"></span><span class="sar-fallback">ريال</span></div>
      </div>
      <div class="loyalty-summary" id="cartLoyaltyNote" style="display:none"></div>
      <div class="discount">
        <label for="discountInput" id="discountLabel">كود الخصم (اختياري)</label>
        <input id="discountInput" placeholder="أدخل كود الخصم" autocomplete="off">
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <label for="tableCart" style="color:var(--muted)"><span data-i18n="table">طاولة</span></label>
        <select id="tableCart" style="flex:1;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px;border-radius:10px"></select>
      </div>
      <div class="actions">
        <button class="btn" onclick="clearCart()"><span data-i18n="clear">تفريغ</span></button>
        <button class="btn primary" onclick="sendOrder()"><span data-i18n="send_order">إرسال الطلب</span> 🚀</button>
      </div>
      <div id="emptyText" class="empty" style="display:none"><span data-i18n="empty">السلة فارغة</span></div>
    </div>
  </div>

  <!-- Table Selection Modal -->
  <div class="modal table-modal" id="tableModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="tableModalTitle">حدد رقم الطاولة</h3>
      <p id="tableModalDesc">يجب اختيار رقم الطاولة قبل متابعة الطلب.</p>
      <p class="note" id="tableModalNote">رقم الطاولة موجود على الباركود على الطاولة.</p>
      <select id="tablePrompt"></select>
      <div class="actions">
        <button class="btn" id="tableCancelBtn">إلغاء</button>
        <button class="btn primary" id="tableConfirmBtn">تأكيد</button>
      </div>
      <div class="error" id="tablePromptError">يرجى اختيار رقم الطاولة لإتمام الطلب</div>
    </div>
  </div>

  <!-- Order Log Modal -->
  <div class="modal log-modal" id="orderLogModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="orderLogTitle">سجل الطلبات</h3>
      <p id="orderLogDesc">يتم حفظ الطلبات المرسلة من هذا الجهاز هنا للرجوع إليها لاحقًا.</p>
      <div style="display:flex;gap:8px;align-items:center">
        <label for="orderLogCustomerSelect" id="orderLogCustomerLabel" style="font-size:13px;color:var(--muted)">اختر العميل</label>
        <select id="orderLogCustomerSelect" style="flex:1;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px;border-radius:10px"></select>
      </div>
      <div class="log-empty" id="orderLogEmpty">لا توجد طلبات مسجلة بعد.</div>
      <div class="log-list" id="orderLogList"></div>
      <div class="actions">
        <button class="btn" id="orderLogCloseBtn">إغلاق</button>
        <button class="btn ghost" id="orderLogClearBtn">🧹 <span id="orderLogClearLabel">حذف السجل</span></button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal profile-modal" id="profileModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="profileModalTitle">بياناتك</h3>
      <p id="profileModalDesc">أدخل اسمك ورقم جوالك لنرحب بك دائماً كما تحب.</p>
      <div>
        <label for="profileName" id="profileNameLabel">الاسم</label>
        <input id="profileName" placeholder="اسمك الجميل" autocomplete="name">
      </div>
      <div>
        <label for="profilePhone" id="profilePhoneLabel">رقم الجوال</label>
        <input id="profilePhone" placeholder="05xxxxxxxx" inputmode="tel" autocomplete="tel">
        <div class="note" id="profileModalNote">تظهر هذه البيانات على الطلبات فقط لخدمتكم بشكل أفضل.</div>
      </div>
      <div class="actions">
        <button class="btn" id="profileSkipBtn">لاحقاً</button>
        <button class="btn primary" id="profileSaveBtn">حفظ</button>
      </div>
    </div>
  </div>

  <!-- Loyalty Modal -->
  <div class="modal loyalty-modal" id="loyaltyModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="loyaltyTitle">عميلنا المميز</h3>
      <p id="loyaltyMessage">شكراً لاختيارك مشروبنا المفضل.</p>
      <div class="actions">
        <button class="btn primary" id="loyaltyCloseBtn">تمام</button>
      </div>
    </div>
  </div>

  <div class="bar">
    <div class="inner">
      <select id="table"></select>
      <button class="btn primary" id="callBtn">🔔 <span data-i18n="call_waiter">طلب النادل</span></button>
    </div>
  </div>

  <script>
/* ===== Telegram (اختبار) ===== */
const TELEGRAM_BOT_TOKEN = '8234122453:AAGmkEFETh1yuXzgDHChoTu0YFuD0BeVK8c';
const TELEGRAM_CHAT_ID_NEW = '5828433542';

/* ===== Lang & Strings ===== */
let lang = localStorage.getItem('nima.lang') || 'ar';

const STRINGS = {
  ar: {
    title:'منيو نيمة', tagline:'مذاق ينبت من الجذور', search:'ابحث باسم الصنف… (مثال: لاتيه، موهيتو)',
    hot_drinks:'المشروبات الساخنة', cold_drinks:'المشروبات الباردة', dessert:'الحلا',
    call_waiter:'طلب النادل', table:'طاولة', footer:'© كل الحقوق محفوظة - نيمة كافيه',
    cart:'السلة', your_cart:'سلة طلباتك', total:'الإجمالي', send_order:'إرسال الطلب', clear:'تفريغ', empty:'السلة فارغة',
    added:'تمت إضافة المنتج إلى السلة', qty:'الكمية', add_to_cart:'إضافة للسلة',
    kcal:'سعرة حرارية', sar_label:'ريال سعودي', back:'رجوع',
    waiter_toast:'🔔 سوف يأتي إليك النادل لخدمتك فوراً!',
    order_log_button:'سجل الطلبات', order_log_title:'سجل الطلبات',
    order_log_desc:'يتم حفظ الطلبات المرسلة من هذا الجهاز هنا للرجوع إليها لاحقًا.',
    order_log_empty:'لا توجد طلبات مسجلة بعد.',
    order_log_empty_customer:'لا توجد طلبات مسجلة لهذا العميل بعد.',
    order_log_customer_label:'اختر العميل',
    order_log_guest:'طلبات الضيوف',
    clear_log:'حذف السجل', clear_log_confirm:'هل تريد حذف سجل الطلبات لهذا العميل؟',
    order_sent_saved:'تم إرسال الطلب بنجاح ✅ — حُفظ الطلب في السجل.',
    order_send_failed:'تعذّر إرسال الطلب ❌',
    customize:'التخصيص', less_ice:'ثلج أقل',
    ginger:'زنجبيل', cardamom:'هبهان',
    strength:'القوة', heavy:'ثقيلة', light:'خفيفة', balanced:'موزونة',
    sugar_external:'سكر خارجي', sugar_none:'بدون سكر', sugar_less:'سكر قليل', sugar_normal:'سكر عادي',
    water_cold:'بارد (من الثلاجة)', water_room:'غير مبرد (درجة الغرفة)',
    select_table:'اختر رقم الطاولة',
    table_modal_title:'حدد رقم الطاولة',
    table_modal_desc:'يجب اختيار رقم الطاولة قبل متابعة الطلب.',
    table_modal_note:'رقم الطاولة موجود على الباركود على الطاولة.',
    table_modal_error:'يرجى اختيار رقم الطاولة لإتمام الطلب',
    order_time_label:'وقت الطلب', order_id_label:'رقم الطلب', total_due_label:'الإجمالي المستحق',
    confirm:'تأكيد', cancel:'إلغاء',
    greeting_guest:'مرحبا ضيفنا العزيز',
    greeting_named:'مرحبا {name}',
    greeting_toast:'مرحبا {name}! نورت المكان وتحت ظل النيمة 🤎',
    profile_button:'👤 تحديث البيانات',
    profile_modal_title:'بياناتك',
    profile_modal_desc:'أدخل اسمك ورقم جوالك لنرحب بك دائماً كما تحب.',
    profile_name_label:'الاسم',
    profile_phone_label:'رقم الجوال',
    profile_name_placeholder:'اسمك الجميل',
    profile_phone_placeholder:'05xxxxxxxx',
    profile_note:'تظهر هذه البيانات على الطلبات فقط لخدمتكم بشكل أفضل.',
    profile_skip:'لاحقاً',
    profile_save:'حفظ',
    profile_saved:'تم حفظ بياناتك بنجاح 🤎',
    profile_required:'يرجى إدخال الاسم أو رقم الجوال على الأقل.',
    discount_label:'كود الخصم (اختياري)',
    discount_placeholder:'أدخل كود الخصم',
    discount_code_label:'كود الخصم',
    customer_name_label:'اسم العميل',
    customer_phone_label:'رقم التواصل',
    loyalty_title:'عميلنا المميز',
    loyalty_message:'شكراً من القلب يا {name}! بعد أربع مرات من طلب <strong>{drink}</strong> المشروب الخامس علينا مجاناً. تفضل للكاشير وسجل بياناتك لتنضم لعائلة نيمة 🤎',
    loyalty_button:'تمام',
    loyalty_reward_label:'هدية الولاء',
    loyalty_discount_label:'خصم الولاء',
    order_log_loyalty_reward:'هدية الولاء'
  },
  en: {
    title:'Neema Menu', tagline:'A taste that grows from the roots', search:'Search item… (e.g., Latte, Mojito)',
    hot_drinks:'Hot Drinks', cold_drinks:'Cold Drinks', dessert:'Dessert',
    call_waiter:'Call Waiter', table:'Table', footer:'© Neema Cafe — All rights reserved',
    cart:'Cart', your_cart:'Your Cart', total:'Total', send_order:'Send Order', clear:'Clear', empty:'Cart is empty',
    added:'Item added to cart', qty:'Qty', add_to_cart:'Add to Cart',
    kcal:'kcal', sar_label:'Saudi Riyal', back:'Back',
    waiter_toast:'🔔 A waiter is on the way!',
    order_log_button:'Order Log', order_log_title:'Order Log',
    order_log_desc:'Orders sent from this device are saved here so you can review them later.',
    order_log_empty:'No orders have been saved yet.',
    order_log_empty_customer:'No orders saved for this customer yet.',
    order_log_customer_label:'Choose customer',
    order_log_guest:'Guest orders',
    clear_log:'Clear log', clear_log_confirm:'Clear this customer\'s log?',
    order_sent_saved:'Order sent ✅ — Saved to log.',
    order_send_failed:'Failed to send ❌',
    customize:'Customize', less_ice:'Less ice',
    ginger:'Ginger', cardamom:'Cardamom',
    strength:'Strength', heavy:'Strong', light:'Light', balanced:'Balanced',
    sugar_external:'Sugar on the side', sugar_none:'No sugar', sugar_less:'Less sugar', sugar_normal:'Regular sugar',
    water_cold:'Cold (chilled)', water_room:'Room temperature',
    select_table:'Select a table number',
    table_modal_title:'Choose your table',
    table_modal_desc:'Please pick a table number before continuing.',
    table_modal_note:'The table number is printed on the barcode at your table.',
    table_modal_error:'Please choose a table number to continue',
    order_time_label:'Order time', order_id_label:'Order ID', total_due_label:'Total due',
    confirm:'Confirm', cancel:'Cancel',
    greeting_guest:'Welcome, dear guest',
    greeting_named:'Hello {name}',
    greeting_toast:'Welcome back {name}! You light up Neema 🤎',
    profile_button:'👤 Update info',
    profile_modal_title:'Your details',
    profile_modal_desc:'Share your name and phone so we can greet you properly.',
    profile_name_label:'Name',
    profile_phone_label:'Phone',
    profile_name_placeholder:'Your name',
    profile_phone_placeholder:'+9665...',
    profile_note:'We only use this info to serve you better on orders.',
    profile_skip:'Later',
    profile_save:'Save',
    profile_saved:'Your details are saved 🤎',
    profile_required:'Please enter at least a name or phone number.',
    discount_label:'Discount code (optional)',
    discount_placeholder:'Enter discount code',
    discount_code_label:'Discount code',
    customer_name_label:'Customer name',
    customer_phone_label:'Phone',
    loyalty_title:'VIP Guest',
    loyalty_message:'Thank you so much, {name}! After four {drink} orders, this fifth one is on us. Please see the cashier so we can welcome you into the Neema family 🤎',
    loyalty_button:'Got it',
    loyalty_reward_label:'Loyalty treat',
    loyalty_discount_label:'Loyalty discount',
    order_log_loyalty_reward:'Loyalty treat'
  }
};

const IMG_DEFAULT = 'https://i.postimg.cc/Y0GT5M1f/image.png';

/* ===== Auto description helper ===== */
function autoDesc(it){
  const n = (it.en || it.ar || '').toLowerCase();
  const D = {
    latte: { ar:'حليب مخمّر مع إسبرسو بنكهة ناعمة ومتوازنة.', en:'Silky steamed milk with espresso, smooth and balanced.' },
    cappuccino: { ar:'رغوة غنية وإسبرسو بطابع كلاسيكي.', en:'Classic espresso topped with rich foam.' },
    espresso: { ar:'جرعة مركزة من القهوة بطعم قوي.', en:'A concentrated shot of bold espresso.' },
    americano: { ar:'إسبرسو مع ماء ساخن بطابع خفيف.', en:'Espresso topped with hot water—clean and light.' },
    mocha: { ar:'قهوة بالشوكولاتة وكريمة مخملية.', en:'Chocolate-kissed coffee with a velvety finish.' },
    spanish: { ar:'حلاوة متوازنة مع حليب مكثّف.', en:'Balanced sweetness with condensed milk.' },
    v60: { ar:'استخلاص ترشيح يبرز نكهات البنّ.', en:'Filtered extraction highlighting bean nuances.' },
    turkish: { ar:'قهوة مطحونة ناعمة برغوة تقليدية.', en:'Finely ground, traditionally foamed coffee.' },
    flat: { ar:'ملمس مخملي ونكهة مركّزة.', en:'Velvety milk with a pronounced espresso body.' },
    macchiato: { ar:'إسبرسو مع لمسة حليب.', en:'Espresso stained with a touch of milk.' },
    cortado: { ar:'توازن بين الحليب والإسبرسو.', en:'A balance of steamed milk and espresso.' },
    matcha: { ar:'ماتشا كريمي بنكهة عشبية.', en:'Creamy matcha with grassy notes.' },
    chocolate: { ar:'كاكاو ساخن غني.', en:'Rich hot chocolate.' },
    mojito: { ar:'انتعاش نعنعي بحموضة ليمون.', en:'Minty refreshment with a lime twist.' },
    hibiscus: { ar:'كركديه زهري منعش.', en:'Floral, tart hibiscus.' },
    smoothie: { ar:'سموذي بارد ومنعش.', en:'A cold, refreshing smoothie.' },
    pistachio: { ar:'لاتيه فستق كريمي.', en:'Creamy pistachio latte.' },
    cake: { ar:'شريحة حلوى طازجة.', en:'Fresh sweet slice.' },
    luqaimat: { ar:'لقيمات ذهبية مقرمشة.', en:'Golden, crisp bites.' },
    water: { ar:'ماء نقي بارد.', en:'Chilled, pure water.' }
  };
  const pick = Object.keys(D).find(k => n.includes(k));
  return pick ? (lang==='ar' ? D[pick].ar : D[pick].en) :
    (lang==='ar' ? 'طعم متوازن ونكهة محضّرة بعناية.' : 'Balanced taste, crafted with care.');
}

/* ===== Data ===== */
const data = {
  hot: {
    coffee: [
      {ar:'ڤي 60', en:'V60', price:13, cal:5, img:IMG_DEFAULT},
      {ar:'قهوة اليوم', en:'Coffee of the Day', price:8, cal:5, img:IMG_DEFAULT},
      {ar:'امريكانو (صغير)', en:'Americano (Small)', price:6, cal:5, img:IMG_DEFAULT},
      {ar:'امريكانو (وسط)', en:'Americano (Medium)', price:8, cal:10, img:IMG_DEFAULT},
      {ar:'اسبريسو', en:'Espresso', price:6, cal:5, img:IMG_DEFAULT},
      {ar:'قهوة تركي', en:'Turkish Coffee', price:8, cal:15, img:IMG_DEFAULT},
      {ar:'جبنة (قهوة سودانية)', en:'Jabana (Sudanese Coffee)', price:6, cal:10, img:IMG_DEFAULT},
      {ar:'جبنة في جبنة (وسط)', en:'Jabana in Jabana (Medium)', price:16, cal:20, img:IMG_DEFAULT},
      {ar:'سبانش', en:'Spanish Latte (Hot)', price:12, cal:180, img:IMG_DEFAULT},
      {ar:'وايت موكا', en:'White Mocha (Hot)', price:18, cal:280, img:IMG_DEFAULT},
      {ar:'لاتيه', en:'Latte (Hot)', price:12, cal:190, img:IMG_DEFAULT},
      {ar:'كابتشينو', en:'Cappuccino', price:12, cal:120, img:IMG_DEFAULT},
      {ar:'كورتادو', en:'Cortado', price:7, cal:90, img:IMG_DEFAULT},
      {ar:'فلات وايت', en:'Flat White', price:12, cal:150, img:IMG_DEFAULT},
      {ar:'ميكاتو', en:'Macchiato', price:7, cal:25, img:IMG_DEFAULT},
      {ar:'قهوة فرنسي', en:'French Coffee', price:9, cal:120, img:IMG_DEFAULT}
    ],
    tea: [
      {ar:'شاي', en:'Tea', price:3, cal:2, img:IMG_DEFAULT},
      {ar:'شاي مقنن', en:'Strong Tea', price:6, cal:2, img:IMG_DEFAULT},
      {ar:'شاي حليب', en:'Milk Tea', price:6, cal:140, img:IMG_DEFAULT},
      {ar:'هوت شوكلت', en:'Hot Chocolate', price:13, cal:300, img:IMG_DEFAULT},
      {ar:'ماتشا', en:'Matcha (Hot)', price:16, cal:180, img:IMG_DEFAULT}
    ]
  },
  cold: {
    coffee: [
      {ar:'ڤي 60', en:'V60 (Iced)', price:13, cal:5, img:'https://i.postimg.cc/L8dVZxHs/12.png'},
      {ar:'قهوة اليوم', en:'Coffee of the Day (Iced)', price:8, cal:5, img:IMG_DEFAULT},
      {ar:'امريكانو', en:'Iced Americano', price:9, cal:5, img:IMG_DEFAULT},
      {ar:'سبانش', en:'Spanish Latte (Iced)', price:17, cal:180, img:IMG_DEFAULT},
      {ar:'لاتيه', en:'Iced Latte', price:12, cal:190, img:IMG_DEFAULT},
      {ar:'سبانش لاتيه', en:'Spanish Latte', price:14, cal:220, img:IMG_DEFAULT},
      {ar:'وايت موكا', en:'White Mocha (Iced)', price:18, cal:300, img:IMG_DEFAULT},
      {ar:'نيمة شيكن', en:'Neema Chicken (Cold Drink)', price:19, cal:220, img:IMG_DEFAULT},
      {ar:'بستاشيو لاتيه', en:'Pistachio Latte (Iced)', price:18, cal:280, img:IMG_DEFAULT}
    ],
    mojito: [
      {ar:'موهيتو', en:'Mojito', price:17, cal:120, img:IMG_DEFAULT},
      {ar:'موهيتو مكس', en:'Mojito Mix', price:18, cal:140, img:IMG_DEFAULT},
      {ar:'موهيتو بلو بيري/كود رد', en:'Blueberry Mojito / Code Red', price:17, cal:170, img:'https://i.postimg.cc/BQwV7rxQ/8.png'},
      {ar:'موهيتو بلو بيري/سفن آب', en:'Blueberry Mojito / 7up', price:15, cal:150, img:'https://i.postimg.cc/BQwV7rxQ/8.png'},
      {ar:'موهيتو فراولة/كود رد', en:'Strawberry Mojito / Code Red', price:17, cal:170, img:IMG_DEFAULT},
      {ar:'موهيتو فراولة/سفن آب', en:'Strawberry Mojito / 7up', price:15, cal:150, img:IMG_DEFAULT},
      {ar:'موهيتو بطيخ/كود رد', en:'Watermelon Mojito / Code Red', price:17, cal:160, img:IMG_DEFAULT},
      {ar:'موهيتو بطيخ/سفن آب', en:'Watermelon Mojito / 7up', price:15, cal:140, img:IMG_DEFAULT},
      {ar:'موهيتو باشن فروت/كود رد', en:'Passion Fruit Mojito / Code Red', price:17, cal:170, img:IMG_DEFAULT},
      {ar:'موهيتو باشن فروت/سفن آب', en:'Passion Fruit Mojito / 7up', price:15, cal:150, img:IMG_DEFAULT}
    ],
    other:[
      {ar:'كركديه', en:'Hibiscus', price:8, cal:50, img:'https://i.postimg.cc/Fz9MmhB2/11.png'},
      {ar:'سموذي كركدي', en:'Hibiscus Smoothie', price:15, cal:180, img:'https://i.postimg.cc/7YNLg64T/2.png'},
      {ar:'ماء', en:'Water', price:1, cal:0, img:'https://i.postimg.cc/ZqfZw7K8/f11d7585-3f1a-4bb1-95d4-c10e9393bad7-500x500-684-HWh-Kqw4-JSS2b-Dk6wp-FGnd5sxpq-Xz-Ch-ZAXt-Bnk.webp'}
    ]
  },
  dessert: {
    cake: [
      {ar:'نيمة كيك', en:'Neema Cake', price:18, cal:420, img:'https://i.postimg.cc/YCRwSnF5/image.jpg'},
      {ar:'مولتن دارك تشوكليت', en:'Molten Dark Chocolate', price:17, cal:450, img:'https://i.postimg.cc/QNqLmY4H/images.jpg'}
    ],
    side: [
      {ar:'ينسون', en:'Anise Tea', price:4, cal:5, img:'https://i.postimg.cc/9FfdSzpy/images.jpg'},
      {ar:'بسكويت شاي كبير', en:'Tea Biscuit (Large)', price:8, cal:200, img:'https://i.postimg.cc/L8t8331D/4-1.png'},
      {ar:'بسكويت شاي صغير', en:'Tea Biscuit (Small)', price:3, cal:100, img:'https://i.postimg.cc/L8t8331D/4-1.png'},
      {ar:'لقيمات', en:'Luqaimat', price:13, cal:320, img:'https://i.postimg.cc/ZnmSR1fh/image.webp'}
    ]
  }
};

/* ===== State ===== */
let cart = JSON.parse(localStorage.getItem('nima.cart') || '[]');
function saveCart(){ localStorage.setItem('nima.cart', JSON.stringify(cart)); }
function cartCount(){ return cart.reduce((s,i)=>s+i.qty,0); }
function cartTotal(){ return cart.reduce((s,i)=>s+i.qty*i.price,0); }
function updateCartBadge(){ document.getElementById('cartCount').textContent = cartCount(); }
let pendingTableAction = null;
let shouldRestoreCart = false;
let selectedTable = '';
const ORDER_LOG_KEY = 'nima.orderLog';
const CUSTOMER_PROFILE_KEY = 'nima.customerProfile';
const CUSTOMER_REGISTRY_KEY = 'nima.customerRegistry';
const LOYALTY_KEY = 'nima.loyaltyTracker';
const SESSION_GREETING_KEY = 'nima.greetedSession';
let customerProfile = loadCustomerProfile();
let customerRegistry = loadCustomerRegistry();
let orderLog = loadOrderLog();
let loyaltyState = loadLoyaltyState();
let currentLogViewId = '';
let currentDiscountCode = '';

/* ===== Helpers ===== */
const $ = (s)=>document.querySelector(s);
const REG = []; // registry for click-safe products (no inline JSON)
function register(item, cat){ const id = REG.push({item,cat})-1; return id; }

function priceHTML(p){
  return `${p} <span class="sar" aria-label="${STRINGS[lang].sar_label}"></span><span class="sar-fallback">${lang==='ar'?'ريال':'SAR'}</span>`;
}

function escapeHtml(str){
  return String(str || '').replace(/[&<>"']/g, c=>({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[c]));
}

function loadCustomerProfile(){
  try{
    const raw = JSON.parse(localStorage.getItem(CUSTOMER_PROFILE_KEY) || 'null');
    if(raw && typeof raw === 'object') return raw;
  }catch(e){}
  return {};
}

function saveCustomerProfileData(profile){
  if(!profile || typeof profile !== 'object') return;
  customerProfile = profile;
  localStorage.setItem(CUSTOMER_PROFILE_KEY, JSON.stringify(customerProfile));
}

function loadCustomerRegistry(){
  try{
    const raw = JSON.parse(localStorage.getItem(CUSTOMER_REGISTRY_KEY) || 'null');
    if(raw && typeof raw === 'object') return raw;
  }catch(e){}
  return {};
}

function saveCustomerRegistry(){
  try{ localStorage.setItem(CUSTOMER_REGISTRY_KEY, JSON.stringify(customerRegistry)); }
  catch(e){ console.warn('Unable to persist customer registry', e); }
}

function ensureCustomerRegistryEntry(id, profile={}){
  if(!id) return;
  if(!customerRegistry || typeof customerRegistry !== 'object') customerRegistry = {};
  const existing = customerRegistry[id] || {};
  customerRegistry[id] = {
    name: profile.name !== undefined ? profile.name : (existing.name || ''),
    phone: profile.phone !== undefined ? profile.phone : (existing.phone || '')
  };
  saveCustomerRegistry();
}

function generateCustomerId(name='', phone=''){
  const phoneClean = (phone || '').replace(/\D+/g,'');
  if(phoneClean) return `cust-${phoneClean}`;
  const base = (name || '').trim().toLowerCase().replace(/[^\w\u0600-\u06FF]+/g,'-').replace(/^-+|-+$/g,'');
  if(base) return `cust-${base}`;
  return (customerProfile && customerProfile.id) ? customerProfile.id : 'guest';
}

function getActiveCustomerId(){
  return (customerProfile && customerProfile.id) ? customerProfile.id : 'guest';
}

function loadOrderLog(){
  let stored = null;
  try{ stored = JSON.parse(localStorage.getItem(ORDER_LOG_KEY) || 'null'); }
  catch(e){ stored = null; }
  if(Array.isArray(stored)){
    return { customers:{ guest:{ profile:{ name:'', phone:'' }, orders: stored } } };
  }
  if(!stored || typeof stored !== 'object') stored = { customers:{} };
  if(!stored.customers || typeof stored.customers !== 'object') stored.customers = {};
  return stored;
}

function ensureCustomerLog(id, profile){
  if(!id) id = 'guest';
  if(!orderLog || typeof orderLog !== 'object') orderLog = { customers:{} };
  if(!orderLog.customers || typeof orderLog.customers !== 'object') orderLog.customers = {};
  if(!orderLog.customers[id]){
    orderLog.customers[id] = { profile:{ name:'', phone:'' }, orders:[] };
  }
  if(profile){
    if(profile.name) orderLog.customers[id].profile.name = profile.name;
    if(profile.phone) orderLog.customers[id].profile.phone = profile.phone;
  }
  return orderLog.customers[id];
}

function saveOrderLog(){
  try{ localStorage.setItem(ORDER_LOG_KEY, JSON.stringify(orderLog)); }
  catch(e){ console.warn('Unable to persist order log', e); }
}

function loadLoyaltyState(){
  try{
    const raw = JSON.parse(localStorage.getItem(LOYALTY_KEY) || 'null');
    if(raw && typeof raw === 'object') return raw;
  }catch(e){}
  return {};
}

function saveLoyaltyState(){
  try{ localStorage.setItem(LOYALTY_KEY, JSON.stringify(loyaltyState)); }
  catch(e){ console.warn('Unable to persist loyalty tracker', e); }
}

function recordOrderLog(entry){
  if(!entry || typeof entry !== 'object') return;
  const customerId = getActiveCustomerId();
  const profile = {
    name: customerProfile && customerProfile.name ? customerProfile.name : '',
    phone: customerProfile && customerProfile.phone ? customerProfile.phone : ''
  };
  ensureCustomerRegistryEntry(customerId, profile);
  const bucket = ensureCustomerLog(customerId, profile);
  bucket.orders.unshift(entry);
  if(bucket.orders.length>100) bucket.orders.length = 100;
  saveOrderLog();
  renderOrderLog(customerId);
}

function formatLogTime(timestamp){
  if(!timestamp) return '';
  const date = new Date(timestamp);
  const options = { dateStyle:'short', timeStyle:'short' };
  if(typeof Intl !== 'undefined' && Intl.DateTimeFormat){
    try{ return new Intl.DateTimeFormat(lang==='ar'?'ar-SA':'en-GB', options).format(date); }
    catch(e){}
  }
  return date.toLocaleString();
}

function getCustomerLabel(id){
  if(!id) return STRINGS[lang].order_log_guest;
  if(customerProfile && customerProfile.id === id && customerProfile.name){
    return customerProfile.name;
  }
  const reg = customerRegistry && customerRegistry[id];
  if(reg && reg.name) return reg.name;
  const stored = orderLog && orderLog.customers && orderLog.customers[id];
  if(stored && stored.profile && stored.profile.name) return stored.profile.name;
  if(id === 'guest') return STRINGS[lang].order_log_guest;
  return `${STRINGS[lang].customer_name_label} ${id}`;
}

function getOrdersForCustomer(id){
  const bucket = ensureCustomerLog(id);
  return Array.isArray(bucket.orders) ? bucket.orders : [];
}

function renderOrderLog(preferredId){
  const list = document.getElementById('orderLogList');
  const empty = document.getElementById('orderLogEmpty');
  const selectEl = document.getElementById('orderLogCustomerSelect');
  if(!list || !empty) return;
  const activeId = preferredId || currentLogViewId || getActiveCustomerId();
  currentLogViewId = activeId;
  const optionIds = new Set(['guest']);
  if(customerProfile && customerProfile.id){
    optionIds.add(customerProfile.id);
    ensureCustomerRegistryEntry(customerProfile.id, customerProfile);
    ensureCustomerLog(customerProfile.id, customerProfile);
  }
  Object.keys(customerRegistry || {}).forEach(id=> optionIds.add(id));
  if(orderLog && orderLog.customers){
    Object.keys(orderLog.customers).forEach(id=> optionIds.add(id));
  }
  const options = Array.from(optionIds).map(id=>({ id, label: getCustomerLabel(id) }));
  options.sort((a,b)=> a.label.localeCompare(b.label, lang==='ar'?'ar':'en', { sensitivity:'base' }));
  if(selectEl){
    selectEl.innerHTML='';
    options.forEach(opt=>{
      const o=document.createElement('option');
      o.value = opt.id;
      o.textContent = opt.label;
      selectEl.appendChild(o);
    });
    if(options.some(opt=>opt.id===activeId)){
      selectEl.value = activeId;
    } else if(options.length){
      currentLogViewId = options[0].id;
      selectEl.value = currentLogViewId;
    }
  }
  const orders = getOrdersForCustomer(currentLogViewId);
  list.innerHTML='';
  if(!orders.length){
    empty.style.display='block';
    empty.textContent = STRINGS[lang].order_log_empty_customer || STRINGS[lang].order_log_empty;
    return;
  }
  empty.style.display='none';
  orders.forEach(entry=>{
    const orderId = entry && (entry.orderId || entry.id || entry.code) ? (entry.orderId || entry.id || entry.code) : '#';
    const totalValue = Number(entry && entry.total) || 0;
    const metaParts = [];
    if(entry && entry.table){ metaParts.push(`${STRINGS[lang].table} ${entry.table}`); }
    if(entry && entry.timestamp){
      const timeText = formatLogTime(entry.timestamp);
      if(timeText) metaParts.push(timeText);
    }
    if(entry && entry.discountCode){ metaParts.push(`${STRINGS[lang].discount_code_label}: ${entry.discountCode}`); }
    if(entry && Number(entry.loyaltyDiscount) > 0){
      const discountValue = Number(entry.loyaltyDiscount);
      metaParts.push(`${STRINGS[lang].loyalty_discount_label}: -${discountValue} ${lang==='ar'?'ريال':'SAR'}`);
    }
    if(entry && entry.customer && entry.customer.phone){
      metaParts.push(`${STRINGS[lang].customer_phone_label}: ${entry.customer.phone}`);
    }
    const item = document.createElement('div');
    item.className = 'log-entry';
    item.innerHTML = `
      <h4>
        <span>${orderId}</span>
        <span class="total">${priceHTML(totalValue)}</span>
      </h4>
      <div class="meta">${metaParts.join(' • ')}</div>
    `;
    if(entry && Array.isArray(entry.items) && entry.items.length){
      const ul = document.createElement('ul');
      ul.className = 'items';
      entry.items.forEach(it=>{
        const name = lang==='ar' ? (it.name_ar || it.name_en || '') : (it.name_en || it.name_ar || '');
        const opts = it.options && it.options.length ? ` — ${it.options.join(lang==='ar'?'، ':' / ')}` : '';
        const qty = it.qty || 1;
        ul.insertAdjacentHTML('beforeend', `<li>${name} ×${qty}${opts}</li>`);
      });
      item.appendChild(ul);
    }
    if(entry && Array.isArray(entry.loyaltyRewards) && entry.loyaltyRewards.length){
      const note = document.createElement('div');
      note.className = 'loyalty-note';
      const lines = entry.loyaltyRewards.map(reward=>{
        const drink = lang==='ar' ? (reward.drink_ar || reward.drink_en || '') : (reward.drink_en || reward.drink_ar || '');
        const count = reward.freebies || 1;
        return `${STRINGS[lang].order_log_loyalty_reward}: ${drink} ×${count}`;
      });
      note.textContent = lines.join(' • ');
      item.appendChild(note);
    }
    list.appendChild(item);
  });
  if(selectEl && !selectEl.dataset.bound){
    selectEl.dataset.bound = '1';
    selectEl.addEventListener('change', (e)=>{
      currentLogViewId = e.target.value || 'guest';
      renderOrderLog(currentLogViewId);
    });
  }
}

function populateTableSelect(select, selectedValue='', disablePlaceholder=true){
  if(!select) return;
  select.innerHTML='';
  const placeholder = document.createElement('option');
  placeholder.value='';
  placeholder.textContent = STRINGS[lang].select_table;
  if(disablePlaceholder){ placeholder.disabled = true; }
  if(!selectedValue){ placeholder.selected = true; }
  select.appendChild(placeholder);
  for(let i=1;i<=15;i++){
    const o=document.createElement('option');
    o.value=String(i);
    o.textContent = `${STRINGS[lang].table} ${i}`;
    select.appendChild(o);
  }
  if(selectedValue){ select.value = selectedValue; }
}

function setTableValue(val){
  selectedTable = val || '';
  const baseSelect = document.getElementById('table');
  const cartSelectEl = document.getElementById('tableCart');
  if(baseSelect) baseSelect.value = selectedTable;
  if(cartSelectEl) cartSelectEl.value = selectedTable;
}

function getCurrentTableValue(){
  if(selectedTable) return selectedTable;
  const baseSelect = document.getElementById('table');
  const cartSelectEl = document.getElementById('tableCart');
  return (baseSelect && baseSelect.value) || (cartSelectEl && cartSelectEl.value) || '';
}

function formatArTime12h(date){
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const period = hours >= 12 ? 'مساءً' : 'صباحًا';
  hours = hours % 12 || 12;
  return `${hours}:${minutes} ${period}`;
}

function buildTimestampInfo(){
  const now = new Date();
  let dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
  let timeStr = formatArTime12h(now);
  if(typeof Intl !== 'undefined' && Intl.DateTimeFormat){
    try{
      const dateFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-gregory', { year:'numeric', month:'2-digit', day:'2-digit' });
      dateStr = dateFormatter.format(now);
    }catch(e){}
    try{
      const timeFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-gregory', { hour:'numeric', minute:'2-digit', hour12:true });
      let formatted = timeFormatter.format(now);
      if(formatted.includes('ص')) formatted = formatted.replace('ص', 'صباحًا');
      if(formatted.includes('م')) formatted = formatted.replace('م', 'مساءً');
      timeStr = formatted;
    }catch(e){}
  }
  return { now, date: dateStr, time: timeStr, full: `${dateStr} ${timeStr}` };
}

function isCartOpen(){
  const sheet = document.getElementById('cartSheet');
  return sheet && sheet.style.display === 'flex';
}

function makeItemEl(it, cat){
  const el = document.createElement('div');
  el.className = 'item';
  const name = (lang==='ar'?it.ar:it.en);
  const id = register(it, cat);
  el.innerHTML = `
    <div class="thumb"><img src="${it.img||IMG_DEFAULT}" alt="${name}"/></div>
    <div>
      <div class="line">
        <span class="name">${name}</span>
        <span class="dots"></span>
        <span class="price">${priceHTML(it.price)}</span>
      </div>
      <div class="cals">${it.cal} ${STRINGS[lang].kcal}</div>
      <div class="sub">${it['desc_'+lang] || autoDesc(it)}</div>
    </div>`;
  el.addEventListener('click', ()=>{ const rec=REG[id]; openProduct(rec.item, rec.cat); });
  return el;
}

function mount(containerId, arr, cat){
  const root = document.getElementById(containerId); root.innerHTML='';
  arr.forEach(it=> root.appendChild(makeItemEl(it, cat)));
}

function renderAll(){
  // strings
  $('#title').textContent = STRINGS[lang].title;
  $('#tagline').textContent = STRINGS[lang].tagline;
  $('#search').placeholder = STRINGS[lang].search;
  document.querySelectorAll('[data-i18n="hot_drinks"]').forEach(e=> e.textContent = STRINGS[lang].hot_drinks);
  document.querySelectorAll('[data-i18n="cold_drinks"]').forEach(e=> e.textContent = STRINGS[lang].cold_drinks);
  document.querySelectorAll('[data-i18n="dessert"]').forEach(e=> e.textContent = STRINGS[lang].dessert);
  document.querySelectorAll('[data-i18n="call_waiter"]').forEach(e=> e.textContent = STRINGS[lang].call_waiter);
  document.querySelectorAll('[data-i18n="cart"]').forEach(e=> e.textContent = STRINGS[lang].cart);
  document.querySelectorAll('[data-i18n="your_cart"]').forEach(e=> e.textContent = STRINGS[lang].your_cart);
  document.querySelectorAll('[data-i18n="total"]').forEach(e=> e.textContent = STRINGS[lang].total);
  document.querySelectorAll('[data-i18n="send_order"]').forEach(e=> e.textContent = STRINGS[lang].send_order);
  document.querySelectorAll('[data-i18n="clear"]').forEach(e=> e.textContent = STRINGS[lang].clear);
  document.querySelectorAll('[data-i18n="empty"]').forEach(e=> e.textContent = STRINGS[lang].empty);
  const orderLogBtnLabel = document.getElementById('orderLogBtnLabel');
  if(orderLogBtnLabel) orderLogBtnLabel.textContent = STRINGS[lang].order_log_button;
  document.getElementById('orderLogTitle').textContent = STRINGS[lang].order_log_title;
  document.getElementById('orderLogDesc').textContent = STRINGS[lang].order_log_desc;
  document.getElementById('orderLogEmpty').textContent = STRINGS[lang].order_log_empty_customer || STRINGS[lang].order_log_empty;
  document.getElementById('orderLogCloseBtn').textContent = STRINGS[lang].cancel;
  document.getElementById('orderLogClearLabel').textContent = STRINGS[lang].clear_log;
  const orderLogCustomerLabel = document.getElementById('orderLogCustomerLabel');
  if(orderLogCustomerLabel) orderLogCustomerLabel.textContent = STRINGS[lang].order_log_customer_label;
  document.getElementById('tableModalTitle').textContent = STRINGS[lang].table_modal_title;
  document.getElementById('tableModalDesc').textContent = STRINGS[lang].table_modal_desc;
  document.getElementById('tableModalNote').textContent = STRINGS[lang].table_modal_note;
  document.getElementById('tableConfirmBtn').textContent = STRINGS[lang].confirm;
  document.getElementById('tableCancelBtn').textContent = STRINGS[lang].cancel;
  document.getElementById('tablePromptError').textContent = STRINGS[lang].table_modal_error;
  const profileBtnEl = document.getElementById('profileBtn');
  if(profileBtnEl) profileBtnEl.textContent = STRINGS[lang].profile_button;
  document.getElementById('profileModalTitle').textContent = STRINGS[lang].profile_modal_title;
  document.getElementById('profileModalDesc').textContent = STRINGS[lang].profile_modal_desc;
  document.getElementById('profileNameLabel').textContent = STRINGS[lang].profile_name_label;
  document.getElementById('profilePhoneLabel').textContent = STRINGS[lang].profile_phone_label;
  document.getElementById('profileModalNote').textContent = STRINGS[lang].profile_note;
  document.getElementById('profileSkipBtn').textContent = STRINGS[lang].profile_skip;
  document.getElementById('profileSaveBtn').textContent = STRINGS[lang].profile_save;
  document.getElementById('profileName').placeholder = STRINGS[lang].profile_name_placeholder;
  document.getElementById('profilePhone').placeholder = STRINGS[lang].profile_phone_placeholder;
  document.getElementById('loyaltyTitle').textContent = STRINGS[lang].loyalty_title;
  document.getElementById('loyaltyCloseBtn').textContent = STRINGS[lang].loyalty_button;
  const discountLabel = document.getElementById('discountLabel');
  if(discountLabel) discountLabel.textContent = STRINGS[lang].discount_label;
  const discountInput = document.getElementById('discountInput');
  if(discountInput){
    discountInput.placeholder = STRINGS[lang].discount_placeholder;
    discountInput.value = currentDiscountCode;
  }

  // dir/lang
  document.documentElement.lang = (lang==='ar'?'ar':'en');
  document.documentElement.dir = (lang==='ar'?'rtl':'ltr');

  // items
  mount('hot-coffee', data.hot.coffee, 'hot');
  mount('hot-tea', data.hot.tea, 'hot');
  mount('cold-coffee', data.cold.coffee, 'cold');
  mount('cold-mojito', data.cold.mojito, 'cold');
  mount('cold-other', data.cold.other, 'cold');
  mount('dessert-cake', data.dessert.cake, 'dessert');
  mount('dessert-side', data.dessert.side, 'dessert');

  fillTables();
  fillTablesCart();
  updateCartBadge();
  updateCustomizationLabels();
  updateGreeting();
  renderOrderLog(currentLogViewId || getActiveCustomerId());
  renderCart();
}

function updateGreeting(){
  const textEl = document.getElementById('greetingText');
  const btn = document.getElementById('profileBtn');
  if(btn) btn.textContent = STRINGS[lang].profile_button;
  if(!textEl) return;
  const name = customerProfile && customerProfile.name ? customerProfile.name.trim() : '';
  if(name){
    const safe = escapeHtml(name);
    const template = STRINGS[lang].greeting_named || STRINGS[lang].greeting_guest;
    textEl.innerHTML = template.replace('{name}', `<span class="welcome-name">${safe}</span>`);
  } else {
    textEl.textContent = STRINGS[lang].greeting_guest;
  }
}

function maybeToastGreeting(force=false){
  if(!(customerProfile && customerProfile.name)) return;
  const id = customerProfile.id || 'guest';
  const sessionKey = `${SESSION_GREETING_KEY}:${id}`;
  if(!force && sessionStorage.getItem(sessionKey)) return;
  const template = STRINGS[lang].greeting_toast || STRINGS[lang].greeting_named || STRINGS[lang].greeting_guest;
  toast(template.replace('{name}', customerProfile.name));
  sessionStorage.setItem(sessionKey, '1');
}

/* ===== Search ===== */
const search = $('#search');
search.addEventListener('input', ()=>{
  const q = search.value.trim().toLowerCase();
  const f = (arr)=>arr.filter(x=> ((x.ar||'')+(x.en||'')).toLowerCase().includes(q));
  mount('hot-coffee', f(data.hot.coffee), 'hot');
  mount('hot-tea', f(data.hot.tea), 'hot');
  mount('cold-coffee', f(data.cold.coffee), 'cold');
  mount('cold-mojito', f(data.cold.mojito), 'cold');
  mount('cold-other', f(data.cold.other), 'cold');
  mount('dessert-cake', f(data.dessert.cake), 'dessert');
  mount('dessert-side', f(data.dessert.side), 'dessert');
});

/* ===== Mode toggle ===== */
const modeBtn = $('#modeBtn');
const savedMode = localStorage.getItem('nima.mode');
if(savedMode){ if(savedMode==='dark') document.body.classList.add('dark'); }
else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ document.body.classList.add('dark'); }
modeBtn.textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
modeBtn.onclick = ()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('nima.mode', document.body.classList.contains('dark')?'dark':'light');
  modeBtn.textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
};

/* ===== Language toggle ===== */
const langBtn = $('#langBtn');
function updateLangBtn(){ langBtn.textContent = (lang==='ar') ? 'E' : 'ع'; }
langBtn.onclick = ()=>{
  lang = (lang==='ar') ? 'en' : 'ar';
  localStorage.setItem('nima.lang', lang);
  renderAll(); updateLangBtn();
};

/* ===== Tables ===== */
const tableSelect = $('#table');
function fillTables(){
  populateTableSelect(tableSelect, selectedTable, true);
  tableSelect.onchange = ()=>{
    const val = tableSelect.value;
    if(val){ setTableValue(val); }
  };
}
function fillTablesCart(){
  const sel = $('#tableCart');
  populateTableSelect(sel, selectedTable, true);
  sel.onchange = ()=>{
    const val = sel.value;
    if(val){ setTableValue(val); }
  };
}

/* ===== Table enforcement ===== */
const tableModalEl = document.getElementById('tableModal');
const tablePromptSelect = document.getElementById('tablePrompt');
const tablePromptError = document.getElementById('tablePromptError');
const tableConfirmBtn = document.getElementById('tableConfirmBtn');
const tableCancelBtn = document.getElementById('tableCancelBtn');
const tableModalBackdrop = document.querySelector('#tableModal .backdrop');

function openTableModal(){
  populateTableSelect(tablePromptSelect, selectedTable, false);
  tablePromptError.style.display='none';
  tableModalEl.style.display='flex';
  tableModalEl.setAttribute('aria-hidden','false');
  setTimeout(()=> tablePromptSelect.focus(), 30);
}

function closeTableModal(){
  tableModalEl.style.display='none';
  tableModalEl.setAttribute('aria-hidden','true');
  tablePromptError.style.display='none';
  pendingTableAction = null;
  shouldRestoreCart = false;
}

function ensureTableSelection(action, options={}){
  const forcePrompt = !!options.forcePrompt;
  const restoreCartPref = typeof options.restoreCart === 'boolean' ? options.restoreCart : isCartOpen();
  const current = getCurrentTableValue();
  if(current && !forcePrompt){
    setTableValue(current);
    if(typeof action === 'function') action(current);
    return true;
  }
  pendingTableAction = typeof action === 'function' ? action : null;
  shouldRestoreCart = restoreCartPref;
  openTableModal();
  return false;
}

if(tableModalBackdrop){ tableModalBackdrop.addEventListener('click', ()=> closeTableModal()); }
if(tableCancelBtn){ tableCancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeTableModal(); }); }
if(tablePromptSelect){
  tablePromptSelect.addEventListener('change', ()=>{
    if(tablePromptError) tablePromptError.style.display='none';
  });
}
if(tableConfirmBtn){
  tableConfirmBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const val = tablePromptSelect.value;
    if(!val){
      tablePromptError.style.display='block';
      tablePromptSelect.focus();
      return;
    }
    tablePromptError.style.display='none';
    setTableValue(val);
    tableModalEl.style.display='none';
    tableModalEl.setAttribute('aria-hidden','true');
    const action = pendingTableAction;
    const restoreCart = shouldRestoreCart;
    pendingTableAction = null;
    shouldRestoreCart = false;
    if(restoreCart) openCart();
    if(action) action(val);
  });
}

/* ===== Order Log Modal ===== */
const orderLogModalEl = document.getElementById('orderLogModal');
const orderLogBackdrop = document.querySelector('#orderLogModal .backdrop');
const orderLogBtn = document.getElementById('orderLogBtn');
const orderLogCloseBtn = document.getElementById('orderLogCloseBtn');
const orderLogClearBtn = document.getElementById('orderLogClearBtn');

function openOrderLog(){
  renderOrderLog();
  if(orderLogModalEl){
    orderLogModalEl.style.display='flex';
    orderLogModalEl.setAttribute('aria-hidden','false');
  }
}

function closeOrderLog(){
  if(orderLogModalEl){
    orderLogModalEl.style.display='none';
    orderLogModalEl.setAttribute('aria-hidden','true');
  }
}

if(orderLogBackdrop){ orderLogBackdrop.addEventListener('click', ()=> closeOrderLog()); }
if(orderLogBtn){ orderLogBtn.addEventListener('click', ()=> openOrderLog()); }
if(orderLogCloseBtn){ orderLogCloseBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeOrderLog(); }); }
if(orderLogClearBtn){
  orderLogClearBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const targetId = currentLogViewId || getActiveCustomerId();
    const bucket = ensureCustomerLog(targetId);
    if(!bucket.orders.length){ closeOrderLog(); return; }
    if(!window.confirm(STRINGS[lang].clear_log_confirm)) return;
    bucket.orders = [];
    saveOrderLog();
    renderOrderLog(targetId);
  });
}

/* ===== Profile Modal ===== */
const profileModalEl = document.getElementById('profileModal');
const profileBackdrop = document.querySelector('#profileModal .backdrop');
const profileBtnTrigger = document.getElementById('profileBtn');
const profileNameInput = document.getElementById('profileName');
const profilePhoneInput = document.getElementById('profilePhone');
const profileSaveBtn = document.getElementById('profileSaveBtn');
const profileSkipBtn = document.getElementById('profileSkipBtn');
let profileForced = false;

function normalizePhone(value){
  return (value || '').replace(/\s+/g,'').replace(/[^0-9+]/g,'');
}

function openProfileModal(force=false){
  profileForced = !!force;
  if(profileModalEl){
    profileModalEl.style.display='flex';
    profileModalEl.setAttribute('aria-hidden','false');
  }
  if(profileSkipBtn) profileSkipBtn.style.display = profileForced ? 'none' : 'inline-flex';
  if(profileNameInput){
    profileNameInput.value = customerProfile.name || '';
    if(profilePhoneInput) profilePhoneInput.value = customerProfile.phone || '';
    setTimeout(()=> profileNameInput.focus(), 40);
  }
}

function closeProfileModal(){
  if(profileModalEl){
    profileModalEl.style.display='none';
    profileModalEl.setAttribute('aria-hidden','true');
  }
  profileForced = false;
}

function handleProfileSave(){
  const name = (profileNameInput && profileNameInput.value || '').trim();
  const phone = normalizePhone((profilePhoneInput && profilePhoneInput.value || '').trim());
  if(!name && !phone){
    toast(STRINGS[lang].profile_required);
    if(profileNameInput) profileNameInput.focus();
    return;
  }
  let id = generateCustomerId(name, phone);
  if(!id) id = 'guest';
  const updatedProfile = { id, name, phone };
  saveCustomerProfileData(updatedProfile);
  ensureCustomerRegistryEntry(id, updatedProfile);
  const bucket = ensureCustomerLog(id, updatedProfile);
  if(id !== 'guest' && orderLog && orderLog.customers && orderLog.customers.guest && orderLog.customers.guest.orders.length){
    const guestOrders = orderLog.customers.guest.orders.slice();
    if(guestOrders.length){
      bucket.orders = guestOrders.concat(bucket.orders || []);
      orderLog.customers.guest.orders = [];
    }
  }
  saveOrderLog();
  currentLogViewId = id;
  updateGreeting();
  maybeToastGreeting(true);
  toast(STRINGS[lang].profile_saved);
  closeProfileModal();
  renderOrderLog(id);
}

if(profileBtnTrigger){ profileBtnTrigger.addEventListener('click', ()=> openProfileModal(false)); }
if(profileBackdrop){ profileBackdrop.addEventListener('click', ()=>{ if(!profileForced) closeProfileModal(); }); }
if(profileSkipBtn){ profileSkipBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeProfileModal(); }); }
if(profileSaveBtn){ profileSaveBtn.addEventListener('click', (e)=>{ e.preventDefault(); handleProfileSave(); }); }

/* ===== Loyalty Modal ===== */
const loyaltyModalEl = document.getElementById('loyaltyModal');
const loyaltyBackdrop = document.querySelector('#loyaltyModal .backdrop');
const loyaltyMessageEl = document.getElementById('loyaltyMessage');
const loyaltyCloseBtn = document.getElementById('loyaltyCloseBtn');

function showLoyaltyModal(info){
  if(!loyaltyModalEl) return;
  const drinkName = lang==='ar' ? (info && (info.drink_ar || info.drink_en) || '') : (info && (info.drink_en || info.drink_ar) || '');
  const customerName = customerProfile && customerProfile.name ? customerProfile.name : (lang==='ar'?'ضيفنا العزيز':'dear guest');
  if(loyaltyMessageEl){
    const safeDrink = escapeHtml(drinkName);
    const safeName = escapeHtml(customerName);
    const template = STRINGS[lang].loyalty_message || '';
    loyaltyMessageEl.innerHTML = template.replace('{drink}', safeDrink).replace('{name}', `<span class="welcome-name">${safeName}</span>`);
  }
  loyaltyModalEl.style.display='flex';
  loyaltyModalEl.setAttribute('aria-hidden','false');
}

function closeLoyaltyModal(){
  if(!loyaltyModalEl) return;
  loyaltyModalEl.style.display='none';
  loyaltyModalEl.setAttribute('aria-hidden','true');
}

if(loyaltyBackdrop){ loyaltyBackdrop.addEventListener('click', closeLoyaltyModal); }
if(loyaltyCloseBtn){ loyaltyCloseBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeLoyaltyModal(); }); }

/* ===== Call waiter ===== */
function sendWaiterCall(tableId){
  const fallback = lang==='ar' ? '؟' : '?';
  const t = tableId || fallback;
  const stamp = buildTimestampInfo();
  const lines = [
    `🔔 طاولة ${t} تحتاج خدمة`,
    `⏰ ${STRINGS.ar.order_time_label}: ${stamp.full}`
  ];
  const text = lines.map(encodeURIComponent).join('%0A%0A');
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID_NEW}&text=${text}`;
  fetch(url).catch(console.error);
  toast(STRINGS[lang].waiter_toast);
}

$('#callBtn').addEventListener('click', ()=>{
  ensureTableSelection((tableId)=>{
    sendWaiterCall(tableId);
  }, { forcePrompt:true, restoreCart:false });
});

/* ===== Product Modal logic ===== */
let currentProduct = null;
let currentCat = 'hot';

function isJabana(it){
  const a = (it.ar||''); const e=(it.en||'').toLowerCase();
  return a.includes('جبنة') || a.includes('سودانية') || e.includes('jabana') || e.includes('sudanese');
}
function isWater(it){
  const a=(it.ar||''); const e=(it.en||'').toLowerCase();
  return a.includes('ماء') || e.includes('water');
}

function updateCustomizationLabels(){
  $('#customTitle').textContent = STRINGS[lang].customize;
  $('#lblLessIce').textContent = STRINGS[lang].less_ice;
  $('#lblGinger').textContent = STRINGS[lang].ginger;
  $('#lblCardamom').textContent = STRINGS[lang].cardamom;
  $('#lblHeavy').textContent = STRINGS[lang].heavy;
  $('#lblLight').textContent = STRINGS[lang].light;
  $('#lblBalanced').textContent = STRINGS[lang].balanced;
  $('#backBtn').textContent = lang==='ar' ? 'رجوع' : 'Back';
  $('#addBtn').textContent = lang==='ar' ? 'إضافة للسلة' : 'Add to Cart';
  document.querySelector('#lblSugarExternal').textContent = STRINGS[lang].sugar_external;
  document.querySelector('#lblSugarNone').textContent = STRINGS[lang].sugar_none;
  document.querySelector('#lblSugarLess').textContent = STRINGS[lang].sugar_less;
  document.querySelector('#lblSugarNormal').textContent = STRINGS[lang].sugar_normal;
  document.querySelector('#lblWaterCold').textContent = STRINGS[lang].water_cold;
  document.querySelector('#lblWaterRoom').textContent = STRINGS[lang].water_room;
}

function openProduct(it, cat){
  currentProduct = it;
  currentCat = cat || 'hot';
  $('#pImg').src = it.img || IMG_DEFAULT;
  $('#pName').textContent = (lang==='ar'?it.ar:it.en);
  $('#pPrice').innerHTML = priceHTML(it.price);
  $('#pCal').textContent = `${it.cal} ${STRINGS[lang].kcal}`;
  $('#pDesc').textContent = it['desc_'+lang] || autoDesc(it);
  $('#pQty').textContent = '1';
  updateCustomizationLabels();

  // reset radios
  document.querySelectorAll('input[name="sugar"]').forEach(r=> r.checked = (r.value==='external'));
  document.querySelectorAll('input[name="waterTemp"]').forEach(r=> r.checked = (r.value==='cold'));
  $('#optLessIce').checked = false;
  $('#optGinger').checked = false;
  $('#optCardamom').checked = false;
  document.querySelectorAll('input[name="strength"]').forEach(r=> r.checked = (r.value==='balanced'));

  // visibility
  const water = isWater(it);
  const jab = isJabana(it);

  document.getElementById('wrapLessIce').style.display = (currentCat==='cold' && !water) ? 'inline-flex' : 'none';
  document.getElementById('sugarGroup').style.display = (currentCat!=='dessert' && !water) ? 'flex' : 'none';
  document.getElementById('waterTempGroup').style.display = water ? 'flex' : 'none';
  document.getElementById('customJabana').style.display = jab ? 'flex' : 'none';
  document.getElementById('strengthGroup').style.display = jab ? 'flex' : 'none';

  document.getElementById('productModal').style.display='flex';
}
function closeProduct(){ document.getElementById('productModal').style.display='none'; }
function incQty(){ let q=parseInt($('#pQty').textContent)||1; $('#pQty').textContent = Math.min(q+1,99); }
function decQty(){ let q=parseInt($('#pQty').textContent)||1; $('#pQty').textContent = Math.max(q-1,1); }

function gatherCustomization(){
  const opts = [];
  // water temp
  if(isWater(currentProduct)){
    const wt = (document.querySelector('input[name="waterTemp"]:checked')||{}).value || 'cold';
    opts.push(wt==='cold' ? STRINGS[lang].water_cold : STRINGS[lang].water_room);
    return opts;
  }
  // sugar
  if (document.getElementById('sugarGroup').style.display!=='none') {
    const sugar = (document.querySelector('input[name="sugar"]:checked')||{}).value || 'external';
    const sugarLabel = sugar==='external'?STRINGS[lang].sugar_external
                      : sugar==='none'?STRINGS[lang].sugar_none
                      : sugar==='less'?STRINGS[lang].sugar_less
                      : STRINGS[lang].sugar_normal;
    opts.push(sugarLabel);
  }
  // ice
  if($('#optLessIce').checked && currentCat==='cold') opts.push(STRINGS[lang].less_ice);
  // jabana
  if(isJabana(currentProduct)){
    if($('#optGinger').checked) opts.push(STRINGS[lang].ginger);
    if($('#optCardamom').checked) opts.push(STRINGS[lang].cardamom);
    const st = (document.querySelector('input[name="strength"]:checked')||{}).value || 'balanced';
    const stLabel = st==='heavy'?STRINGS[lang].heavy: st==='light'?STRINGS[lang].light: STRINGS[lang].balanced;
    opts.push(stLabel);
  }
  return opts;
}

function addCurrentToCart(){
  const q = parseInt($('#pQty').textContent)||1;
  const options = gatherCustomization();
  ensureTableSelection(()=>{
    addToCart(currentProduct, q, options);
    closeProduct();
    toast(STRINGS[lang].added);
  });
}

/* ===== Cart logic ===== */
function openCart(){ renderCart(); document.getElementById('cartSheet').style.display='flex'; }
function closeCart(){ document.getElementById('cartSheet').style.display='none'; }
document.getElementById('cartFab').addEventListener('click', openCart);

function addToCart(it, qty=1, options=[]){
  const key = (it.en||it.ar) + '|' + (options.join(',') || '-');
  const idx = cart.findIndex(x=>x.key===key);
  if(idx>-1){ cart[idx].qty += qty; }
  else{
    cart.push({ key, name_ar:it.ar, name_en:it.en, price:it.price, cal:it.cal, img:it.img||IMG_DEFAULT, qty, options });
  }
  saveCart(); updateCartBadge();
}
function changeQty(key, delta){
  const i = cart.findIndex(x=>x.key===key);
  if(i>-1){
    cart[i].qty += delta;
    if(cart[i].qty<=0) cart.splice(i,1);
    saveCart(); renderCart(); updateCartBadge();
  }
}
function clearCart(){ cart = []; saveCart(); renderCart(); updateCartBadge(); }

function renderCart(){
  const wrap = $('#cartItems');
  wrap.innerHTML = '';
  if(cart.length===0){
    $('#emptyText').style.display='block';
  } else {
    $('#emptyText').style.display='none';
    cart.forEach(it=>{
      const name = (lang==='ar'?it.name_ar:it.name_en);
      const optsText = (it.options && it.options.length) ? ' • ' + it.options.join('؛ ') : '';
      wrap.insertAdjacentHTML('beforeend', `
        <div class="cart-item">
          <div class="thumb"><img src="${it.img}" alt="${name}"></div>
          <div>
            <div class="title">${name}</div>
            <div class="meta">${it.cal} ${STRINGS[lang].kcal}${optsText}</div>
            <div class="price" style="margin-top:4px">
              ${priceHTML(it.price)}
            </div>
          </div>
          <div class="qty">
            <button onclick="changeQty('${it.key.replace(/'/g,"&#39;")}',-1)">−</button>
            <span style="min-width:24px;text-align:center">${it.qty}</span>
            <button onclick="changeQty('${it.key.replace(/'/g,"&#39;")}',+1)">+</button>
          </div>
        </div>
      `);
    });
  }
  const subtotal = cartTotal();
  const loyaltyCalc = calculateLoyaltyRewards(cart);
  const loyaltyDiscount = loyaltyCalc.discount;
  const loyaltyRewards = loyaltyCalc.rewards;
  const total = Math.max(subtotal - loyaltyDiscount, 0);
  $('#cartTotal').innerHTML = priceHTML(total);
  const loyaltyNoteEl = document.getElementById('cartLoyaltyNote');
  if(loyaltyNoteEl){
    if(loyaltyDiscount > 0 && loyaltyRewards.length){
      const currency = lang==='ar'?'ريال':'SAR';
      const parts = loyaltyRewards.map(reward=>{
        const drink = lang==='ar' ? (reward.drink_ar || reward.drink_en || '') : (reward.drink_en || reward.drink_ar || '');
        const qty = reward.freebies || 1;
        const discount = Number(reward.discount) || 0;
        return `${drink} ×${qty} (−${discount} ${currency})`;
      });
      loyaltyNoteEl.innerHTML = `🎁 ${STRINGS[lang].loyalty_reward_label}: ${parts.join(' • ')}`;
      loyaltyNoteEl.style.display = 'block';
    } else {
      loyaltyNoteEl.style.display = 'none';
      loyaltyNoteEl.textContent = '';
    }
  }
  const discountInputEl = document.getElementById('discountInput');
  if(discountInputEl && discountInputEl !== document.activeElement){
    discountInputEl.value = currentDiscountCode;
  }
}

const discountInputEl = document.getElementById('discountInput');
if(discountInputEl){
  discountInputEl.addEventListener('input', ()=>{
    currentDiscountCode = discountInputEl.value.trim();
  });
}

function resetDiscountCode(){
  currentDiscountCode = '';
  if(discountInputEl) discountInputEl.value = '';
}

function calculateLoyaltyRewards(cartItems){
  const rewards = [];
  let totalDiscount = 0;
  (cartItems || []).forEach(it=>{
    if(!it) return;
    const key = (it.name_en || it.name_ar || '').toLowerCase();
    if(!key) return;
    const record = loyaltyState[key] || { count:0, rewardLevel:0, drink_ar: it.name_ar || '', drink_en: it.name_en || '' };
    const startCount = Number(record.count) || 0;
    const qty = Number(it.qty) || 0;
    if(!qty) return;
    const freebies = Math.floor((startCount + qty) / 5) - Math.floor(startCount / 5);
    if(freebies > 0){
      const price = Number(it.price) || 0;
      const discount = freebies * price;
      totalDiscount += discount;
      rewards.push({
        key,
        freebies,
        discount,
        drink_ar: it.name_ar || record.drink_ar || '',
        drink_en: it.name_en || record.drink_en || ''
      });
    }
  });
  return { rewards, discount: totalDiscount };
}

function handleLoyaltyRewards(entry){
  if(!entry || !Array.isArray(entry.items)) return;
  let rewardInfo = null;
  entry.items.forEach(it=>{
    const key = ((it && (it.name_en || it.name_ar)) || '').toLowerCase();
    if(!key) return;
    const qty = Number(it && it.qty) || 1;
    const record = loyaltyState[key] || { count:0, rewardLevel:0, drink_ar: it.name_ar || '', drink_en: it.name_en || '' };
    record.count += qty;
    if(it.name_ar) record.drink_ar = it.name_ar;
    if(it.name_en) record.drink_en = it.name_en;
    const milestone = Math.floor(record.count / 5);
    if(milestone > (record.rewardLevel || 0) && !rewardInfo){
      rewardInfo = { drink_ar: record.drink_ar, drink_en: record.drink_en };
    }
    record.rewardLevel = Math.max(record.rewardLevel || 0, milestone);
    loyaltyState[key] = record;
  });
  saveLoyaltyState();
  if(rewardInfo) showLoyaltyModal(rewardInfo);
}

/* ===== Send order to Telegram ===== */
function performSendOrder(tableIdOverride){
  const stamp = buildTimestampInfo();
  const tableId = tableIdOverride || getCurrentTableValue() || '?';
  const itemLines = cart.map(it=>{
    const n = it.name_ar || it.name_en || '';
    const opt = (it.options && it.options.length) ? ` (${it.options.join('، ')})` : '';
    return `• ${n}${opt} ×${it.qty} — ${it.qty * it.price} ريال`;
  });
  const subtotal = cartTotal();
  const loyaltyCalc = calculateLoyaltyRewards(cart);
  const loyaltyDiscount = loyaltyCalc.discount;
  const loyaltyRewards = loyaltyCalc.rewards;
  const total = Math.max(subtotal - loyaltyDiscount, 0);
  const headerLine = `🧾 طلب جديد — طاولة ${tableId}`;
  const orderId = `N${stamp.now.getTime().toString(36).toUpperCase()}`;
  const orderIdLine = `🆔 ${STRINGS.ar.order_id_label}: ${orderId}`;
  const timeLine = `⏰ ${STRINGS.ar.order_time_label}: ${stamp.date} — ${stamp.time}`;
  const discountCode = currentDiscountCode.trim();
  const messageLines = [
    headerLine,
    orderIdLine,
    timeLine,
    '📋 تفاصيل الطلب:',
    ...itemLines
  ];
  if(loyaltyRewards.length){
    loyaltyRewards.forEach(reward=>{
      const drinkAr = reward.drink_ar || reward.drink_en || '';
      messageLines.push(`🎁 ${STRINGS.ar.loyalty_reward_label}: ${drinkAr} مجاني`);
    });
  }
  if(loyaltyDiscount > 0){
    messageLines.push(`💝 ${STRINGS.ar.loyalty_discount_label}: -${loyaltyDiscount} ريال`);
  }
  if(discountCode){
    messageLines.push(`🎟️ ${STRINGS.ar.discount_code_label}: ${discountCode}`);
  }
  const customerNameValue = customerProfile && customerProfile.name ? customerProfile.name : '';
  const customerPhoneValue = customerProfile && customerProfile.phone ? customerProfile.phone : '';
  if(customerNameValue){
    messageLines.push(`👤 ${STRINGS.ar.customer_name_label}: ${customerNameValue}`);
  }
  if(customerPhoneValue){
    messageLines.push(`📞 ${STRINGS.ar.customer_phone_label}: ${customerPhoneValue}`);
  }
  messageLines.push(`💵 ${STRINGS.ar.total_due_label || 'الإجمالي المستحق'}: ${total} ريال`);
  const text = messageLines.map(encodeURIComponent).join('%0A%0A');

  const orderEntry = {
    id: orderId,
    orderId,
    table: tableId,
    subtotal,
    loyaltyDiscount,
    total,
    timestamp: stamp.now.getTime(),
    discountCode,
    customer: {
      id: getActiveCustomerId(),
      name: customerNameValue || '',
      phone: customerPhoneValue || ''
    },
    loyaltyRewards,
    items: cart.map(it=>({
      name_ar: it.name_ar,
      name_en: it.name_en,
      qty: it.qty,
      price: it.price,
      options: Array.isArray(it.options) ? it.options : []
    }))
  };

  const statusBase = new URL('order-status.html', window.location.href);
  statusBase.search = '';
  statusBase.searchParams.set('order', orderId);
  statusBase.searchParams.set('table', tableId);
  statusBase.searchParams.set('issued', String(stamp.now.getTime()));
  statusBase.searchParams.set('chat', TELEGRAM_CHAT_ID_NEW);
  const acceptUrl = new URL(statusBase.toString());
  acceptUrl.searchParams.set('action', 'accept');

  const replyMarkup = encodeURIComponent(JSON.stringify({
    inline_keyboard: [
      [{ text: '✅ قبول الطلب', url: acceptUrl.toString() }]
    ]
  }));

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID_NEW}&text=${text}&reply_markup=${replyMarkup}`;
  fetch(url)
    .then(res=>{
      if(!res.ok) throw new Error('telegram');
      recordOrderLog(orderEntry);
      handleLoyaltyRewards(orderEntry);
      toast(STRINGS[lang].order_sent_saved);
      clearCart();
      resetDiscountCode();
      closeCart();
    })
    .catch(()=> { toast(STRINGS[lang].order_send_failed); });
}

function sendOrder(){
  if(cart.length===0){ toast(lang==='ar'?'السلة فارغة':'Cart is empty'); return; }
  ensureTableSelection((tableId)=>{
    performSendOrder(tableId);
  }, { restoreCart: isCartOpen() });
}

/* ===== Toast ===== */
function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.bottom='86px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
  t.style.padding='12px 20px'; t.style.borderRadius='12px'; t.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';
  t.style.zIndex='400'; t.style.opacity='0'; t.style.transition='opacity .3s ease';
  t.style.background = document.body.classList.contains('dark') ? 'var(--brand-dark)' : 'var(--brand)';
  t.style.color = '#fff';
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity='1', 20);
  setTimeout(()=> { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 2500);
}

/* ===== Init ===== */
function init(){
  localStorage.removeItem('nima.table');
  if(customerProfile && (customerProfile.name || customerProfile.phone)){
    if(!customerProfile.id){
      customerProfile.id = generateCustomerId(customerProfile.name || '', customerProfile.phone || '');
      saveCustomerProfileData(customerProfile);
    }
    ensureCustomerRegistryEntry(customerProfile.id, customerProfile);
    ensureCustomerLog(customerProfile.id, customerProfile);
  }
  renderAll(); updateLangBtn(); updateCartBadge();
  if(customerProfile && (customerProfile.name || customerProfile.phone)){
    maybeToastGreeting();
  } else {
    setTimeout(()=> openProfileModal(false), 900);
  }
}
init();
  </script>
</body>
</html>
