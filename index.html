<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù†ÙŠÙˆ Ù†ÙŠÙ…Ø© | Neema Menu</title>
  <style>
/* Theme */
:root{
  --brand:#8b5e3c; --brand-2:#d4a373; --brand-dark:#70492d;
  --bg:#faf8f6; --card:#ffffff; --text:#1f1f1f; --muted:#6b6b6b; --border:#e9e6e3;
  --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.08);
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text);}
body.dark{ --bg:#0f0f0f; --card:#1a1a1a; --text:#f3f3f3; --muted:#b7b7b7; --border:#2a2a2a; }

/* Header */
header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
body.dark header{background:rgba(20,20,20,.82)}
.wrap{max-width:960px;margin-inline:auto;padding:12px 14px}
.top{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px;flex:1 1 auto;min-width:220px}
.brand-text{display:flex;flex-direction:column;gap:4px;min-width:0;align-items:flex-start}
.brand img{width:48px;height:48px;border-radius:12px;border:1px solid var(--border);background:#fff;object-fit:contain}
.brand h1{font-size:18px;margin:0;line-height:1.2}

.header-side{display:flex;flex-direction:column;gap:10px;align-items:flex-end;flex:1 1 auto;min-width:260px}
.actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;font-size:14px;cursor:pointer}
.btn.small{padding:6px 8px;font-size:12px}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.ghost{background:transparent}
.greeting{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;text-align:right;width:100%}
.greeting span{font-size:13px;color:var(--muted)}
.greeting .welcome-name{font-weight:700;color:var(--brand)}

@media(max-width:680px){
  .top{flex-direction:column;align-items:stretch;gap:14px}
  .brand{justify-content:center;text-align:center}
  .brand-text{align-items:center}
  .header-side{align-items:stretch;gap:12px;min-width:0}
  .greeting{justify-content:space-between;text-align:inherit}
  .actions{justify-content:space-between}
  .actions .btn{flex:1 1 0;min-width:110px}
}

/* Search */
.search{display:flex;gap:8px;margin:10px 0 8px}
.search input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:15px}

.promo-banner{display:none;flex-direction:column;gap:10px;margin:12px 0;padding:14px;border-radius:16px;border:1px dashed var(--border);background:rgba(139,94,60,.06)}
.promo-banner h3{margin:0;font-size:15px;color:var(--brand)}
.promo-banner .promo-item{border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:6px;background:var(--card)}
.promo-banner .promo-title{font-weight:700}
.promo-banner .promo-dates{font-size:12px;color:var(--muted)}
body.dark .promo-banner{background:rgba(212,163,115,.12)}


/* Sections */
main{max-width:960px;margin-inline:auto;padding:10px 14px 120px}
details{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin:10px 0}
summary{list-style:none;padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:10px;font-weight:700}
summary::marker{display:none}
.pill{display:inline-block;background:#efe6de;color:#5a3a22;border-radius:999px;padding:3px 8px;font-size:12px;margin-inline-start:6px}
body.dark .pill{background:#2b221b;color:#d9c3ad}

.grid{display:grid;grid-template-columns:1fr;gap:10px;padding:8px 12px 14px}
@media(min-width:520px){.grid{grid-template-columns:repeat(2,1fr)}}

.item{display:grid;grid-template-columns:72px 1fr;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;cursor:pointer}
.item:hover{box-shadow:0 6px 18px rgba(0,0,0,.06)}
.thumb{width:72px;height:72px;border-radius:12px;overflow:hidden;border:1px solid var(--border);background:#fafafa}
.thumb img{width:100%;height:100%;object-fit:contain;background:#fafafa}
.line{display:flex;align-items:center;gap:8px}
.name{font-weight:700}
.dots{flex:1 1 auto;border-bottom:1px dotted #c9c3bd;transform:translateY(-4px);opacity:.6}
.price{font-weight:800;color:var(--brand)}
.sub{font-size:12px;color:var(--muted)}
.cals{font-size:12px;color:#888;margin-top:2px}

/* SAR symbol (SVG mask) */
.price .sar {
  display:inline-block; width:1.05em; height:1em; margin-inline-start:.25em;
  background-color: currentColor;
  -webkit-mask: url("https://upload.wikimedia.org/wikipedia/commons/9/98/Saudi_Riyal_Symbol.svg") no-repeat center / contain;
  mask: url("https://upload.wikimedia.org/wikipedia/commons/9/98/Saudi_Riyal_Symbol.svg") no-repeat center / contain;
  vertical-align:-0.1em;
}
.price .sar-fallback{display:none;}
@supports not (mask: url("")) {
  .price .sar{display:none;}
  .price .sar-fallback{display:inline; font-weight:700; margin-inline-start:.25em;}
}

/* Bottom bar */
.bar{position:fixed;bottom:0;left:0;right:0;z-index:25;background:var(--card);border-top:1px solid var(--border);padding:10px}
.bar .inner{max-width:960px;margin-inline:auto;display:flex;gap:8px}
select, .bar .inner .btn{flex:1}

footer{color:var(--muted);text-align:center;margin:18px 0 120px;display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap}
.dash-link{display:inline-flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:50%;border:1px solid var(--border);background:var(--card);color:var(--brand);font-weight:700;font-size:18px;transition:transform .2s,box-shadow .2s}
.dash-link:focus-visible{outline:3px solid rgba(139,94,60,.35);outline-offset:3px}
.dash-link:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.08)}
body.dark .dash-link{color:var(--brand-2)}
body.dark .dash-link:focus-visible{outline-color:rgba(212,163,115,.5)}

/* -------- Product Modal -------- */
.modal, .cart{position:fixed;inset:0;display:none;z-index:300;align-items:flex-end;justify-content:center}
.modal .backdrop, .cart .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
.sheet{
  position:relative;background:var(--card);color:var(--text);
  width:100%;max-width:560px;max-height:88vh;overflow:auto;
  border-top-left-radius:18px;border-top-right-radius:18px;
  box-shadow:var(--shadow);padding:14px
}
.sheet .row{display:flex;gap:12px}
.sheet .bigimg{width:120px;height:120px;border-radius:14px;border:1px solid var(--border);overflow:hidden;background:#fafafa;flex:0 0 auto}
.sheet .bigimg img{width:100%;height:100%;object-fit:contain}
.sheet h3{margin:6px 0 4px}
.sheet .desc{color:var(--muted);font-size:14px;line-height:1.6}
.qty{display:flex;align-items:center;gap:10px;margin-top:8px}
.qty button{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer}
.sheet .line{margin-top:6px}
.sheet .actions{display:flex;gap:8px;margin-top:12px}
.sheet .actions .btn{flex:1}

/* Customization section */
.custom{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
.custom h4{margin:0 0 8px;font-size:14px;color:var(--muted)}
.variant-group{display:flex;flex-direction:column;gap:8px;margin:8px 0;padding:10px;border:1px solid var(--border);border-radius:12px;background:rgba(139,94,60,.05)}
body.dark .variant-group{background:rgba(139,94,60,.12)}
.variant-group h5{margin:0;font-size:13px;color:var(--text)}
.variant-group .variant-note{margin:0;font-size:12px;color:var(--muted)}
.variant-options{display:flex;flex-direction:column;gap:6px}
.variant-btn{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;font-size:13px;cursor:pointer;text-align:start;transition:border-color .2s,box-shadow .2s}
.variant-btn .label{font-weight:600}
.variant-btn .meta{font-size:12px;color:var(--muted)}
.variant-btn.selected{border-color:var(--brand);box-shadow:0 0 0 2px rgba(139,94,60,.15)}
body.dark .variant-btn.selected{box-shadow:0 0 0 2px rgba(212,163,115,.25)}
.custom .opts{display:flex;flex-wrap:wrap;gap:8px}
.custom label{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:var(--card);cursor:pointer;font-size:13px}
.custom .radios{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

/* -------- Floating Cart Button -------- */
.fab{
  position:fixed; right:16px; bottom:86px; z-index:260;
  background:var(--brand); color:#fff; border:none; border-radius:999px;
  padding:12px 16px; box-shadow:0 10px 24px rgba(0,0,0,.18); cursor:pointer; display:flex; align-items:center; gap:8px
}
.fab .count{background:#fff;color:var(--brand);border-radius:999px;padding:2px 8px;font-weight:800}

/* -------- Cart Sheet -------- */
.cart .sheet h3{margin:0 0 10px}
.cart-item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:8px;margin:6px 0}
.cart-item .thumb{width:56px;height:56px;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
.cart-item .thumb img{width:100%;height:100%;object-fit:cover}
.cart-item .title{font-weight:700}
.cart-item .meta{font-size:12px;color:var(--muted)}
.cart-item .qty{justify-content:flex-end}
.cart .summary{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-weight:800}
.cart .loyalty-summary{margin-top:6px;font-size:13px;color:var(--brand);font-weight:600}
.cart .actions{display:flex;gap:8px;margin-top:12px}
.cart .discount{display:flex;flex-direction:column;gap:6px;margin-top:12px}
.cart .discount label{font-size:13px;color:var(--muted)}
.cart .discount input{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px}
.empty{color:var(--muted);text-align:center;margin:12px 0}

/* -------- Table Modal -------- */
.table-modal{align-items:center}
.table-modal .sheet{max-width:420px;border-radius:18px;max-height:80vh;text-align:center;padding:18px}
.table-modal .sheet h3{margin:4px 0 10px}
.table-modal .sheet p{margin:0 0 16px;color:var(--muted);font-size:14px;line-height:1.6}
.table-modal .sheet select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:15px}
.table-modal .sheet .note{margin:4px 0 14px;color:var(--muted);font-size:13px;line-height:1.5}
.table-modal .sheet .actions{margin-top:16px}
.table-modal .sheet .error{color:#c0392b;font-size:13px;margin-top:10px;display:none}
body.dark .table-modal .sheet .error{color:#e57373}

/* -------- Profile Modal -------- */
.profile-modal{align-items:center}
.profile-modal .sheet{max-width:420px;border-radius:18px;max-height:80vh;text-align:start;padding:18px;display:flex;flex-direction:column;gap:12px}
.profile-modal .sheet h3{margin:0}
.profile-modal .sheet p{margin:0;color:var(--muted);font-size:14px;line-height:1.6}
.profile-modal .sheet label{font-size:13px;color:var(--muted)}
.profile-modal .sheet input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px}
.profile-modal .sheet .note{font-size:12px;color:var(--muted);margin-top:-4px}
.profile-modal .sheet .actions{display:flex;gap:8px;margin-top:4px}

/* -------- Loyalty Modal -------- */
.loyalty-modal{align-items:center}
.loyalty-modal .sheet{max-width:420px;border-radius:18px;max-height:80vh;text-align:center;padding:22px;display:flex;flex-direction:column;gap:14px}
.loyalty-modal .sheet h3{margin:0}
.loyalty-modal .sheet p{margin:0;font-size:14px;line-height:1.6;color:var(--muted)}
.loyalty-modal .sheet strong{color:var(--brand);font-size:16px}
.loyalty-modal .sheet .actions{display:flex;justify-content:center}

/* -------- Order Log Modal -------- */
.log-modal{align-items:center}
.log-modal .sheet{max-width:520px;border-radius:18px;max-height:82vh;padding:18px;display:flex;flex-direction:column;gap:12px}
.log-modal .sheet h3{margin:0}
.log-modal .sheet p{margin:0;color:var(--muted);font-size:14px;line-height:1.6}
.log-modal .sheet .log-empty{color:var(--muted);text-align:center;padding:22px 0;font-size:14px}
.log-modal .sheet .log-list{flex:1 1 auto;overflow:auto;display:flex;flex-direction:column;gap:12px;padding:2px}
.log-entry{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--card);box-shadow:0 6px 16px rgba(0,0,0,.04)}
.log-entry h4{margin:0;font-size:15px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.log-entry h4 .total{font-weight:800;color:var(--brand)}
.log-entry .meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;flex-wrap:wrap;gap:8px}
.log-entry .items{margin:10px 0 0;padding-inline-start:20px;font-size:13px;color:var(--text)}
.log-entry .items li{margin-bottom:4px;line-height:1.5}
.log-entry .loyalty-note{margin-top:8px;font-size:12px;color:var(--brand);font-weight:600}
.log-modal .sheet .actions{margin-top:6px;display:flex;gap:8px}

  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <img src="https://i.postimg.cc/g0g9RwM0/Untitled-design-9.png" alt="Neema Menu">
          <div class="brand-text">
            <h1 id="title">Ù…Ù†ÙŠÙˆ Ù†ÙŠÙ…Ø©</h1>
            <span class="pill" id="tagline">Ù…Ø°Ø§Ù‚ ÙŠÙ†Ø¨Øª Ù…Ù† Ø§Ù„Ø¬Ø°ÙˆØ±</span>
          </div>
        </div>
        <div class="header-side">
          <div class="greeting" id="greetingBar">
            <span id="greetingText">Ù…Ø±Ø­Ø¨Ø§ Ø¶ÙŠÙÙ†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²</span>
            <button class="btn ghost small" id="profileBtn">ğŸ‘¤ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          </div>
          <div class="actions">
            <button class="btn ghost" id="orderLogBtn">ğŸ“œ <span id="orderLogBtnLabel">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></button>
            <button class="btn" id="langBtn">E</button>
            <button class="btn" id="modeBtn">ğŸŒ™</button>
          </div>
        </div>
      </div>
      <div class="search">
        <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØµÙ†Ùâ€¦ (Ù…Ø«Ø§Ù„: Ù„Ø§ØªÙŠÙ‡ØŒ Ù…ÙˆÙ‡ÙŠØªÙˆ)">
      </div>
      <div class="promo-banner" id="promoBanner">
        <h3 id="promoBannerTitle" data-i18n="promo_banner_title">ğŸ Ø¹Ø±ÙˆØ¶ Ù†ÙŠÙ…Ø©</h3>
        <div id="promoBannerItems"></div>
      </div>
    </div>
  </header>

  <main>
    <details open>
      <summary>ğŸ”¥ <span data-i18n="hot_drinks">Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø³Ø§Ø®Ù†Ø©</span></summary>
      <div class="grid" id="hot-coffee"></div>
      <div class="grid" id="hot-tea"></div>
    </details>

    <details>
      <summary>â„ï¸ <span data-i18n="cold_drinks">Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø¨Ø§Ø±Ø¯Ø©</span></summary>
      <div class="grid" id="cold-coffee"></div>
      <div class="grid" id="cold-mojito"></div>
      <div class="grid" id="cold-other"></div>
    </details>

    <details>
      <summary>ğŸ° <span data-i18n="dessert">Ø§Ù„Ø­Ù„Ø§</span></summary>
      <div class="grid" id="dessert-cake"></div>
      <div class="grid" id="dessert-side"></div>
    </details>

    <footer>
      <div id="foot">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ù†ÙŠÙ…Ø© ÙƒØ§ÙÙŠÙ‡ Â©</div>
      <a class="dash-link" href="/admin/" id="dashboardShortcut" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">D</a>
    </footer>
  </main>

  <!-- Floating Cart Button -->
  <button class="fab" id="cartFab">ğŸ›’ <span data-i18n="cart">Ø§Ù„Ø³Ù„Ø©</span> <span class="count" id="cartCount">0</span></button>

  <!-- Product Modal -->
  <div class="modal" id="productModal" aria-hidden="true">
    <div class="backdrop" onclick="closeProduct()"></div>
    <div class="sheet">
      <div class="row">
        <div class="bigimg"><img id="pImg" alt=""></div>
        <div style="flex:1">
          <h3 id="pName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</h3>
          <div class="line">
            <span class="price" id="pPrice">0
              <span class="sar" aria-label="Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ"></span>
              <span class="sar-fallback">Ø±ÙŠØ§Ù„</span>
            </span>
            <span class="cals" id="pCal">0 Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©</span>
          </div>
        </div>
      </div>

      <p class="desc" id="pDesc"></p>

      <!-- Customization -->
      <div class="custom">
        <h4 id="customTitle">Ø§Ù„ØªØ®ØµÙŠØµ</h4>

        <!-- Variant options -->
        <div class="variant-group" id="variantGroup" style="display:none">
          <h5 id="variantHeading">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙƒÙ‡Ø©</h5>
          <p class="variant-note" id="variantNote"></p>
          <div class="variant-options" id="variantOptions"></div>
        </div>

        <!-- Sugar options -->
        <div class="radios" id="sugarGroup">
          <label id="sugarExternalOption"><input type="radio" name="sugar" value="external" checked> <span id="lblSugarExternal">Ø³ÙƒØ± Ø®Ø§Ø±Ø¬ÙŠ</span></label>
          <label><input type="radio" name="sugar" value="none"> <span id="lblSugarNone">Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±</span></label>
          <label><input type="radio" name="sugar" value="less"> <span id="lblSugarLess">Ø³ÙƒØ± Ù‚Ù„ÙŠÙ„</span></label>
          <label><input type="radio" name="sugar" value="normal"> <span id="lblSugarNormal">Ø³ÙƒØ± Ø¹Ø§Ø¯ÙŠ</span></label>
        </div>

        <!-- Water temperature (water only) -->
        <div class="radios" id="waterTempGroup" style="display:none">
          <label><input type="radio" name="waterTemp" value="cold" checked> <span id="lblWaterCold">Ø¨Ø§Ø±Ø¯ (Ù…Ù† Ø§Ù„Ø«Ù„Ø§Ø¬Ø©)</span></label>
          <label><input type="radio" name="waterTemp" value="room"> <span id="lblWaterRoom">ØºÙŠØ± Ù…Ø¨Ø±Ø¯ (Ø¯Ø±Ø¬Ø© Ø§Ù„ØºØ±ÙØ©)</span></label>
        </div>

        <!-- Base opts -->
        <div class="opts" id="customBase" style="margin-top:6px">
          <label id="wrapLessIce"><input type="checkbox" id="optLessIce"> <span id="lblLessIce">Ø«Ù„Ø¬ Ø£Ù‚Ù„</span></label>
        </div>

        <!-- Jabana-only -->
        <div class="opts" id="customJabana" style="display:none">
          <label><input type="checkbox" id="optGinger"> <span id="lblGinger">Ø²Ù†Ø¬Ø¨ÙŠÙ„</span></label>
          <label><input type="checkbox" id="optCardamom"> <span id="lblCardamom">Ù‡Ø¨Ù‡Ø§Ù†</span></label>
        </div>

        <div class="radios" id="strengthGroup" style="display:none">
          <label><input type="radio" name="strength" value="heavy"> <span id="lblHeavy">Ø«Ù‚ÙŠÙ„Ø©</span></label>
          <label><input type="radio" name="strength" value="light"> <span id="lblLight">Ø®ÙÙŠÙØ©</span></label>
          <label><input type="radio" name="strength" value="balanced" checked> <span id="lblBalanced">Ù…ÙˆØ²ÙˆÙ†Ø©</span></label>
        </div>
      </div>

      <div class="qty">
        <button onclick="decQty()">âˆ’</button>
        <span id="pQty" style="min-width:24px;text-align:center">1</span>
        <button onclick="incQty()">+</button>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeProduct()" id="backBtn">Ø±Ø¬ÙˆØ¹</button>
        <button class="btn primary" onclick="addCurrentToCart()" id="addBtn">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
      </div>
    </div>
  </div>

  <!-- Cart Sheet -->
  <div class="cart" id="cartSheet" aria-hidden="true">
    <div class="backdrop" onclick="closeCart()"></div>
    <div class="sheet">
      <h3><span data-i18n="your_cart">Ø³Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙƒ</span></h3>
      <div id="cartItems"></div>
      <div class="summary">
        <div><span data-i18n="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>:</div>
        <div class="price" id="cartTotal">0 <span class="sar"></span><span class="sar-fallback">Ø±ÙŠØ§Ù„</span></div>
      </div>
      <div class="loyalty-summary" id="cartLoyaltyNote" style="display:none"></div>
      <div class="discount">
        <label for="discountInput" id="discountLabel">ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="discountInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…" autocomplete="off">
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <label for="tableCart" style="color:var(--muted)"><span data-i18n="table">Ø·Ø§ÙˆÙ„Ø©</span></label>
        <select id="tableCart" style="flex:1;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px;border-radius:10px"></select>
      </div>
      <div class="actions">
        <button class="btn" onclick="clearCart()"><span data-i18n="clear">ØªÙØ±ÙŠØº</span></button>
        <button class="btn primary" onclick="sendOrder()"><span data-i18n="send_order">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span> ğŸš€</button>
      </div>
      <div id="emptyText" class="empty" style="display:none"><span data-i18n="empty">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</span></div>
    </div>
  </div>

  <!-- Table Selection Modal -->
  <div class="modal table-modal" id="tableModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="tableModalTitle">Ø­Ø¯Ø¯ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</h3>
      <p id="tableModalDesc">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù‚Ø¨Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨.</p>
      <p class="note" id="tableModalNote">Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©.</p>
      <select id="tablePrompt"></select>
      <div class="actions">
        <button class="btn" id="tableCancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" id="tableConfirmBtn">ØªØ£ÙƒÙŠØ¯</button>
      </div>
      <div class="error" id="tablePromptError">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</div>
    </div>
  </div>

  <!-- Order Log Modal -->
  <div class="modal log-modal" id="orderLogModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="orderLogTitle">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
      <p id="orderLogDesc">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù‡Ù†Ø§ Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
      <div style="display:flex;gap:8px;align-items:center">
        <label for="orderLogCustomerSelect" id="orderLogCustomerLabel" style="font-size:13px;color:var(--muted)">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <select id="orderLogCustomerSelect" style="flex:1;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px;border-radius:10px"></select>
      </div>
      <div class="log-empty" id="orderLogEmpty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.</div>
      <div class="log-list" id="orderLogList"></div>
      <div class="actions">
        <button class="btn" id="orderLogCloseBtn">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn ghost" id="orderLogClearBtn">ğŸ§¹ <span id="orderLogClearLabel">Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„</span></button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal profile-modal" id="profileModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="profileModalTitle">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h3>
      <p id="profileModalDesc">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„Ù†Ø±Ø­Ø¨ Ø¨Ùƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙƒÙ…Ø§ ØªØ­Ø¨.</p>
      <div>
        <label for="profileName" id="profileNameLabel">Ø§Ù„Ø§Ø³Ù…</label>
        <input id="profileName" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ù…ÙŠÙ„" autocomplete="name">
      </div>
      <div>
        <label for="profilePhone" id="profilePhoneLabel">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
        <input id="profilePhone" placeholder="05xxxxxxxx" inputmode="tel" autocomplete="tel">
        <div class="note" id="profileModalNote">ØªØ¸Ù‡Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙ‚Ø· Ù„Ø®Ø¯Ù…ØªÙƒÙ… Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.</div>
      </div>
      <div class="actions">
        <button class="btn" id="profileSkipBtn">Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
        <button class="btn primary" id="profileSaveBtn">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Loyalty Modal -->
  <div class="modal loyalty-modal" id="loyaltyModal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="loyaltyTitle">Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ù…Ù…ÙŠØ²</h3>
      <p id="loyaltyMessage">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù…Ø´Ø±ÙˆØ¨Ù†Ø§ Ø§Ù„Ù…ÙØ¶Ù„.</p>
      <div class="actions">
        <button class="btn primary" id="loyaltyCloseBtn">ØªÙ…Ø§Ù…</button>
      </div>
    </div>
  </div>

  <div class="bar">
    <div class="inner">
      <select id="table"></select>
      <button class="btn primary" id="callBtn">ğŸ”” <span data-i18n="call_waiter">Ø·Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¯Ù„</span></button>
    </div>
  </div>

  <script src="menu-data.js"></script>
  <script>
/* ===== Telegram (Ø§Ø®ØªØ¨Ø§Ø±) ===== */
const TELEGRAM_BOT_TOKEN = '8234122453:AAGmkEFETh1yuXzgDHChoTu0YFuD0BeVK8c';
const TELEGRAM_CHAT_ID_NEW = '5828433542';

/* ===== Lang & Strings ===== */
let lang = localStorage.getItem('nima.lang') || 'ar';

const STRINGS = {
  ar: {
    title:'Ù…Ù†ÙŠÙˆ Ù†ÙŠÙ…Ø©', tagline:'Ù…Ø°Ø§Ù‚ ÙŠÙ†Ø¨Øª Ù…Ù† Ø§Ù„Ø¬Ø°ÙˆØ±', search:'Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØµÙ†Ùâ€¦ (Ù…Ø«Ø§Ù„: Ù„Ø§ØªÙŠÙ‡ØŒ Ù…ÙˆÙ‡ÙŠØªÙˆ)',
    hot_drinks:'Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø³Ø§Ø®Ù†Ø©', cold_drinks:'Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø¨Ø§Ø±Ø¯Ø©', dessert:'Ø§Ù„Ø­Ù„Ø§',
    call_waiter:'Ø·Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¯Ù„', table:'Ø·Ø§ÙˆÙ„Ø©', footer:'Â© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ù†ÙŠÙ…Ø© ÙƒØ§ÙÙŠÙ‡',
    promo_banner_title:'ğŸ Ø¹Ø±ÙˆØ¶ Ù†ÙŠÙ…Ø©', promo_banner_empty:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.',
    promo_active_label:'Ø¹Ø±Ø¶ Ù†Ø´Ø·', promo_inactive_label:'Ù…Ù†ØªÙ‡ÙŠ',
    promo_valid_range:'Ø³Ø§Ø±ÙŠ Ù…Ù† {start} Ø¥Ù„Ù‰ {end}', promo_valid_single:'Ø³Ø§Ø±ÙŠ Ø§Ù„ÙŠÙˆÙ…',
    customers_empty:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.',
    dashboard_shortcut_title:'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
    cart:'Ø§Ù„Ø³Ù„Ø©', your_cart:'Ø³Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙƒ', total:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', send_order:'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', clear:'ØªÙØ±ÙŠØº', empty:'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©',
    added:'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©', qty:'Ø§Ù„ÙƒÙ…ÙŠØ©', add_to_cart:'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©',
    kcal:'Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©', sar_label:'Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ', back:'Ø±Ø¬ÙˆØ¹',
    waiter_toast:'ğŸ”” Ø³ÙˆÙ ÙŠØ£ØªÙŠ Ø¥Ù„ÙŠÙƒ Ø§Ù„Ù†Ø§Ø¯Ù„ Ù„Ø®Ø¯Ù…ØªÙƒ ÙÙˆØ±Ø§Ù‹!',
    order_log_button:'Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª', order_log_title:'Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
    order_log_desc:'ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù‡Ù†Ø§ Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.',
    order_log_empty:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯.',
    order_log_empty_customer:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯.',
    order_log_customer_label:'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„',
    order_log_guest:'Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¶ÙŠÙˆÙ',
    clear_log:'Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„', clear_log_confirm:'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ',
    order_sent_saved:'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ… â€” Ø­ÙÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„.',
    order_send_failed:'ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âŒ',
    customize:'Ø§Ù„ØªØ®ØµÙŠØµ', less_ice:'Ø«Ù„Ø¬ Ø£Ù‚Ù„',
    ginger:'Ø²Ù†Ø¬Ø¨ÙŠÙ„', cardamom:'Ù‡Ø¨Ù‡Ø§Ù†',
    strength:'Ø§Ù„Ù‚ÙˆØ©', heavy:'Ø«Ù‚ÙŠÙ„Ø©', light:'Ø®ÙÙŠÙØ©', balanced:'Ù…ÙˆØ²ÙˆÙ†Ø©',
    sugar_external:'Ø³ÙƒØ± Ø®Ø§Ø±Ø¬ÙŠ', sugar_none:'Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±', sugar_less:'Ø³ÙƒØ± Ù‚Ù„ÙŠÙ„', sugar_normal:'Ø³ÙƒØ± Ø¹Ø§Ø¯ÙŠ',
    water_cold:'Ø¨Ø§Ø±Ø¯ (Ù…Ù† Ø§Ù„Ø«Ù„Ø§Ø¬Ø©)', water_room:'ØºÙŠØ± Ù…Ø¨Ø±Ø¯ (Ø¯Ø±Ø¬Ø© Ø§Ù„ØºØ±ÙØ©)',
    kcal_unknown:'ØºÙŠØ± Ù…ØªÙˆÙØ±',
    variant_heading:'Ø§Ø®ØªØ± Ø§Ù„Ù†ÙƒÙ‡Ø©',
    variant_note:'Ø§Ø®ØªØ± Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù†ÙƒÙ‡Ø§Øª Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø³Ø¹Ø± Ø³ÙÙ† Ø¢Ø¨ Ø¸Ø§Ù‡Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹).',
    variant_selected:'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± {variant}.',
    variant_default_tag:' (Ø§ÙØªØ±Ø§Ø¶ÙŠ)',
    variant_required:'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙƒÙ‡Ø© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨.',
    select_table:'Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©',
    table_modal_title:'Ø­Ø¯Ø¯ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©',
    table_modal_desc:'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù‚Ø¨Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨.',
    table_modal_note:'Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©.',
    table_modal_error:'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨',
    order_time_label:'ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨', order_id_label:'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', total_due_label:'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚',
    confirm:'ØªØ£ÙƒÙŠØ¯', cancel:'Ø¥Ù„ØºØ§Ø¡',
    greeting_guest:'Ù…Ø±Ø­Ø¨Ø§ Ø¶ÙŠÙÙ†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²',
    greeting_named:'Ù…Ø±Ø­Ø¨Ø§ {name}',
    greeting_toast:'Ù…Ø±Ø­Ø¨Ø§ {name}! Ù†ÙˆØ±Øª Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØªØ­Øª Ø¸Ù„ Ø§Ù„Ù†ÙŠÙ…Ø© ğŸ¤',
    profile_button:'ğŸ‘¤ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
    profile_modal_title:'Ø¨ÙŠØ§Ù†Ø§ØªÙƒ',
    profile_modal_desc:'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„Ù†Ø±Ø­Ø¨ Ø¨Ùƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙƒÙ…Ø§ ØªØ­Ø¨.',
    profile_name_label:'Ø§Ù„Ø§Ø³Ù…',
    profile_phone_label:'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„',
    profile_name_placeholder:'Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ù…ÙŠÙ„',
    profile_phone_placeholder:'05xxxxxxxx',
    profile_note:'ØªØ¸Ù‡Ø± Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙ‚Ø· Ù„Ø®Ø¯Ù…ØªÙƒÙ… Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.',
    profile_skip:'Ù„Ø§Ø­Ù‚Ø§Ù‹',
    profile_save:'Ø­ÙØ¸',
    profile_saved:'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ ğŸ¤',
    profile_required:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.',
    discount_label:'ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
    discount_placeholder:'Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…',
    discount_code_label:'ÙƒÙˆØ¯ Ø§Ù„Ø®ØµÙ…',
    customer_name_label:'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
    customer_phone_label:'Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„',
    loyalty_title:'Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ù…Ù…ÙŠØ²',
    loyalty_message:'Ø´ÙƒØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ù„Ø¨ ÙŠØ§ {name}! Ø¨Ø¹Ø¯ {count} Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ù…ØªÙ†ÙˆØ¹Ø©ØŒ Ù…Ø´Ø±ÙˆØ¨ <strong>{drink}</strong> Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„ÙŠÙ†Ø§ Ù…Ø¬Ø§Ù†Ø§Ù‹. ØªÙØ¶Ù„ Ù„Ù„ÙƒØ§Ø´ÙŠØ± ÙˆØ³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„ØªÙ†Ø¶Ù… Ù„Ø¹Ø§Ø¦Ù„Ø© Ù†ÙŠÙ…Ø© ğŸ¤',
    loyalty_button:'ØªÙ…Ø§Ù…',
    loyalty_reward_label:'Ù‡Ø¯ÙŠØ© Ø§Ù„ÙˆÙ„Ø§Ø¡',
    loyalty_discount_label:'Ø®ØµÙ… Ø§Ù„ÙˆÙ„Ø§Ø¡',
    order_log_loyalty_reward:'Ù‡Ø¯ÙŠØ© Ø§Ù„ÙˆÙ„Ø§Ø¡'
  },
  en: {
    title:'Neema Menu', tagline:'A taste that grows from the roots', search:'Search itemâ€¦ (e.g., Latte, Mojito)',
    hot_drinks:'Hot Drinks', cold_drinks:'Cold Drinks', dessert:'Dessert',
    call_waiter:'Call Waiter', table:'Table', footer:'Â© Neema Cafe â€” All rights reserved',
    promo_banner_title:'ğŸ Neema offers', promo_banner_empty:'No live promotions at the moment.',
    promo_active_label:'Active', promo_inactive_label:'Expired',
    promo_valid_range:'Available {start} â†’ {end}', promo_valid_single:'Available today',
    customers_empty:'No customer data recorded yet.',
    dashboard_shortcut_title:'Dashboard',
    cart:'Cart', your_cart:'Your Cart', total:'Total', send_order:'Send Order', clear:'Clear', empty:'Cart is empty',
    added:'Item added to cart', qty:'Qty', add_to_cart:'Add to Cart',
    kcal:'kcal', sar_label:'Saudi Riyal', back:'Back',
    waiter_toast:'ğŸ”” A waiter is on the way!',
    order_log_button:'Order Log', order_log_title:'Order Log',
    order_log_desc:'Orders sent from this device are saved here so you can review them later.',
    order_log_empty:'No orders have been saved yet.',
    order_log_empty_customer:'No orders saved for this customer yet.',
    order_log_customer_label:'Choose customer',
    order_log_guest:'Guest orders',
    clear_log:'Clear log', clear_log_confirm:'Clear this customer\'s log?',
    order_sent_saved:'Order sent âœ… â€” Saved to log.',
    order_send_failed:'Failed to send âŒ',
    customize:'Customize', less_ice:'Less ice',
    ginger:'Ginger', cardamom:'Cardamom',
    strength:'Strength', heavy:'Strong', light:'Light', balanced:'Balanced',
    sugar_external:'Sugar on the side', sugar_none:'No sugar', sugar_less:'Less sugar', sugar_normal:'Regular sugar',
    water_cold:'Cold (chilled)', water_room:'Room temperature',
    kcal_unknown:'N/A',
    variant_heading:'Choose a flavor',
    variant_note:'Pick a flavor to continue (7up price shows by default).',
    variant_selected:'Selected: {variant}.',
    variant_default_tag:' (Default)',
    variant_required:'Please choose a flavor before adding to the cart.',
    select_table:'Select a table number',
    table_modal_title:'Choose your table',
    table_modal_desc:'Please pick a table number before continuing.',
    table_modal_note:'The table number is printed on the barcode at your table.',
    table_modal_error:'Please choose a table number to continue',
    order_time_label:'Order time', order_id_label:'Order ID', total_due_label:'Total due',
    confirm:'Confirm', cancel:'Cancel',
    greeting_guest:'Welcome, dear guest',
    greeting_named:'Hello {name}',
    greeting_toast:'Welcome back {name}! You light up Neema ğŸ¤',
    profile_button:'ğŸ‘¤ Update info',
    profile_modal_title:'Your details',
    profile_modal_desc:'Share your name and phone so we can greet you properly.',
    profile_name_label:'Name',
    profile_phone_label:'Phone',
    profile_name_placeholder:'Your name',
    profile_phone_placeholder:'+9665...',
    profile_note:'We only use this info to serve you better on orders.',
    profile_skip:'Later',
    profile_save:'Save',
    profile_saved:'Your details are saved ğŸ¤',
    profile_required:'Please enter at least a name or phone number.',
    discount_label:'Discount code (optional)',
    discount_placeholder:'Enter discount code',
    discount_code_label:'Discount code',
    customer_name_label:'Customer name',
    customer_phone_label:'Phone',
    loyalty_title:'VIP Guest',
    loyalty_message:'Thank you so much, {name}! After {count} drinks of any kind, we are gifting your <strong>{drink}</strong> today. Please see the cashier so we can welcome you into the Neema family ğŸ¤',
    loyalty_button:'Got it',
    loyalty_reward_label:'Loyalty treat',
    loyalty_discount_label:'Loyalty discount',
    order_log_loyalty_reward:'Loyalty treat'
  }
};

const SHARED = window.NEEMA_SHARED || {};
const IMG_DEFAULT = SHARED.IMG_DEFAULT || 'https://i.postimg.cc/Y0GT5M1f/image.png';
const MENU_STORAGE_KEY = 'neema.menuData.custom';

const EMPTY_MENU_DATA = {
  hot: { coffee: [], tea: [] },
  cold: { coffee: [], mojito: [], other: [] },
  dessert: { cake: [], side: [] }
};

function cloneMenu(obj){
  try{
    return JSON.parse(JSON.stringify(obj));
  }catch(err){
    console.warn('[Neema] Unable to clone menu dataset, falling back to reference copy.', err);
    return obj;
  }
}

function ensureMenuShape(menu){
  const shape = cloneMenu(EMPTY_MENU_DATA);
  const source = menu && typeof menu === 'object' ? menu : {};
  Object.keys(shape).forEach(cat=>{
    const catSource = source[cat] && typeof source[cat] === 'object' ? source[cat] : {};
    Object.keys(shape[cat]).forEach(group=>{
      const arr = catSource[group];
      shape[cat][group] = Array.isArray(arr) ? arr : [];
    });
  });
  return shape;
}

function loadMenuData(){
  let stored = null;
  try{
    stored = JSON.parse(localStorage.getItem(MENU_STORAGE_KEY) || 'null');
  }catch(err){
    console.warn('[Neema] Unable to read stored menu data â€” ignoring custom dataset.', err);
    stored = null;
  }
  if(stored && typeof stored === 'object'){
    return ensureMenuShape(stored);
  }
  if(SHARED.MENU_DATA){
    return ensureMenuShape(SHARED.MENU_DATA);
  }
  console.warn('[Neema] Shared menu data not found â€” rendering with empty menu dataset.');
  return ensureMenuShape(EMPTY_MENU_DATA);
}

const data = loadMenuData();

const ITEMS_API = '/api/items';

async function fetchItems(){
  try{
    const res = await fetch(ITEMS_API);
    if(!res.ok) throw new Error('status');
    const rows = await res.json();
    const toItem = r => ({ ar:r.name_ar, en:r.name_en, price:Number(r.price), cal:Number(r.calories||0), img:r.img_url || IMG_DEFAULT });
    const hotCoffee = rows.filter(r=>/Ù„Ø§ØªÙŠÙ‡|Ø§Ø³Ø¨Ø±ÙŠØ³Ùˆ|ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ|Ù…ÙˆÙƒØ§|ÙÙ„Ø§Øª/i.test(r.name_ar)).map(toItem);
    const hotTea    = rows.filter(r=>/Ø´Ø§ÙŠ|Ù…Ø§ØªØ´Ø§/i.test(r.name_ar)).map(toItem);
    const coldCoffee= rows.filter(r=>/Ø§ÙŠØ³|Ø¨Ø§Ø±Ø¯/i.test(r.name_ar)).map(toItem);
    const mojito    = rows.filter(r=>/Ù…ÙˆÙ‡ÙŠØªÙˆ/i.test(r.name_ar)).map(toItem);
    const otherCold = rows.filter(r=>/Ø¹ØµÙŠØ±|Ù…Ø´Ø±ÙˆØ¨/i.test(r.name_ar) && !/Ù…ÙˆÙ‡ÙŠØªÙˆ/i.test(r.name_ar)).map(toItem);
    const dessertC  = rows.filter(r=>/ÙƒÙŠÙƒ|ÙƒØ¹ÙƒØ©/i.test(r.name_ar)).map(toItem);
    const dessertS  = rows.filter(r=>/Ø­Ù„Ø§|Ù„Ù‚ÙŠÙ…Ø§Øª|ÙƒÙˆÙƒÙŠ/i.test(r.name_ar)).map(toItem);

    data.hot.coffee = hotCoffee;
    data.hot.tea = hotTea;
    data.cold.coffee = coldCoffee;
    data.cold.mojito = mojito;
    data.cold.other = otherCold;
    data.dessert.cake = dessertC;
    data.dessert.side = dessertS;
  }catch(err){
    console.warn('items api failed', err);
  }
}

async function sendOrderToDB(order){
  try{
    const res = await fetch('/api/orders', {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(order)
    });
    if(!res.ok) throw new Error('status');
    return await res.json();
  }catch(err){
    console.warn('order db sync failed', err);
    return null;
  }
}

async function afterTelegramHook(total){
  const tableId = getCurrentTableValue() || '';
  const order = {
    table_no: tableId,
    cart: cart.map(it=>({ name_ar:it.name_ar, name_en:it.name_en, qty:it.qty, price:it.price, options:it.options||[] })),
    total: total
  };
  await sendOrderToDB(order);
}

/* ===== Auto description helper ===== */
function autoDesc(it){
  const n = (it.en || it.ar || '').toLowerCase();
  const D = {
    latte: { ar:'Ø­Ù„ÙŠØ¨ Ù…Ø®Ù…Ù‘Ø± Ù…Ø¹ Ø¥Ø³Ø¨Ø±Ø³Ùˆ Ø¨Ù†ÙƒÙ‡Ø© Ù†Ø§Ø¹Ù…Ø© ÙˆÙ…ØªÙˆØ§Ø²Ù†Ø©.', en:'Silky steamed milk with espresso, smooth and balanced.' },
    cappuccino: { ar:'Ø±ØºÙˆØ© ØºÙ†ÙŠØ© ÙˆØ¥Ø³Ø¨Ø±Ø³Ùˆ Ø¨Ø·Ø§Ø¨Ø¹ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ.', en:'Classic espresso topped with rich foam.' },
    espresso: { ar:'Ø¬Ø±Ø¹Ø© Ù…Ø±ÙƒØ²Ø© Ù…Ù† Ø§Ù„Ù‚Ù‡ÙˆØ© Ø¨Ø·Ø¹Ù… Ù‚ÙˆÙŠ.', en:'A concentrated shot of bold espresso.' },
    americano: { ar:'Ø¥Ø³Ø¨Ø±Ø³Ùˆ Ù…Ø¹ Ù…Ø§Ø¡ Ø³Ø§Ø®Ù† Ø¨Ø·Ø§Ø¨Ø¹ Ø®ÙÙŠÙ.', en:'Espresso topped with hot waterâ€”clean and light.' },
    mocha: { ar:'Ù‚Ù‡ÙˆØ© Ø¨Ø§Ù„Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ© ÙˆÙƒØ±ÙŠÙ…Ø© Ù…Ø®Ù…Ù„ÙŠØ©.', en:'Chocolate-kissed coffee with a velvety finish.' },
    spanish: { ar:'Ø­Ù„Ø§ÙˆØ© Ù…ØªÙˆØ§Ø²Ù†Ø© Ù…Ø¹ Ø­Ù„ÙŠØ¨ Ù…ÙƒØ«Ù‘Ù.', en:'Balanced sweetness with condensed milk.' },
    v60: { ar:'Ø§Ø³ØªØ®Ù„Ø§Øµ ØªØ±Ø´ÙŠØ­ ÙŠØ¨Ø±Ø² Ù†ÙƒÙ‡Ø§Øª Ø§Ù„Ø¨Ù†Ù‘.', en:'Filtered extraction highlighting bean nuances.' },
    turkish: { ar:'Ù‚Ù‡ÙˆØ© Ù…Ø·Ø­ÙˆÙ†Ø© Ù†Ø§Ø¹Ù…Ø© Ø¨Ø±ØºÙˆØ© ØªÙ‚Ù„ÙŠØ¯ÙŠØ©.', en:'Finely ground, traditionally foamed coffee.' },
    flat: { ar:'Ù…Ù„Ù…Ø³ Ù…Ø®Ù…Ù„ÙŠ ÙˆÙ†ÙƒÙ‡Ø© Ù…Ø±ÙƒÙ‘Ø²Ø©.', en:'Velvety milk with a pronounced espresso body.' },
    macchiato: { ar:'Ø¥Ø³Ø¨Ø±Ø³Ùˆ Ù…Ø¹ Ù„Ù…Ø³Ø© Ø­Ù„ÙŠØ¨.', en:'Espresso stained with a touch of milk.' },
    cortado: { ar:'ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø­Ù„ÙŠØ¨ ÙˆØ§Ù„Ø¥Ø³Ø¨Ø±Ø³Ùˆ.', en:'A balance of steamed milk and espresso.' },
    matcha: { ar:'Ù…Ø§ØªØ´Ø§ ÙƒØ±ÙŠÙ…ÙŠ Ø¨Ù†ÙƒÙ‡Ø© Ø¹Ø´Ø¨ÙŠØ©.', en:'Creamy matcha with grassy notes.' },
    chocolate: { ar:'ÙƒØ§ÙƒØ§Ùˆ Ø³Ø§Ø®Ù† ØºÙ†ÙŠ.', en:'Rich hot chocolate.' },
    mojito: { ar:'Ø§Ù†ØªØ¹Ø§Ø´ Ù†Ø¹Ù†Ø¹ÙŠ Ø¨Ø­Ù…ÙˆØ¶Ø© Ù„ÙŠÙ…ÙˆÙ†.', en:'Minty refreshment with a lime twist.' },
    hibiscus: { ar:'ÙƒØ±ÙƒØ¯ÙŠÙ‡ Ø²Ù‡Ø±ÙŠ Ù…Ù†Ø¹Ø´.', en:'Floral, tart hibiscus.' },
    smoothie: { ar:'Ø³Ù…ÙˆØ°ÙŠ Ø¨Ø§Ø±Ø¯ ÙˆÙ…Ù†Ø¹Ø´.', en:'A cold, refreshing smoothie.' },
    pistachio: { ar:'Ù„Ø§ØªÙŠÙ‡ ÙØ³ØªÙ‚ ÙƒØ±ÙŠÙ…ÙŠ.', en:'Creamy pistachio latte.' },
    cake: { ar:'Ø´Ø±ÙŠØ­Ø© Ø­Ù„ÙˆÙ‰ Ø·Ø§Ø²Ø¬Ø©.', en:'Fresh sweet slice.' },
    luqaimat: { ar:'Ù„Ù‚ÙŠÙ…Ø§Øª Ø°Ù‡Ø¨ÙŠØ© Ù…Ù‚Ø±Ù…Ø´Ø©.', en:'Golden, crisp bites.' },
    water: { ar:'Ù…Ø§Ø¡ Ù†Ù‚ÙŠ Ø¨Ø§Ø±Ø¯.', en:'Chilled, pure water.' }
  };
  const pick = Object.keys(D).find(k => n.includes(k));
  return pick ? (lang==='ar' ? D[pick].ar : D[pick].en) :
    (lang==='ar' ? 'Ø·Ø¹Ù… Ù…ØªÙˆØ§Ø²Ù† ÙˆÙ†ÙƒÙ‡Ø© Ù…Ø­Ø¶Ù‘Ø±Ø© Ø¨Ø¹Ù†Ø§ÙŠØ©.' : 'Balanced taste, crafted with care.');
}

/* ===== State ===== */
let cart = JSON.parse(localStorage.getItem('nima.cart') || '[]');
function saveCart(){ localStorage.setItem('nima.cart', JSON.stringify(cart)); }
function cartCount(){ return cart.reduce((s,i)=>s+i.qty,0); }
function cartTotal(){
  return cart.reduce((s,i)=>{
    const qty = Number(i && i.qty) || 0;
    const price = Number(i && i.price) || 0;
    return s + qty * price;
  }, 0);
}
function updateCartBadge(){ document.getElementById('cartCount').textContent = cartCount(); }
let pendingTableAction = null;
let shouldRestoreCart = false;
let selectedTable = '';
const ORDER_LOG_KEY = 'nima.orderLog';
const CUSTOMER_PROFILE_KEY = 'nima.customerProfile';
const CUSTOMER_REGISTRY_KEY = 'nima.customerRegistry';
const LOYALTY_KEY = 'nima.loyaltyTracker';
const SESSION_GREETING_KEY = 'nima.greetedSession';
const DASHBOARD_CONFIG_KEY = 'nima.dashboardConfig';
const PROMOTIONS_KEY = 'nima.promotions';
const THEME_KEY = 'nima.menuTheme';
const THEME_DEFAULT = {
  id:'classic',
  colors:{
    brand:'#8b5e3c',
    'brand-2':'#d4a373',
    'brand-dark':'#70492d',
    bg:'#faf8f6',
    card:'#ffffff',
    text:'#1f1f1f',
    muted:'#6b6b6b',
    border:'#e9e6e3'
  }
};
let dashboardConfig = loadDashboardConfig();
let loyaltySettings = getLoyaltySettings();
let promotions = loadPromotions();
let themeConfig = loadThemeConfig();
applyTheme(themeConfig);
let customerProfile = loadCustomerProfile();
let customerRegistry = loadCustomerRegistry();
let orderLog = loadOrderLog();
let loyaltyState = loadLoyaltyState();
let currentLogViewId = '';
let currentDiscountCode = '';

/* ===== Helpers ===== */
const $ = (s)=>document.querySelector(s);
const REG = []; // registry for click-safe products (no inline JSON)
function register(item, cat){ const id = REG.push({item,cat})-1; return id; }

function priceHTML(p){
  const value = Number(p);
  if(!Number.isFinite(value)) return 'â€”';
  const formatted = Number.isInteger(value) ? value : value.toFixed(2);
  return `${formatted} <span class="sar" aria-label="${STRINGS[lang].sar_label}"></span><span class="sar-fallback">${lang==='ar'?'Ø±ÙŠØ§Ù„':'SAR'}</span>`;
}

function escapeHtml(str){
  return String(str || '').replace(/[&<>"']/g, c=>({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[c]));
}

function loadCustomerProfile(){
  try{
    const raw = JSON.parse(localStorage.getItem(CUSTOMER_PROFILE_KEY) || 'null');
    if(raw && typeof raw === 'object') return raw;
  }catch(e){}
  return {};
}

function saveCustomerProfileData(profile){
  if(!profile || typeof profile !== 'object') return;
  customerProfile = profile;
  localStorage.setItem(CUSTOMER_PROFILE_KEY, JSON.stringify(customerProfile));
}

function loadCustomerRegistry(){
  try{
    const raw = JSON.parse(localStorage.getItem(CUSTOMER_REGISTRY_KEY) || 'null');
    if(raw && typeof raw === 'object') return raw;
  }catch(e){}
  return {};
}

function saveCustomerRegistry(){
  try{ localStorage.setItem(CUSTOMER_REGISTRY_KEY, JSON.stringify(customerRegistry)); }
  catch(e){ console.warn('Unable to persist customer registry', e); }
}

function ensureCustomerRegistryEntry(id, profile={}){
  if(!id) return;
  if(!customerRegistry || typeof customerRegistry !== 'object') customerRegistry = {};
  const existing = customerRegistry[id] || {};
  const next = { ...existing };
  if(profile.name !== undefined) next.name = profile.name;
  if(profile.phone !== undefined) next.phone = profile.phone;
  customerRegistry[id] = next;
  saveCustomerRegistry();
}

function generateCustomerId(name='', phone=''){
  const phoneClean = (phone || '').replace(/\D+/g,'');
  if(phoneClean) return `cust-${phoneClean}`;
  const base = (name || '').trim().toLowerCase().replace(/[^\w\u0600-\u06FF]+/g,'-').replace(/^-+|-+$/g,'');
  if(base) return `cust-${base}`;
  return (customerProfile && customerProfile.id) ? customerProfile.id : 'guest';
}

function getActiveCustomerId(){
  return (customerProfile && customerProfile.id) ? customerProfile.id : 'guest';
}

function loadOrderLog(){
  let stored = null;
  try{ stored = JSON.parse(localStorage.getItem(ORDER_LOG_KEY) || 'null'); }
  catch(e){ stored = null; }
  if(Array.isArray(stored)){
    return { customers:{ guest:{ profile:{ name:'', phone:'' }, orders: stored } } };
  }
  if(!stored || typeof stored !== 'object') stored = { customers:{} };
  if(!stored.customers || typeof stored.customers !== 'object') stored.customers = {};
  return stored;
}

function ensureCustomerLog(id, profile){
  if(!id) id = 'guest';
  if(!orderLog || typeof orderLog !== 'object') orderLog = { customers:{} };
  if(!orderLog.customers || typeof orderLog.customers !== 'object') orderLog.customers = {};
  if(!orderLog.customers[id]){
    orderLog.customers[id] = { profile:{ name:'', phone:'' }, orders:[] };
  }
  if(profile){
    if(profile.name) orderLog.customers[id].profile.name = profile.name;
    if(profile.phone) orderLog.customers[id].profile.phone = profile.phone;
  }
  return orderLog.customers[id];
}

function saveOrderLog(){
  try{ localStorage.setItem(ORDER_LOG_KEY, JSON.stringify(orderLog)); }
  catch(e){ console.warn('Unable to persist order log', e); }
}

function loadDashboardConfig(){
  try{
    const raw = JSON.parse(localStorage.getItem(DASHBOARD_CONFIG_KEY) || 'null');
    if(raw && typeof raw === 'object'){
      if(!raw.loyalty) raw.loyalty = {};
      const required = Math.max(1, Number(raw.loyalty.requiredCount) || 5);
      raw.loyalty.requiredCount = required;
      if(!raw.loyalty.noteAr) raw.loyalty.noteAr = STRINGS.ar.loyalty_message;
      if(!raw.loyalty.noteEn) raw.loyalty.noteEn = STRINGS.en.loyalty_message;
      return raw;
    }
  }catch(e){}
  return {
    loyalty:{
      requiredCount:5,
      noteAr: STRINGS.ar.loyalty_message,
      noteEn: STRINGS.en.loyalty_message
    }
  };
}

function getLoyaltySettings(){
  const required = Math.max(1, Number(dashboardConfig && dashboardConfig.loyalty && dashboardConfig.loyalty.requiredCount) || 5);
  return {
    requiredCount: required,
    noteAr: dashboardConfig && dashboardConfig.loyalty && dashboardConfig.loyalty.noteAr ? dashboardConfig.loyalty.noteAr : STRINGS.ar.loyalty_message.replace('{count}', required).replace('{drink}', STRINGS.ar.loyalty_reward_label),
    noteEn: dashboardConfig && dashboardConfig.loyalty && dashboardConfig.loyalty.noteEn ? dashboardConfig.loyalty.noteEn : STRINGS.en.loyalty_message.replace('{count}', required).replace('{drink}', STRINGS.en.loyalty_reward_label)
  };
}

function loadPromotions(){
  try{
    const raw = JSON.parse(localStorage.getItem(PROMOTIONS_KEY) || '[]');
    return Array.isArray(raw) ? raw : [];
  }catch(e){ return []; }
}

function isPromotionActive(promo){
  if(!promo || promo.inactive) return false;
  const now = new Date();
  const start = promo.start ? new Date(promo.start) : null;
  const end = promo.end ? new Date(promo.end) : null;
  const startOk = !start || (start instanceof Date && !isNaN(start) && start <= now);
  const endOk = !end || (end instanceof Date && !isNaN(end) && end >= now);
  return startOk && endOk;
}

function formatPromoDate(value){
  if(!value) return '';
  const date = new Date(value);
  if(!(date instanceof Date) || isNaN(date)) return value;
  const opts = { month:'short', day:'numeric' };
  try{ return date.toLocaleDateString(lang==='ar'?'ar-SA':'en-GB', opts); }
  catch(e){ return value; }
}

function renderPromotionsBanner(){
  const banner = document.getElementById('promoBanner');
  const list = document.getElementById('promoBannerItems');
  const title = document.getElementById('promoBannerTitle');
  if(!banner || !list) return;
  if(title) title.textContent = STRINGS[lang].promo_banner_title;
  const activeList = (promotions || []).filter(isPromotionActive);
  list.innerHTML = '';
  if(!activeList.length){
    list.innerHTML = `<div class="promo-item"><div class="muted">${escapeHtml(STRINGS[lang].promo_banner_empty)}</div></div>`;
    banner.style.display = 'flex';
    return;
  }
  activeList.forEach(promo=>{
    const div = document.createElement('div');
    div.className = 'promo-item';
    const titleText = lang==='ar' ? (promo.title_ar || promo.title_en || '') : (promo.title_en || promo.title_ar || '');
    const descText = lang==='ar' ? (promo.desc_ar || '') : (promo.desc_en || '');
    let dateText = '';
    if(promo.start && promo.end){
      dateText = STRINGS[lang].promo_valid_range.replace('{start}', formatPromoDate(promo.start)).replace('{end}', formatPromoDate(promo.end));
    } else if(promo.start){
      dateText = STRINGS[lang].promo_valid_range.replace('{start}', formatPromoDate(promo.start)).replace('{end}', STRINGS[lang].promo_valid_single);
    } else if(promo.end){
      dateText = STRINGS[lang].promo_valid_range.replace('{start}', STRINGS[lang].promo_valid_single).replace('{end}', formatPromoDate(promo.end));
    } else {
      dateText = STRINGS[lang].promo_active_label;
    }
    div.innerHTML = `
      <div class="promo-title">${escapeHtml(titleText)}</div>
      <div class="promo-dates">${escapeHtml(dateText)}</div>
      ${descText ? `<div class="muted">${escapeHtml(descText)}</div>` : ''}`;
    list.appendChild(div);
  });
  banner.style.display = 'flex';
}

function loadThemeConfig(){
  try{
    const raw = JSON.parse(localStorage.getItem(THEME_KEY) || 'null');
    if(raw && raw.colors){
      return {
        id: raw.id || 'custom',
        colors: { ...THEME_DEFAULT.colors, ...raw.colors }
      };
    }
  }catch(e){}
  return THEME_DEFAULT;
}

function applyTheme(theme){
  const colors = { ...THEME_DEFAULT.colors, ...(theme && theme.colors || {}) };
  const root = document.documentElement;
  Object.keys(colors).forEach(key=> root.style.setProperty(`--${key}`, colors[key]));
}

function loadLoyaltyState(){
  try{
    const raw = JSON.parse(localStorage.getItem(LOYALTY_KEY) || 'null');
    if(raw && typeof raw === 'object'){
      if(!raw.global){
        const total = Object.keys(raw).reduce((sum,key)=>{
          if(key==='history') return sum;
          const rec = raw[key];
          return sum + (Number(rec && rec.count) || 0);
        }, 0);
        return { global:{ count:total, rewardLevel:Math.floor(total / (loyaltySettings.requiredCount || 5)), history:[] } };
      }
      if(typeof raw.global.count !== 'number') raw.global.count = Number(raw.global.count) || 0;
      if(typeof raw.global.rewardLevel !== 'number') raw.global.rewardLevel = Math.floor(raw.global.count / (loyaltySettings.requiredCount || 5));
      if(!Array.isArray(raw.global.history)) raw.global.history = Array.isArray(raw.history) ? raw.history : [];
      return { global: raw.global };
    }
  }catch(e){}
  return { global:{ count:0, rewardLevel:0, history:[] } };
}

function saveLoyaltyState(){
  try{ localStorage.setItem(LOYALTY_KEY, JSON.stringify(loyaltyState)); }
  catch(e){ console.warn('Unable to persist loyalty tracker', e); }
}

let cachedClientIp = '';
async function getClientIp(){
  if(cachedClientIp) return cachedClientIp;
  try{
    const cached = localStorage.getItem('nima.cachedIp');
    if(cached){ cachedClientIp = cached; return cachedClientIp; }
  }catch(e){}
  try{
    const res = await fetch('https://api.ipify.org?format=json');
    if(res.ok){
      const data = await res.json();
      if(data && data.ip){
        cachedClientIp = data.ip;
        localStorage.setItem('nima.cachedIp', cachedClientIp);
        return cachedClientIp;
      }
    }
  }catch(e){}
  return '';
}

function detectDeviceInfo(){
  const ua = (navigator && navigator.userAgent) || '';
  const platform = (navigator && navigator.platform) || '';
  let label = 'desktop';
  if(/android/i.test(ua)) label = 'android';
  else if(/iphone|ipad|ipod/i.test(ua)) label = 'ios';
  else if(/mobile/i.test(ua)) label = 'mobile';
  return { label, details: ua, platform };
}

async function recordOrderLog(entry){
  if(!entry || typeof entry !== 'object') return;
  const customerId = getActiveCustomerId();
  const profile = {
    name: customerProfile && customerProfile.name ? customerProfile.name : '',
    phone: customerProfile && customerProfile.phone ? customerProfile.phone : ''
  };
  ensureCustomerRegistryEntry(customerId, profile);
  const bucket = ensureCustomerLog(customerId, profile);
  bucket.orders.unshift(entry);
  if(bucket.orders.length>100) bucket.orders.length = 100;
  saveOrderLog();
  const info = detectDeviceInfo();
  const ip = await getClientIp();
  const existing = customerRegistry[customerId] || {};
  const attendance = Number(existing.attendance || 0) + 1;
  customerRegistry[customerId] = {
    ...existing,
    name: profile.name || existing.name || '',
    phone: profile.phone || existing.phone || '',
    attendance,
    lastVisit: new Date().toISOString(),
    lastTotal: entry.total || existing.lastTotal || 0,
    lastTable: entry.table || existing.lastTable || '',
    ip: ip || existing.ip || '',
    device: info.label,
    deviceDetails: info.details
  };
  saveCustomerRegistry();
  renderOrderLog(customerId);
}

function formatLogTime(timestamp){
  if(!timestamp) return '';
  const date = new Date(timestamp);
  const options = { dateStyle:'short', timeStyle:'short' };
  if(typeof Intl !== 'undefined' && Intl.DateTimeFormat){
    try{ return new Intl.DateTimeFormat(lang==='ar'?'ar-SA':'en-GB', options).format(date); }
    catch(e){}
  }
  return date.toLocaleString();
}

function getCustomerLabel(id){
  if(!id) return STRINGS[lang].order_log_guest;
  if(customerProfile && customerProfile.id === id && customerProfile.name){
    return customerProfile.name;
  }
  const reg = customerRegistry && customerRegistry[id];
  if(reg && reg.name) return reg.name;
  const stored = orderLog && orderLog.customers && orderLog.customers[id];
  if(stored && stored.profile && stored.profile.name) return stored.profile.name;
  if(id === 'guest') return STRINGS[lang].order_log_guest;
  return `${STRINGS[lang].customer_name_label} ${id}`;
}

function getOrdersForCustomer(id){
  const bucket = ensureCustomerLog(id);
  return Array.isArray(bucket.orders) ? bucket.orders : [];
}

function renderOrderLog(preferredId){
  const list = document.getElementById('orderLogList');
  const empty = document.getElementById('orderLogEmpty');
  const selectEl = document.getElementById('orderLogCustomerSelect');
  if(!list || !empty) return;
  const activeId = preferredId || currentLogViewId || getActiveCustomerId();
  currentLogViewId = activeId;
  const optionIds = new Set(['guest']);
  if(customerProfile && customerProfile.id){
    optionIds.add(customerProfile.id);
    ensureCustomerRegistryEntry(customerProfile.id, customerProfile);
    ensureCustomerLog(customerProfile.id, customerProfile);
  }
  Object.keys(customerRegistry || {}).forEach(id=> optionIds.add(id));
  if(orderLog && orderLog.customers){
    Object.keys(orderLog.customers).forEach(id=> optionIds.add(id));
  }
  const options = Array.from(optionIds).map(id=>({ id, label: getCustomerLabel(id) }));
  options.sort((a,b)=> a.label.localeCompare(b.label, lang==='ar'?'ar':'en', { sensitivity:'base' }));
  if(selectEl){
    selectEl.innerHTML='';
    options.forEach(opt=>{
      const o=document.createElement('option');
      o.value = opt.id;
      o.textContent = opt.label;
      selectEl.appendChild(o);
    });
    if(options.some(opt=>opt.id===activeId)){
      selectEl.value = activeId;
    } else if(options.length){
      currentLogViewId = options[0].id;
      selectEl.value = currentLogViewId;
    }
  }
  const orders = getOrdersForCustomer(currentLogViewId);
  list.innerHTML='';
  if(!orders.length){
    empty.style.display='block';
    empty.textContent = STRINGS[lang].order_log_empty_customer || STRINGS[lang].order_log_empty;
    return;
  }
  empty.style.display='none';
  orders.forEach(entry=>{
    const orderId = entry && (entry.orderId || entry.id || entry.code) ? (entry.orderId || entry.id || entry.code) : '#';
    const totalValue = Number(entry && entry.total) || 0;
    const metaParts = [];
    if(entry && entry.table){ metaParts.push(`${STRINGS[lang].table} ${entry.table}`); }
    if(entry && entry.timestamp){
      const timeText = formatLogTime(entry.timestamp);
      if(timeText) metaParts.push(timeText);
    }
    if(entry && entry.discountCode){ metaParts.push(`${STRINGS[lang].discount_code_label}: ${entry.discountCode}`); }
    if(entry && Number(entry.loyaltyDiscount) > 0){
      const discountValue = Number(entry.loyaltyDiscount);
      metaParts.push(`${STRINGS[lang].loyalty_discount_label}: -${discountValue} ${lang==='ar'?'Ø±ÙŠØ§Ù„':'SAR'}`);
    }
    if(entry && entry.customer && entry.customer.phone){
      metaParts.push(`${STRINGS[lang].customer_phone_label}: ${entry.customer.phone}`);
    }
    const item = document.createElement('div');
    item.className = 'log-entry';
    item.innerHTML = `
      <h4>
        <span>${orderId}</span>
        <span class="total">${priceHTML(totalValue)}</span>
      </h4>
      <div class="meta">${metaParts.join(' â€¢ ')}</div>
    `;
    if(entry && Array.isArray(entry.items) && entry.items.length){
      const ul = document.createElement('ul');
      ul.className = 'items';
      entry.items.forEach(it=>{
        const name = lang==='ar' ? (it.name_ar || it.name_en || '') : (it.name_en || it.name_ar || '');
        const opts = it.options && it.options.length ? ` â€” ${it.options.join(lang==='ar'?'ØŒ ':' / ')}` : '';
        const qty = it.qty || 1;
        ul.insertAdjacentHTML('beforeend', `<li>${name} Ã—${qty}${opts}</li>`);
      });
      item.appendChild(ul);
    }
    if(entry && Array.isArray(entry.loyaltyRewards) && entry.loyaltyRewards.length){
      const note = document.createElement('div');
      note.className = 'loyalty-note';
      const lines = entry.loyaltyRewards.map(reward=>{
        const drink = lang==='ar' ? (reward.drink_ar || reward.drink_en || '') : (reward.drink_en || reward.drink_ar || '');
        const count = reward.freebies || 1;
        return `${STRINGS[lang].order_log_loyalty_reward}: ${drink} Ã—${count}`;
      });
      note.textContent = lines.join(' â€¢ ');
      item.appendChild(note);
    }
    list.appendChild(item);
  });
  if(selectEl && !selectEl.dataset.bound){
    selectEl.dataset.bound = '1';
    selectEl.addEventListener('change', (e)=>{
      currentLogViewId = e.target.value || 'guest';
      renderOrderLog(currentLogViewId);
    });
  }
}

function populateTableSelect(select, selectedValue='', disablePlaceholder=true){
  if(!select) return;
  select.innerHTML='';
  const placeholder = document.createElement('option');
  placeholder.value='';
  placeholder.textContent = STRINGS[lang].select_table;
  if(disablePlaceholder){ placeholder.disabled = true; }
  if(!selectedValue){ placeholder.selected = true; }
  select.appendChild(placeholder);
  for(let i=1;i<=15;i++){
    const o=document.createElement('option');
    o.value=String(i);
    o.textContent = `${STRINGS[lang].table} ${i}`;
    select.appendChild(o);
  }
  if(selectedValue){ select.value = selectedValue; }
}

function setTableValue(val){
  selectedTable = val || '';
  const baseSelect = document.getElementById('table');
  const cartSelectEl = document.getElementById('tableCart');
  if(baseSelect) baseSelect.value = selectedTable;
  if(cartSelectEl) cartSelectEl.value = selectedTable;
}

function getCurrentTableValue(){
  if(selectedTable) return selectedTable;
  const baseSelect = document.getElementById('table');
  const cartSelectEl = document.getElementById('tableCart');
  return (baseSelect && baseSelect.value) || (cartSelectEl && cartSelectEl.value) || '';
}

function formatArTime12h(date){
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ù‹Ø§';
  hours = hours % 12 || 12;
  return `${hours}:${minutes} ${period}`;
}

function buildTimestampInfo(){
  const now = new Date();
  let dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
  let timeStr = formatArTime12h(now);
  if(typeof Intl !== 'undefined' && Intl.DateTimeFormat){
    try{
      const dateFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-gregory', { year:'numeric', month:'2-digit', day:'2-digit' });
      dateStr = dateFormatter.format(now);
    }catch(e){}
    try{
      const timeFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-gregory', { hour:'numeric', minute:'2-digit', hour12:true });
      let formatted = timeFormatter.format(now);
      if(formatted.includes('Øµ')) formatted = formatted.replace('Øµ', 'ØµØ¨Ø§Ø­Ù‹Ø§');
      if(formatted.includes('Ù…')) formatted = formatted.replace('Ù…', 'Ù…Ø³Ø§Ø¡Ù‹');
      timeStr = formatted;
    }catch(e){}
  }
  return { now, date: dateStr, time: timeStr, full: `${dateStr} ${timeStr}` };
}

function isCartOpen(){
  const sheet = document.getElementById('cartSheet');
  return sheet && sheet.style.display === 'flex';
}

function makeItemEl(it, cat){
  const el = document.createElement('div');
  el.className = 'item';
  const name = (lang==='ar'?it.ar:it.en);
  const id = register(it, cat);
  const metrics = getItemDisplayMetrics(it);
  const priceDisplay = priceHTML(metrics.price);
  const calText = Number.isFinite(metrics.cal) ? `${metrics.cal} ${STRINGS[lang].kcal}` : (STRINGS[lang].kcal_unknown || 'â€”');
  const descText = it['desc_'+lang] || autoDesc(it);
  el.innerHTML = `
    <div class="thumb"><img src="${it.img||IMG_DEFAULT}" alt="${name}"/></div>
    <div>
      <div class="line">
        <span class="name">${name}</span>
        <span class="dots"></span>
        <span class="price">${priceDisplay}</span>
      </div>
      <div class="cals">${calText}</div>
      <div class="sub">${descText}</div>
    </div>`;
  el.addEventListener('click', ()=>{ const rec=REG[id]; openProduct(rec.item, rec.cat); });
  return el;
}

function mount(containerId, arr, cat){
  const root = document.getElementById(containerId); root.innerHTML='';
  arr.forEach(it=> root.appendChild(makeItemEl(it, cat)));
}

function renderAll(){
  loyaltySettings = getLoyaltySettings();
  // strings
  $('#title').textContent = STRINGS[lang].title;
  $('#tagline').textContent = STRINGS[lang].tagline;
  $('#search').placeholder = STRINGS[lang].search;
  document.querySelectorAll('[data-i18n="hot_drinks"]').forEach(e=> e.textContent = STRINGS[lang].hot_drinks);
  document.querySelectorAll('[data-i18n="cold_drinks"]').forEach(e=> e.textContent = STRINGS[lang].cold_drinks);
  document.querySelectorAll('[data-i18n="dessert"]').forEach(e=> e.textContent = STRINGS[lang].dessert);
  document.querySelectorAll('[data-i18n="call_waiter"]').forEach(e=> e.textContent = STRINGS[lang].call_waiter);
  document.querySelectorAll('[data-i18n="cart"]').forEach(e=> e.textContent = STRINGS[lang].cart);
  document.querySelectorAll('[data-i18n="your_cart"]').forEach(e=> e.textContent = STRINGS[lang].your_cart);
  document.querySelectorAll('[data-i18n="total"]').forEach(e=> e.textContent = STRINGS[lang].total);
  document.querySelectorAll('[data-i18n="send_order"]').forEach(e=> e.textContent = STRINGS[lang].send_order);
  document.querySelectorAll('[data-i18n="clear"]').forEach(e=> e.textContent = STRINGS[lang].clear);
  document.querySelectorAll('[data-i18n="empty"]').forEach(e=> e.textContent = STRINGS[lang].empty);
  const orderLogBtnLabel = document.getElementById('orderLogBtnLabel');
  if(orderLogBtnLabel) orderLogBtnLabel.textContent = STRINGS[lang].order_log_button;
  document.getElementById('orderLogTitle').textContent = STRINGS[lang].order_log_title;
  document.getElementById('orderLogDesc').textContent = STRINGS[lang].order_log_desc;
  document.getElementById('orderLogEmpty').textContent = STRINGS[lang].order_log_empty_customer || STRINGS[lang].order_log_empty;
  document.getElementById('orderLogCloseBtn').textContent = STRINGS[lang].cancel;
  document.getElementById('orderLogClearLabel').textContent = STRINGS[lang].clear_log;
  const orderLogCustomerLabel = document.getElementById('orderLogCustomerLabel');
  if(orderLogCustomerLabel) orderLogCustomerLabel.textContent = STRINGS[lang].order_log_customer_label;
  const footEl = document.getElementById('foot');
  if(footEl) footEl.textContent = STRINGS[lang].footer;
  const dashLink = document.getElementById('dashboardShortcut');
  if(dashLink){
    const title = STRINGS[lang].dashboard_shortcut_title || 'Dashboard';
    dashLink.setAttribute('title', title);
    dashLink.setAttribute('aria-label', title);
  }
  renderPromotionsBanner();
  document.getElementById('tableModalTitle').textContent = STRINGS[lang].table_modal_title;
  document.getElementById('tableModalDesc').textContent = STRINGS[lang].table_modal_desc;
  document.getElementById('tableModalNote').textContent = STRINGS[lang].table_modal_note;
  document.getElementById('tableConfirmBtn').textContent = STRINGS[lang].confirm;
  document.getElementById('tableCancelBtn').textContent = STRINGS[lang].cancel;
  document.getElementById('tablePromptError').textContent = STRINGS[lang].table_modal_error;
  const profileBtnEl = document.getElementById('profileBtn');
  if(profileBtnEl) profileBtnEl.textContent = STRINGS[lang].profile_button;
  document.getElementById('profileModalTitle').textContent = STRINGS[lang].profile_modal_title;
  document.getElementById('profileModalDesc').textContent = STRINGS[lang].profile_modal_desc;
  document.getElementById('profileNameLabel').textContent = STRINGS[lang].profile_name_label;
  document.getElementById('profilePhoneLabel').textContent = STRINGS[lang].profile_phone_label;
  document.getElementById('profileModalNote').textContent = STRINGS[lang].profile_note;
  document.getElementById('profileSkipBtn').textContent = STRINGS[lang].profile_skip;
  document.getElementById('profileSaveBtn').textContent = STRINGS[lang].profile_save;
  document.getElementById('profileName').placeholder = STRINGS[lang].profile_name_placeholder;
  document.getElementById('profilePhone').placeholder = STRINGS[lang].profile_phone_placeholder;
  document.getElementById('loyaltyTitle').textContent = STRINGS[lang].loyalty_title;
  document.getElementById('loyaltyCloseBtn').textContent = STRINGS[lang].loyalty_button;
  const discountLabel = document.getElementById('discountLabel');
  if(discountLabel) discountLabel.textContent = STRINGS[lang].discount_label;
  const discountInput = document.getElementById('discountInput');
  if(discountInput){
    discountInput.placeholder = STRINGS[lang].discount_placeholder;
    discountInput.value = currentDiscountCode;
  }

  // dir/lang
  document.documentElement.lang = (lang==='ar'?'ar':'en');
  document.documentElement.dir = (lang==='ar'?'rtl':'ltr');

  // items
  mount('hot-coffee', data.hot.coffee, 'hot');
  mount('hot-tea', data.hot.tea, 'hot');
  mount('cold-coffee', data.cold.coffee, 'cold');
  mount('cold-mojito', data.cold.mojito, 'cold');
  mount('cold-other', data.cold.other, 'cold');
  mount('dessert-cake', data.dessert.cake, 'dessert');
  mount('dessert-side', data.dessert.side, 'dessert');

  fillTables();
  fillTablesCart();
  updateCartBadge();
  updateCustomizationLabels();
  updateGreeting();
  renderOrderLog(currentLogViewId || getActiveCustomerId());
  renderCart();
}

function updateGreeting(){
  const textEl = document.getElementById('greetingText');
  const btn = document.getElementById('profileBtn');
  if(btn) btn.textContent = STRINGS[lang].profile_button;
  if(!textEl) return;
  const name = customerProfile && customerProfile.name ? customerProfile.name.trim() : '';
  if(name){
    const safe = escapeHtml(name);
    const template = STRINGS[lang].greeting_named || STRINGS[lang].greeting_guest;
    textEl.innerHTML = template.replace('{name}', `<span class="welcome-name">${safe}</span>`);
  } else {
    textEl.textContent = STRINGS[lang].greeting_guest;
  }
}

function maybeToastGreeting(force=false){
  if(!(customerProfile && customerProfile.name)) return;
  const id = customerProfile.id || 'guest';
  const sessionKey = `${SESSION_GREETING_KEY}:${id}`;
  if(!force && sessionStorage.getItem(sessionKey)) return;
  const template = STRINGS[lang].greeting_toast || STRINGS[lang].greeting_named || STRINGS[lang].greeting_guest;
  toast(template.replace('{name}', customerProfile.name));
  sessionStorage.setItem(sessionKey, '1');
}

/* ===== Search ===== */
const search = $('#search');
search.addEventListener('input', ()=>{
  const q = search.value.trim().toLowerCase();
  const f = (arr)=>arr.filter(x=> ((x.ar||'')+(x.en||'')).toLowerCase().includes(q));
  mount('hot-coffee', f(data.hot.coffee), 'hot');
  mount('hot-tea', f(data.hot.tea), 'hot');
  mount('cold-coffee', f(data.cold.coffee), 'cold');
  mount('cold-mojito', f(data.cold.mojito), 'cold');
  mount('cold-other', f(data.cold.other), 'cold');
  mount('dessert-cake', f(data.dessert.cake), 'dessert');
  mount('dessert-side', f(data.dessert.side), 'dessert');
});

/* ===== Mode toggle ===== */
const modeBtn = $('#modeBtn');
const savedMode = localStorage.getItem('nima.mode');
if(savedMode){ if(savedMode==='dark') document.body.classList.add('dark'); }
else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ document.body.classList.add('dark'); }
modeBtn.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
modeBtn.onclick = ()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('nima.mode', document.body.classList.contains('dark')?'dark':'light');
  modeBtn.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
};

/* ===== Language toggle ===== */
const langBtn = $('#langBtn');
function updateLangBtn(){ langBtn.textContent = (lang==='ar') ? 'E' : 'Ø¹'; }
langBtn.onclick = ()=>{
  lang = (lang==='ar') ? 'en' : 'ar';
  localStorage.setItem('nima.lang', lang);
  renderAll(); updateLangBtn();
};

/* ===== Tables ===== */
const tableSelect = $('#table');
function fillTables(){
  populateTableSelect(tableSelect, selectedTable, true);
  tableSelect.onchange = ()=>{
    const val = tableSelect.value;
    if(val){ setTableValue(val); }
  };
}
function fillTablesCart(){
  const sel = $('#tableCart');
  populateTableSelect(sel, selectedTable, true);
  sel.onchange = ()=>{
    const val = sel.value;
    if(val){ setTableValue(val); }
  };
}

/* ===== Table enforcement ===== */
const tableModalEl = document.getElementById('tableModal');
const tablePromptSelect = document.getElementById('tablePrompt');
const tablePromptError = document.getElementById('tablePromptError');
const tableConfirmBtn = document.getElementById('tableConfirmBtn');
const tableCancelBtn = document.getElementById('tableCancelBtn');
const tableModalBackdrop = document.querySelector('#tableModal .backdrop');

function openTableModal(){
  populateTableSelect(tablePromptSelect, selectedTable, false);
  tablePromptError.style.display='none';
  tableModalEl.style.display='flex';
  tableModalEl.setAttribute('aria-hidden','false');
  setTimeout(()=> tablePromptSelect.focus(), 30);
}

function closeTableModal(){
  tableModalEl.style.display='none';
  tableModalEl.setAttribute('aria-hidden','true');
  tablePromptError.style.display='none';
  pendingTableAction = null;
  shouldRestoreCart = false;
}

function ensureTableSelection(action, options={}){
  const forcePrompt = !!options.forcePrompt;
  const restoreCartPref = typeof options.restoreCart === 'boolean' ? options.restoreCart : isCartOpen();
  const current = getCurrentTableValue();
  if(current && !forcePrompt){
    setTableValue(current);
    if(typeof action === 'function') action(current);
    return true;
  }
  pendingTableAction = typeof action === 'function' ? action : null;
  shouldRestoreCart = restoreCartPref;
  openTableModal();
  return false;
}

if(tableModalBackdrop){ tableModalBackdrop.addEventListener('click', ()=> closeTableModal()); }
if(tableCancelBtn){ tableCancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeTableModal(); }); }
if(tablePromptSelect){
  tablePromptSelect.addEventListener('change', ()=>{
    if(tablePromptError) tablePromptError.style.display='none';
  });
}
if(tableConfirmBtn){
  tableConfirmBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const val = tablePromptSelect.value;
    if(!val){
      tablePromptError.style.display='block';
      tablePromptSelect.focus();
      return;
    }
    tablePromptError.style.display='none';
    setTableValue(val);
    tableModalEl.style.display='none';
    tableModalEl.setAttribute('aria-hidden','true');
    const action = pendingTableAction;
    const restoreCart = shouldRestoreCart;
    pendingTableAction = null;
    shouldRestoreCart = false;
    if(restoreCart) openCart();
    if(action) action(val);
  });
}

/* ===== Order Log Modal ===== */
const orderLogModalEl = document.getElementById('orderLogModal');
const orderLogBackdrop = document.querySelector('#orderLogModal .backdrop');
const orderLogBtn = document.getElementById('orderLogBtn');
const orderLogCloseBtn = document.getElementById('orderLogCloseBtn');
const orderLogClearBtn = document.getElementById('orderLogClearBtn');

function openOrderLog(){
  renderOrderLog();
  if(orderLogModalEl){
    orderLogModalEl.style.display='flex';
    orderLogModalEl.setAttribute('aria-hidden','false');
  }
}

function closeOrderLog(){
  if(orderLogModalEl){
    orderLogModalEl.style.display='none';
    orderLogModalEl.setAttribute('aria-hidden','true');
  }
}

if(orderLogBackdrop){ orderLogBackdrop.addEventListener('click', ()=> closeOrderLog()); }
if(orderLogBtn){ orderLogBtn.addEventListener('click', ()=> openOrderLog()); }
if(orderLogCloseBtn){ orderLogCloseBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeOrderLog(); }); }
if(orderLogClearBtn){
  orderLogClearBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const targetId = currentLogViewId || getActiveCustomerId();
    const bucket = ensureCustomerLog(targetId);
    if(!bucket.orders.length){ closeOrderLog(); return; }
    if(!window.confirm(STRINGS[lang].clear_log_confirm)) return;
    bucket.orders = [];
    saveOrderLog();
    renderOrderLog(targetId);
  });
}

/* ===== Profile Modal ===== */
const profileModalEl = document.getElementById('profileModal');
const profileBackdrop = document.querySelector('#profileModal .backdrop');
const profileBtnTrigger = document.getElementById('profileBtn');
const profileNameInput = document.getElementById('profileName');
const profilePhoneInput = document.getElementById('profilePhone');
const profileSaveBtn = document.getElementById('profileSaveBtn');
const profileSkipBtn = document.getElementById('profileSkipBtn');
let profileForced = false;

function normalizePhone(value){
  return (value || '').replace(/\s+/g,'').replace(/[^0-9+]/g,'');
}

function openProfileModal(force=false){
  profileForced = !!force;
  if(profileModalEl){
    profileModalEl.style.display='flex';
    profileModalEl.setAttribute('aria-hidden','false');
  }
  if(profileSkipBtn) profileSkipBtn.style.display = profileForced ? 'none' : 'inline-flex';
  if(profileNameInput){
    profileNameInput.value = customerProfile.name || '';
    if(profilePhoneInput) profilePhoneInput.value = customerProfile.phone || '';
    setTimeout(()=> profileNameInput.focus(), 40);
  }
}

function closeProfileModal(){
  if(profileModalEl){
    profileModalEl.style.display='none';
    profileModalEl.setAttribute('aria-hidden','true');
  }
  profileForced = false;
}

function handleProfileSave(){
  const name = (profileNameInput && profileNameInput.value || '').trim();
  const phone = normalizePhone((profilePhoneInput && profilePhoneInput.value || '').trim());
  if(!name && !phone){
    toast(STRINGS[lang].profile_required);
    if(profileNameInput) profileNameInput.focus();
    return;
  }
  let id = generateCustomerId(name, phone);
  if(!id) id = 'guest';
  const updatedProfile = { id, name, phone };
  saveCustomerProfileData(updatedProfile);
  ensureCustomerRegistryEntry(id, updatedProfile);
  const bucket = ensureCustomerLog(id, updatedProfile);
  if(id !== 'guest' && orderLog && orderLog.customers && orderLog.customers.guest && orderLog.customers.guest.orders.length){
    const guestOrders = orderLog.customers.guest.orders.slice();
    if(guestOrders.length){
      bucket.orders = guestOrders.concat(bucket.orders || []);
      orderLog.customers.guest.orders = [];
    }
  }
  saveOrderLog();
  currentLogViewId = id;
  updateGreeting();
  maybeToastGreeting(true);
  toast(STRINGS[lang].profile_saved);
  closeProfileModal();
  renderOrderLog(id);
}

if(profileBtnTrigger){ profileBtnTrigger.addEventListener('click', ()=> openProfileModal(false)); }
if(profileBackdrop){ profileBackdrop.addEventListener('click', ()=>{ if(!profileForced) closeProfileModal(); }); }
if(profileSkipBtn){ profileSkipBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeProfileModal(); }); }
if(profileSaveBtn){ profileSaveBtn.addEventListener('click', (e)=>{ e.preventDefault(); handleProfileSave(); }); }

/* ===== Loyalty Modal ===== */
const loyaltyModalEl = document.getElementById('loyaltyModal');
const loyaltyBackdrop = document.querySelector('#loyaltyModal .backdrop');
const loyaltyMessageEl = document.getElementById('loyaltyMessage');
const loyaltyCloseBtn = document.getElementById('loyaltyCloseBtn');

function showLoyaltyModal(info){
  if(!loyaltyModalEl) return;
  const drinkName = lang==='ar' ? (info && (info.drink_ar || info.drink_en) || '') : (info && (info.drink_en || info.drink_ar) || '');
  const customerName = customerProfile && customerProfile.name ? customerProfile.name : (lang==='ar'?'Ø¶ÙŠÙÙ†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²':'dear guest');
  if(loyaltyMessageEl){
    const safeDrink = escapeHtml(drinkName);
    const safeName = escapeHtml(customerName);
    const template = (lang==='ar' ? loyaltySettings.noteAr : loyaltySettings.noteEn) || (STRINGS[lang].loyalty_message || '');
    const countValue = info && info.count ? Number(info.count) : loyaltySettings.requiredCount || 5;
    loyaltyMessageEl.innerHTML = template
      .replace('{drink}', safeDrink)
      .replace('{name}', `<span class="welcome-name">${safeName}</span>`)
      .replace('{count}', countValue);
  }
  loyaltyModalEl.style.display='flex';
  loyaltyModalEl.setAttribute('aria-hidden','false');
}

function closeLoyaltyModal(){
  if(!loyaltyModalEl) return;
  loyaltyModalEl.style.display='none';
  loyaltyModalEl.setAttribute('aria-hidden','true');
}

if(loyaltyBackdrop){ loyaltyBackdrop.addEventListener('click', closeLoyaltyModal); }
if(loyaltyCloseBtn){ loyaltyCloseBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeLoyaltyModal(); }); }

/* ===== Call waiter ===== */
function sendWaiterCall(tableId){
  const fallback = lang==='ar' ? 'ØŸ' : '?';
  const t = tableId || fallback;
  const stamp = buildTimestampInfo();
  const lines = [
    `ğŸ”” Ø·Ø§ÙˆÙ„Ø© ${t} ØªØ­ØªØ§Ø¬ Ø®Ø¯Ù…Ø©`,
    `â° ${STRINGS.ar.order_time_label}: ${stamp.full}`
  ];
  const text = lines.map(encodeURIComponent).join('%0A%0A');
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID_NEW}&text=${text}`;
  fetch(url).catch(console.error);
  toast(STRINGS[lang].waiter_toast);
}

$('#callBtn').addEventListener('click', ()=>{
  ensureTableSelection((tableId)=>{
    sendWaiterCall(tableId);
  }, { forcePrompt:true, restoreCart:false });
});

/* ===== Product Modal logic ===== */
let currentProduct = null;
let currentCat = 'hot';
let currentVariantKey = '';

function isJabana(it){
  const a = (it.ar||''); const e=(it.en||'').toLowerCase();
  return a.includes('Ø¬Ø¨Ù†Ø©') || a.includes('Ø³ÙˆØ¯Ø§Ù†ÙŠØ©') || e.includes('jabana') || e.includes('sudanese');
}
function isWater(it){
  const a=(it.ar||''); const e=(it.en||'').toLowerCase();
  return a.includes('Ù…Ø§Ø¡') || e.includes('water');
}
function isMojito(it){
  const a=(it.ar||'').toLowerCase(); const e=(it.en||'').toLowerCase();
  return a.includes('Ù…ÙˆÙ‡ÙŠØªÙˆ') || e.includes('mojito');
}
function isHibiscusDrink(it){
  const a=(it.ar||'').toLowerCase(); const e=(it.en||'').toLowerCase();
  return a.includes('ÙƒØ±ÙƒØ¯ÙŠÙ‡') || a.includes('ÙƒØ±ÙƒØ¯ÙŠ') || e.includes('hibiscus');
}
function shouldHideExternalSugar(it){
  return isMojito(it) || isHibiscusDrink(it);
}
function isVariantItem(it){
  return !!(it && Array.isArray(it.variants) && it.variants.length);
}
function normalizeVariantKey(key){
  if(key === undefined || key === null) return '';
  return String(key).toLowerCase();
}
function variantKeyFromData(variant){
  if(!variant) return '';
  if(variant.key !== undefined && variant.key !== null) return normalizeVariantKey(variant.key);
  const fallback = variant.en || variant.ar || '';
  return normalizeVariantKey(fallback);
}
function getDefaultVariant(it){
  if(!isVariantItem(it)) return null;
  const desired = normalizeVariantKey(it.defaultVariantKey);
  if(desired){
    const match = it.variants.find(v=> variantKeyFromData(v) === desired);
    if(match) return match;
  }
  return it.variants.find(Boolean) || null;
}
function getVariantLabel(variant, langCode){
  if(!variant) return '';
  const primary = langCode==='ar' ? (variant.ar || variant.en || '') : (variant.en || variant.ar || '');
  return primary || '';
}
function getVariantPrice(it, variant){
  const value = variant && Number(variant.price);
  if(Number.isFinite(value)) return value;
  const base = Number(it && it.price);
  return Number.isFinite(base) ? base : NaN;
}
function getVariantCalories(it, variant){
  const value = variant && Number(variant.cal);
  if(Number.isFinite(value)) return value;
  const base = Number(it && it.cal);
  return Number.isFinite(base) ? base : NaN;
}
function getItemDisplayMetrics(it){
  if(!isVariantItem(it)){
    const price = Number(it && it.price);
    const cal = Number(it && it.cal);
    return { price: Number.isFinite(price) ? price : NaN, cal: Number.isFinite(cal) ? cal : NaN };
  }
  const def = getDefaultVariant(it);
  return {
    price: getVariantPrice(it, def),
    cal: getVariantCalories(it, def)
  };
}
function getSelectedVariant(it){
  if(!isVariantItem(it)) return null;
  const key = normalizeVariantKey(currentVariantKey);
  if(!key) return null;
  return it.variants.find(v=> variantKeyFromData(v) === key) || null;
}
function updateProductPriceAndCal(it, variant){
  const price = getVariantPrice(it, variant);
  const cal = getVariantCalories(it, variant);
  $('#pPrice').innerHTML = priceHTML(price);
  const calText = Number.isFinite(cal) ? `${cal} ${STRINGS[lang].kcal}` : (STRINGS[lang].kcal_unknown || 'â€”');
  $('#pCal').textContent = calText;
}
function updateVariantNote(it){
  const noteEl = document.getElementById('variantNote');
  if(!noteEl) return;
  if(!it || !isVariantItem(it)){
    noteEl.textContent = '';
    return;
  }
  const selected = getSelectedVariant(it);
  if(selected){
    const label = getVariantLabel(selected, lang);
    const template = STRINGS[lang].variant_selected || '';
    noteEl.textContent = template.replace('{variant}', label);
  } else {
    noteEl.textContent = STRINGS[lang].variant_note || '';
  }
}
function renderVariantOptions(it){
  const group = document.getElementById('variantGroup');
  const optionsEl = document.getElementById('variantOptions');
  if(!group || !optionsEl) return;
  if(!it || !isVariantItem(it)){
    group.style.display = 'none';
    optionsEl.innerHTML='';
    updateVariantNote(null);
    return;
  }
  group.style.display = 'flex';
  const headingEl = document.getElementById('variantHeading');
  if(headingEl) headingEl.textContent = STRINGS[lang].variant_heading || '';
  optionsEl.innerHTML='';
  const defaultVariant = getDefaultVariant(it);
  const defaultKey = variantKeyFromData(defaultVariant);
  (it.variants || []).forEach(variant=>{
    if(!variant) return;
    const key = variantKeyFromData(variant);
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='variant-btn';
    if(currentVariantKey && key === currentVariantKey) btn.classList.add('selected');
    const labelSpan = document.createElement('span');
    labelSpan.className='label';
    const labelText = getVariantLabel(variant, lang);
    const defaultTag = (defaultKey && key === defaultKey) ? (STRINGS[lang].variant_default_tag || '') : '';
    labelSpan.textContent = `${labelText}${defaultTag || ''}`;
    btn.appendChild(labelSpan);
    const metaSpan = document.createElement('span');
    metaSpan.className='meta';
    const price = getVariantPrice(it, variant);
    const cal = getVariantCalories(it, variant);
    const bits = [];
    if(Number.isFinite(price)) bits.push(`${price} ${lang==='ar'?'Ø±ÙŠØ§Ù„':'SAR'}`);
    if(Number.isFinite(cal)) bits.push(`${cal} ${STRINGS[lang].kcal}`);
    metaSpan.textContent = bits.join(' â€¢ ');
    btn.appendChild(metaSpan);
    btn.addEventListener('click', ()=> selectVariant(it, key));
    optionsEl.appendChild(btn);
  });
  updateVariantNote(it);
}
function selectVariant(it, key){
  currentVariantKey = normalizeVariantKey(key);
  const chosen = getSelectedVariant(it);
  updateProductPriceAndCal(it, chosen || getDefaultVariant(it));
  renderVariantOptions(it);
}
function resetVariantSelection(){
  currentVariantKey = '';
}
function toggleSugarExternalOption(hide){
  const wrap = document.getElementById('sugarExternalOption');
  if(!wrap) return;
  wrap.style.display = hide ? 'none' : 'inline-flex';
  const input = wrap.querySelector('input[name="sugar"][value="external"]');
  if(!input) return;
  if(hide){
    input.checked = false;
    const fallback = document.querySelector('input[name="sugar"][value="normal"]');
    if(fallback) fallback.checked = true;
  } else {
    input.checked = true;
  }
}

function updateCustomizationLabels(){
  $('#customTitle').textContent = STRINGS[lang].customize;
  $('#lblLessIce').textContent = STRINGS[lang].less_ice;
  $('#lblGinger').textContent = STRINGS[lang].ginger;
  $('#lblCardamom').textContent = STRINGS[lang].cardamom;
  $('#lblHeavy').textContent = STRINGS[lang].heavy;
  $('#lblLight').textContent = STRINGS[lang].light;
  $('#lblBalanced').textContent = STRINGS[lang].balanced;
  $('#backBtn').textContent = lang==='ar' ? 'Ø±Ø¬ÙˆØ¹' : 'Back';
  $('#addBtn').textContent = lang==='ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©' : 'Add to Cart';
  document.querySelector('#lblSugarExternal').textContent = STRINGS[lang].sugar_external;
  document.querySelector('#lblSugarNone').textContent = STRINGS[lang].sugar_none;
  document.querySelector('#lblSugarLess').textContent = STRINGS[lang].sugar_less;
  document.querySelector('#lblSugarNormal').textContent = STRINGS[lang].sugar_normal;
  document.querySelector('#lblWaterCold').textContent = STRINGS[lang].water_cold;
  document.querySelector('#lblWaterRoom').textContent = STRINGS[lang].water_room;
  const headingEl = document.getElementById('variantHeading');
  if(headingEl) headingEl.textContent = STRINGS[lang].variant_heading || '';
  updateVariantNote(currentProduct);
  if(currentProduct && isVariantItem(currentProduct)){
    renderVariantOptions(currentProduct);
  }
}

function openProduct(it, cat){
  currentProduct = it;
  currentCat = cat || 'hot';
  resetVariantSelection();
  $('#pImg').src = (it && it.img) || IMG_DEFAULT;
  $('#pName').textContent = (lang==='ar'?it.ar:it.en);
  updateProductPriceAndCal(it, getDefaultVariant(it));
  $('#pDesc').textContent = it['desc_'+lang] || autoDesc(it);
  $('#pQty').textContent = '1';
  updateCustomizationLabels();

  // reset radios
  document.querySelectorAll('input[name="sugar"]').forEach(r=> r.checked = (r.value==='external'));
  document.querySelectorAll('input[name="waterTemp"]').forEach(r=> r.checked = (r.value==='cold'));
  $('#optLessIce').checked = false;
  $('#optGinger').checked = false;
  $('#optCardamom').checked = false;
  document.querySelectorAll('input[name="strength"]').forEach(r=> r.checked = (r.value==='balanced'));

  // visibility
  const water = isWater(it);
  const jab = isJabana(it);

  toggleSugarExternalOption(shouldHideExternalSugar(it));
  document.getElementById('wrapLessIce').style.display = (currentCat==='cold' && !water) ? 'inline-flex' : 'none';
  document.getElementById('sugarGroup').style.display = (currentCat!=='dessert' && !water) ? 'flex' : 'none';
  document.getElementById('waterTempGroup').style.display = water ? 'flex' : 'none';
  document.getElementById('customJabana').style.display = jab ? 'flex' : 'none';
  document.getElementById('strengthGroup').style.display = jab ? 'flex' : 'none';

  renderVariantOptions(it);
  document.getElementById('productModal').style.display='flex';
}
function closeProduct(){ document.getElementById('productModal').style.display='none'; }
function incQty(){ let q=parseInt($('#pQty').textContent)||1; $('#pQty').textContent = Math.min(q+1,99); }
function decQty(){ let q=parseInt($('#pQty').textContent)||1; $('#pQty').textContent = Math.max(q-1,1); }

function gatherCustomization(selectedVariant){
  const opts = [];
  if(selectedVariant){
    const variantLabel = getVariantLabel(selectedVariant, lang);
    if(variantLabel) opts.push(variantLabel);
  }
  // water temp
  if(isWater(currentProduct)){
    const wt = (document.querySelector('input[name="waterTemp"]:checked')||{}).value || 'cold';
    opts.push(wt==='cold' ? STRINGS[lang].water_cold : STRINGS[lang].water_room);
    return opts;
  }
  // sugar
  if (document.getElementById('sugarGroup').style.display!=='none') {
    const sugar = (document.querySelector('input[name="sugar"]:checked')||{}).value || 'external';
    const sugarLabel = sugar==='external'?STRINGS[lang].sugar_external
                      : sugar==='none'?STRINGS[lang].sugar_none
                      : sugar==='less'?STRINGS[lang].sugar_less
                      : STRINGS[lang].sugar_normal;
    opts.push(sugarLabel);
  }
  // ice
  if($('#optLessIce').checked && currentCat==='cold') opts.push(STRINGS[lang].less_ice);
  // jabana
  if(isJabana(currentProduct)){
    if($('#optGinger').checked) opts.push(STRINGS[lang].ginger);
    if($('#optCardamom').checked) opts.push(STRINGS[lang].cardamom);
    const st = (document.querySelector('input[name="strength"]:checked')||{}).value || 'balanced';
    const stLabel = st==='heavy'?STRINGS[lang].heavy: st==='light'?STRINGS[lang].light: STRINGS[lang].balanced;
    opts.push(stLabel);
  }
  return opts;
}

function addCurrentToCart(){
  const q = parseInt($('#pQty').textContent)||1;
  const variant = getSelectedVariant(currentProduct);
  if(isVariantItem(currentProduct) && !variant){
    toast(STRINGS[lang].variant_required || STRINGS[lang].variant_note || '');
    return;
  }
  const options = gatherCustomization(variant);
  ensureTableSelection(()=>{
    addToCart(currentProduct, q, options, variant);
    closeProduct();
    toast(STRINGS[lang].added);
  });
}

/* ===== Cart logic ===== */
function openCart(){ renderCart(); document.getElementById('cartSheet').style.display='flex'; }
function closeCart(){ document.getElementById('cartSheet').style.display='none'; }
document.getElementById('cartFab').addEventListener('click', openCart);

function addToCart(it, qty=1, options=[], variant=null){
  if(!it) return;
  const variantKey = variant ? variantKeyFromData(variant) : '';
  const baseName = (it.en||it.ar||'');
  const keyParts = [baseName, variantKey || '-', options.join(',') || '-'];
  const key = keyParts.join('|');
  const nameArBase = it.ar || '';
  const nameEnBase = it.en || '';
  const variantLabelAr = variant ? getVariantLabel(variant, 'ar') : '';
  const variantLabelEn = variant ? getVariantLabel(variant, 'en') : '';
  const nameAr = variant ? `${nameArBase} (${variantLabelAr || variantLabelEn})` : nameArBase;
  const nameEn = variant ? `${nameEnBase} (${variantLabelEn || variantLabelAr})` : nameEnBase;
  const price = getVariantPrice(it, variant);
  const calories = getVariantCalories(it, variant);
  const img = (variant && variant.img) ? variant.img : (it.img || IMG_DEFAULT);
  const idx = cart.findIndex(x=>x.key===key);
  if(idx>-1){
    cart[idx].qty += qty;
  }
  else{
    cart.push({
      key,
      name_ar: nameAr,
      name_en: nameEn,
      base_ar: nameArBase,
      base_en: nameEnBase,
      variant_key: variantKey,
      price: Number.isFinite(price) ? price : 0,
      cal: Number.isFinite(calories) ? calories : null,
      img,
      qty,
      options
    });
  }
  saveCart(); updateCartBadge();
}
function changeQty(key, delta){
  const i = cart.findIndex(x=>x.key===key);
  if(i>-1){
    cart[i].qty += delta;
    if(cart[i].qty<=0) cart.splice(i,1);
    saveCart(); renderCart(); updateCartBadge();
  }
}
function clearCart(){ cart = []; saveCart(); renderCart(); updateCartBadge(); }

function renderCart(){
  const wrap = $('#cartItems');
  wrap.innerHTML = '';
  if(cart.length===0){
    $('#emptyText').style.display='block';
  } else {
    $('#emptyText').style.display='none';
    cart.forEach(it=>{
      const name = (lang==='ar'?it.name_ar:it.name_en);
      const joiner = lang==='ar' ? 'Ø› ' : ' / ';
      const optsText = (it.options && it.options.length) ? ' â€¢ ' + it.options.join(joiner) : '';
      const calRaw = it.cal;
      const calNumber = Number(calRaw);
      const hasCal = calRaw !== null && calRaw !== undefined && Number.isFinite(calNumber);
      const calText = hasCal ? `${calNumber} ${STRINGS[lang].kcal}` : (STRINGS[lang].kcal_unknown || 'â€”');
      wrap.insertAdjacentHTML('beforeend', `
        <div class="cart-item">
          <div class="thumb"><img src="${it.img}" alt="${name}"></div>
          <div>
            <div class="title">${name}</div>
            <div class="meta">${calText}${optsText}</div>
            <div class="price" style="margin-top:4px">
              ${priceHTML(it.price)}
            </div>
          </div>
          <div class="qty">
            <button onclick="changeQty('${it.key.replace(/'/g,"&#39;")}',-1)">âˆ’</button>
            <span style="min-width:24px;text-align:center">${it.qty}</span>
            <button onclick="changeQty('${it.key.replace(/'/g,"&#39;")}',+1)">+</button>
          </div>
        </div>
      `);
    });
  }
  const subtotal = cartTotal();
  const loyaltyCalc = calculateLoyaltyRewards(cart);
  const loyaltyDiscount = loyaltyCalc.discount;
  const loyaltyRewards = loyaltyCalc.rewards;
  const total = Math.max(subtotal - loyaltyDiscount, 0);
  $('#cartTotal').innerHTML = priceHTML(total);
  const loyaltyNoteEl = document.getElementById('cartLoyaltyNote');
  if(loyaltyNoteEl){
    if(loyaltyDiscount > 0 && loyaltyRewards.length){
      const currency = lang==='ar'?'Ø±ÙŠØ§Ù„':'SAR';
      const parts = loyaltyRewards.map(reward=>{
        const drink = lang==='ar' ? (reward.drink_ar || reward.drink_en || '') : (reward.drink_en || reward.drink_ar || '');
        const qty = reward.freebies || 1;
        const discount = Number(reward.discount) || 0;
        return `${drink} Ã—${qty} (âˆ’${discount} ${currency})`;
      });
      loyaltyNoteEl.innerHTML = `ğŸ ${STRINGS[lang].loyalty_reward_label}: ${parts.join(' â€¢ ')}`;
      loyaltyNoteEl.style.display = 'block';
    } else {
      loyaltyNoteEl.style.display = 'none';
      loyaltyNoteEl.textContent = '';
    }
  }
  const discountInputEl = document.getElementById('discountInput');
  if(discountInputEl && discountInputEl !== document.activeElement){
    discountInputEl.value = currentDiscountCode;
  }
}

const discountInputEl = document.getElementById('discountInput');
if(discountInputEl){
  discountInputEl.addEventListener('input', ()=>{
    currentDiscountCode = discountInputEl.value.trim();
  });
}

function resetDiscountCode(){
  currentDiscountCode = '';
  if(discountInputEl) discountInputEl.value = '';
}

function calculateLoyaltyRewards(cartItems){
  const rewards = [];
  let totalDiscount = 0;
  const threshold = Math.max(1, loyaltySettings.requiredCount || 5);
  const globalState = loyaltyState.global || { count:0, rewardLevel:0 };
  let count = Number(globalState.count) || 0;
  (cartItems || []).forEach(it=>{
    if(!it) return;
    const qty = Number(it.qty) || 0;
    if(!qty) return;
    for(let i=0; i<qty; i++){
      count += 1;
      if(count % threshold === 0){
        const price = Number(it.price) || 0;
        totalDiscount += price;
        rewards.push({
          freebies: 1,
          discount: price,
          drink_ar: it.name_ar || '',
          drink_en: it.name_en || ''
        });
      }
    }
  });
  return { rewards, discount: totalDiscount, threshold };
}

function handleLoyaltyRewards(entry){
  if(!entry || !Array.isArray(entry.items)) return;
  const threshold = Math.max(1, loyaltySettings.requiredCount || 5);
  const globalState = loyaltyState.global || { count:0, rewardLevel:0, history:[] };
  let count = Number(globalState.count) || 0;
  const rewardsGranted = [];
  entry.items.forEach(it=>{
    const qty = Number(it && it.qty) || 0;
    for(let i=0; i<qty; i++){
      count += 1;
      if(count % threshold === 0){
        rewardsGranted.push({
          drink_ar: it.name_ar || '',
          drink_en: it.name_en || '',
          timestamp: Date.now()
        });
      }
    }
  });
  globalState.count = count;
  globalState.rewardLevel = Math.floor(count / threshold);
  if(!Array.isArray(globalState.history)) globalState.history = [];
  if(rewardsGranted.length){
    globalState.history = rewardsGranted.concat(globalState.history).slice(0, 50);
    const latest = rewardsGranted[rewardsGranted.length-1];
    showLoyaltyModal({ drink_ar: latest.drink_ar, drink_en: latest.drink_en, count: threshold });
  }
  loyaltyState.global = globalState;
  saveLoyaltyState();
}

/* ===== Send order to Telegram ===== */
function performSendOrder(tableIdOverride){
  const stamp = buildTimestampInfo();
  const tableId = tableIdOverride || getCurrentTableValue() || '?';
  const itemLines = cart.map(it=>{
    const n = it.name_ar || it.name_en || '';
    const opt = (it.options && it.options.length) ? ` (${it.options.join('ØŒ ')})` : '';
    return `â€¢ ${n}${opt} Ã—${it.qty} â€” ${it.qty * it.price} Ø±ÙŠØ§Ù„`;
  });
  const subtotal = cartTotal();
  const loyaltyCalc = calculateLoyaltyRewards(cart);
  const loyaltyDiscount = loyaltyCalc.discount;
  const loyaltyRewards = loyaltyCalc.rewards;
  const total = Math.max(subtotal - loyaltyDiscount, 0);
  const headerLine = `ğŸ§¾ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ â€” Ø·Ø§ÙˆÙ„Ø© ${tableId}`;
  const orderId = `N${stamp.now.getTime().toString(36).toUpperCase()}`;
  const orderIdLine = `ğŸ†” ${STRINGS.ar.order_id_label}: ${orderId}`;
  const timeLine = `â° ${STRINGS.ar.order_time_label}: ${stamp.date} â€” ${stamp.time}`;
  const discountCode = currentDiscountCode.trim();
  const messageLines = [
    headerLine,
    orderIdLine,
    timeLine,
    'ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:',
    ...itemLines
  ];
  if(loyaltyRewards.length){
    loyaltyRewards.forEach(reward=>{
      const drinkAr = reward.drink_ar || reward.drink_en || '';
      messageLines.push(`ğŸ ${STRINGS.ar.loyalty_reward_label}: ${drinkAr} Ù…Ø¬Ø§Ù†ÙŠ`);
    });
  }
  if(loyaltyDiscount > 0){
    messageLines.push(`ğŸ’ ${STRINGS.ar.loyalty_discount_label}: -${loyaltyDiscount} Ø±ÙŠØ§Ù„`);
  }
  if(discountCode){
    messageLines.push(`ğŸŸï¸ ${STRINGS.ar.discount_code_label}: ${discountCode}`);
  }
  const customerNameValue = customerProfile && customerProfile.name ? customerProfile.name : '';
  const customerPhoneValue = customerProfile && customerProfile.phone ? customerProfile.phone : '';
  if(customerNameValue){
    messageLines.push(`ğŸ‘¤ ${STRINGS.ar.customer_name_label}: ${customerNameValue}`);
  }
  if(customerPhoneValue){
    messageLines.push(`ğŸ“ ${STRINGS.ar.customer_phone_label}: ${customerPhoneValue}`);
  }
  messageLines.push(`ğŸ’µ ${STRINGS.ar.total_due_label || 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚'}: ${total} Ø±ÙŠØ§Ù„`);
  const text = messageLines.map(encodeURIComponent).join('%0A%0A');

  const orderEntry = {
    id: orderId,
    orderId,
    table: tableId,
    subtotal,
    loyaltyDiscount,
    total,
    timestamp: stamp.now.getTime(),
    discountCode,
    customer: {
      id: getActiveCustomerId(),
      name: customerNameValue || '',
      phone: customerPhoneValue || ''
    },
    loyaltyRewards,
    items: cart.map(it=>({
      name_ar: it.name_ar,
      name_en: it.name_en,
      qty: it.qty,
      price: it.price,
      options: Array.isArray(it.options) ? it.options : []
    }))
  };

  const statusBase = new URL('order-status.html', window.location.href);
  statusBase.search = '';
  statusBase.searchParams.set('order', orderId);
  statusBase.searchParams.set('table', tableId);
  statusBase.searchParams.set('issued', String(stamp.now.getTime()));
  statusBase.searchParams.set('chat', TELEGRAM_CHAT_ID_NEW);
  const acceptUrl = new URL(statusBase.toString());
  acceptUrl.searchParams.set('action', 'accept');

  const replyMarkup = encodeURIComponent(JSON.stringify({
    inline_keyboard: [
      [{ text: 'âœ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨', url: acceptUrl.toString() }]
    ]
  }));

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID_NEW}&text=${text}&reply_markup=${replyMarkup}`;
  fetch(url)
    .then(async res=>{
      if(!res.ok) throw new Error('telegram');
      await recordOrderLog(orderEntry);
      handleLoyaltyRewards(orderEntry);
      toast(STRINGS[lang].order_sent_saved);
      await afterTelegramHook(total);
      clearCart();
      resetDiscountCode();
      closeCart();
    })
    .catch(()=> { toast(STRINGS[lang].order_send_failed); });
}

function sendOrder(){
  if(cart.length===0){ toast(lang==='ar'?'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©':'Cart is empty'); return; }
  ensureTableSelection((tableId)=>{
    performSendOrder(tableId);
  }, { restoreCart: isCartOpen() });
}

/* ===== Toast ===== */
function toast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.bottom='86px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
  t.style.padding='12px 20px'; t.style.borderRadius='12px'; t.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';
  t.style.zIndex='400'; t.style.opacity='0'; t.style.transition='opacity .3s ease';
  t.style.background = document.body.classList.contains('dark') ? 'var(--brand-dark)' : 'var(--brand)';
  t.style.color = '#fff';
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity='1', 20);
  setTimeout(()=> { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 2500);
}

window.addEventListener('storage', (event)=>{
  if(event.key === THEME_KEY){
    themeConfig = loadThemeConfig();
    applyTheme(themeConfig);
  }
  if(event.key === PROMOTIONS_KEY){
    promotions = loadPromotions();
    renderPromotionsBanner();
  }
  if(event.key === DASHBOARD_CONFIG_KEY){
    dashboardConfig = loadDashboardConfig();
    loyaltySettings = getLoyaltySettings();
  }
  if(event.key === CUSTOMER_REGISTRY_KEY){
    customerRegistry = loadCustomerRegistry();
  }
  if(event.key === ORDER_LOG_KEY){
    orderLog = loadOrderLog();
  }
});

/* ===== Init ===== */
async function init(){
  localStorage.removeItem('nima.table');
  if(customerProfile && (customerProfile.name || customerProfile.phone)){
    if(!customerProfile.id){
      customerProfile.id = generateCustomerId(customerProfile.name || '', customerProfile.phone || '');
      saveCustomerProfileData(customerProfile);
    }
    ensureCustomerRegistryEntry(customerProfile.id, customerProfile);
    ensureCustomerLog(customerProfile.id, customerProfile);
  }
  await fetchItems();
  renderAll(); updateLangBtn(); updateCartBadge();
  if(customerProfile && (customerProfile.name || customerProfile.phone)){
    maybeToastGreeting();
  } else {
    setTimeout(()=> openProfileModal(false), 900);
  }
}
init();
  </script>
</body>
</html>
