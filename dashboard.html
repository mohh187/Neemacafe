<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Neema Cafe SaaS</title>
  <style>
    :root {
      --bg: #f6f5f3;
      --card: #ffffff;
      --text: #1f1f1f;
      --muted: #6b6b6b;
      --brand: #8b5e3c;
      --brand-dark: #70492d;
      --accent: #d4a373;
      --border: #e4ded7;
      --radius: 18px;
      --shadow: 0 18px 40px rgba(112, 73, 45, 0.12);
      --shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.08);
      --success: #2f9d61;
      --danger: #c0392b;
      --warning: #d48626;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Tajawal", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      font-family: inherit;
    }

    .hidden {
      display: none !important;
    }

    /* ---------- Auth Screen ---------- */
    .auth-screen {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 32px 16px;
      background: radial-gradient(circle at top right, rgba(212, 163, 115, 0.18), transparent 60%),
        radial-gradient(circle at bottom left, rgba(112, 73, 45, 0.14), transparent 60%), var(--bg);
    }

    .auth-card {
      background: var(--card);
      border-radius: 26px;
      box-shadow: var(--shadow);
      max-width: 420px;
      width: 100%;
      padding: 32px 28px 36px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .auth-card header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      text-align: center;
    }

    .auth-card header h1 {
      margin: 0;
      font-size: 24px;
    }

    .auth-card header p {
      margin: 0;
      color: var(--muted);
      line-height: 1.6;
      font-size: 15px;
    }

    .auth-card form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    input[type="email"],
    input[type="password"],
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 15px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(139, 94, 60, 0.15);
    }

    textarea {
      resize: vertical;
      min-height: 96px;
    }

    .btn {
      border-radius: 14px;
      border: 1px solid transparent;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      color: #fff;
      box-shadow: 0 12px 24px rgba(112, 73, 45, 0.24);
    }

    .btn.secondary {
      background: rgba(139, 94, 60, 0.12);
      color: var(--brand-dark);
      border-color: rgba(139, 94, 60, 0.24);
    }

    .btn.text {
      background: transparent;
      color: var(--brand);
      border-color: transparent;
    }

    .btn.danger {
      background: rgba(192, 57, 43, 0.12);
      color: var(--danger);
      border-color: rgba(192, 57, 43, 0.24);
    }

    .btn.small {
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
    }

    .btn.icon {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 50%;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(139, 94, 60, 0.12);
      color: var(--brand-dark);
      font-weight: 700;
      font-size: 12px;
    }

    .pill-success {
      background: rgba(47, 157, 97, 0.14);
      color: var(--success);
    }

    .pill-danger {
      background: rgba(192, 57, 43, 0.12);
      color: var(--danger);
    }

    .form-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ---------- Dashboard Layout ---------- */
    .app {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      min-height: 100vh;
    }

    .sidebar {
      background: #fff;
      border-left: 1px solid var(--border);
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      box-shadow: 10px 0 40px rgba(0, 0, 0, 0.06);
    }

    .sidebar .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar .brand img {
      width: 52px;
      height: 52px;
      border-radius: 18px;
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .sidebar .brand h2 {
      margin: 0;
      font-size: 20px;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-list button {
      width: 100%;
      justify-content: flex-start;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
    }

    .nav-list button.active {
      background: rgba(139, 94, 60, 0.12);
      color: var(--brand-dark);
    }

    .sidebar footer {
      margin-top: auto;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.8;
    }

    .content {
      padding: 32px clamp(18px, 4vw, 46px);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .content-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .content-header .headline h1 {
      margin: 0;
      font-size: 28px;
    }

    .content-header .headline p {
      margin: 6px 0 0;
      color: var(--muted);
    }

    .content-header .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .view {
      display: none;
      flex-direction: column;
      gap: 20px;
    }

    .view.active {
      display: flex;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(112, 73, 45, 0.06);
      box-shadow: var(--shadow-soft);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    .stat {
      padding: 18px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(139, 94, 60, 0.1), rgba(212, 163, 115, 0.12));
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .stat span {
      color: var(--muted);
      font-size: 13px;
    }

    .stat strong {
      font-size: 22px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    table thead {
      background: rgba(139, 94, 60, 0.06);
    }

    table th,
    table td {
      text-align: right;
      padding: 12px 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      vertical-align: top;
    }

    table tbody tr:hover {
      background: rgba(139, 94, 60, 0.04);
    }

    .table-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .inline-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .inline-form.full textarea {
      grid-column: 1 / -1;
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .switch input {
      width: 18px;
      height: 18px;
    }

    .builder-layout {
      display: grid;
      grid-template-columns: minmax(220px, 320px) minmax(0, 1fr);
      gap: 18px;
    }

    .category-list,
    .group-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .category-list li,
    .group-list li {
      border: 1px solid rgba(139, 94, 60, 0.14);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.9);
      transition: border-color 0.2s ease, transform 0.15s ease;
    }

    .category-list li.active,
    .group-list li.active {
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(139, 94, 60, 0.18);
    }

    .category-list li:hover,
    .group-list li:hover {
      transform: translateY(-2px);
    }

    .entity-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .entity-info small {
      color: var(--muted);
    }

    .editor-panel {
      border: 1px dashed rgba(139, 94, 60, 0.3);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: rgba(139, 94, 60, 0.04);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 4px 10px;
      background: rgba(139, 94, 60, 0.1);
      border-radius: 999px;
      font-size: 12px;
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 24px 12px;
      border: 1px dashed rgba(0, 0, 0, 0.06);
      border-radius: 16px;
    }

    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(120%);
      background: var(--brand);
      color: #fff;
      padding: 12px 18px;
      border-radius: 999px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.18);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.3s ease, opacity 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    @media (max-width: 960px) {
      .app {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: sticky;
        top: 0;
        z-index: 50;
        flex-direction: row;
        gap: 16px;
        overflow-x: auto;
        padding: 16px;
      }

      .sidebar .brand {
        display: none;
      }

      .nav-list {
        flex-direction: row;
        gap: 8px;
      }

      .nav-list button {
        white-space: nowrap;
      }

      .builder-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      .content-header {
        flex-direction: column;
        align-items: stretch;
      }

      .inline-form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="loginView" class="auth-screen">
    <div class="auth-card">
      <header>
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
        <p>Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙÙŠ Ù…Ù†ØµØ© Neema Cafe Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.</p>
      </header>
      <form id="loginForm">
        <label>
          Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
          <input type="email" name="email" required placeholder="admin@neema.sa" autocomplete="username" />
        </label>
        <label>
          ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          <input type="password" name="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </label>
        <div class="form-footer">
          <button type="submit" class="btn primary">Ø¯Ø®ÙˆÙ„</button>
        </div>
      </form>
      <section>
        <h3 style="margin:0;font-size:16px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</h3>
        <p style="margin:6px 0 0;color:var(--muted);font-size:14px;">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ: <strong>admin@neema.sa</strong> / <strong>Neema@123</strong></p>
        <p style="margin:6px 0 0;color:var(--muted);font-size:13px;">ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</p>
      </section>
    </div>
  </div>

  <div id="dashboard" class="app hidden">
    <aside class="sidebar">
      <div class="brand">
        <img src="https://i.postimg.cc/Y0GT5M1f/image.png" alt="Neema Cafe" />
        <div>
          <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù†ÙŠÙ…Ø©</h2>
          <small style="color:var(--muted);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ ÙˆØ§Ù„Ø³Ø­Ø§Ø¨Ø©</small>
        </div>
      </div>
      <nav class="nav-list">
        <button class="active" data-view="overview">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
        <button data-view="menu">Ù…ØµÙ…Ù… Ø§Ù„Ù…Ù†ÙŠÙˆ</button>
        <button data-view="users">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button data-view="insights">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ</button>
        <button data-view="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </nav>
      <footer>
        <div>Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong id="currentUserName">â€”</strong></div>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="logoutBtn" class="btn text small">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
        <div style="margin-top:12px;">Â© Neema Cafe Cloud</div>
      </footer>
    </aside>

    <main class="content">
      <header class="content-header">
        <div class="headline">
          <h1 id="viewTitle">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
          <p id="viewSubtitle">ØªØ§Ø¨Ø¹ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†ÙŠÙˆØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§ÙØŒ ÙˆØªØ­ÙƒÙ… ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙØ±Ù‚.</p>
        </div>
        <div class="actions">
          <a class="btn primary" href="https://neemacafe.vercel.app/" target="_blank" rel="noopener">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ø¹Ø§Ù… â†—ï¸</a>
          <button id="quickAddItem" class="btn secondary">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø³Ø±ÙŠØ¹</button>
          <button id="quickDownload" class="btn text">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        </div>
      </header>

      <section id="overviewView" class="view active">
        <div class="stats-grid" id="overviewStats"></div>
        <div class="card">
          <div class="card-header">
            <h3>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©</h3>
            <span class="badge" id="urgentCount">0 Ø¨Ù†ÙˆØ¯</span>
          </div>
          <div id="urgentTasks" class="list"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Ø¢Ø®Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</h3>
            <span class="badge" id="activityCount">0 Ø­Ø±ÙƒØ©</span>
          </div>
          <ul id="activityLog" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px;"></ul>
        </div>
      </section>

      <section id="menuView" class="view">
        <div class="builder-layout">
          <div class="card">
            <div class="card-header">
              <h3>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
              <button id="addCategoryBtn" class="btn secondary small">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
            </div>
            <ul id="categoryList" class="category-list"></ul>
            <form id="categoryForm" class="editor-panel hidden">
              <input type="hidden" name="id" />
              <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ø¹Ø±Ø¨ÙŠ)
                <input type="text" name="nameAr" required />
              </label>
              <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
                <input type="text" name="nameEn" required />
              </label>
              <label>Ø§Ù„Ù…Ø¹Ø±Ù (Slug)
                <input type="text" name="slug" required pattern="[a-z0-9-]+" />
              </label>
              <div class="form-footer">
                <button type="button" data-action="cancel" class="btn text">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="submit" class="btn primary">Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù…</button>
              </div>
            </form>
          </div>

          <div class="card" style="gap:20px;">
            <div>
              <div class="card-header">
                <h3>Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</h3>
                <button id="addGroupBtn" class="btn secondary small">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø©</button>
              </div>
              <ul id="groupList" class="group-list"></ul>
              <form id="groupForm" class="editor-panel hidden">
                <input type="hidden" name="id" />
                <label>Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© (Ø¹Ø±Ø¨ÙŠ)
                  <input type="text" name="nameAr" required />
                </label>
                <label>Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
                  <input type="text" name="nameEn" required />
                </label>
                <label>Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
                  <input type="text" name="slug" required pattern="[a-z0-9-]+" />
                </label>
                <div class="form-footer">
                  <button type="button" data-action="cancel" class="btn text">Ø¥Ù„ØºØ§Ø¡</button>
                  <button type="submit" class="btn primary">Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø©</button>
                </div>
              </form>
            </div>
            <div>
              <div class="card-header">
                <h3>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h3>
                <button id="addItemBtn" class="btn secondary small">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
              </div>
              <div id="itemsTableWrapper"></div>
              <form id="itemForm" class="editor-panel hidden">
                <input type="hidden" name="id" />
                <div class="inline-form full">
                  <label>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù (Ø¹Ø±Ø¨ÙŠ)
                    <input type="text" name="nameAr" required />
                  </label>
                  <label>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
                    <input type="text" name="nameEn" required />
                  </label>
                  <label>Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)
                    <input type="number" name="price" min="0" step="0.5" required />
                  </label>
                  <label>Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
                    <input type="number" name="calories" min="0" step="1" />
                  </label>
                  <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
                    <input type="text" name="image" placeholder="https://" />
                  </label>
                  <label>ÙˆØ³ÙˆÙ… Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)
                    <input type="text" name="tags" placeholder="Ù‚Ù‡ÙˆØ©ØŒ Ù…Ù…ÙŠØ²" />
                  </label>
                  <label class="switch">
                    <input type="checkbox" name="available" checked />
                    Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø¨
                  </label>
                  <label class="switch">
                    <input type="checkbox" name="featured" />
                    ØµÙ†Ù Ù…Ù…ÙŠØ² ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                  </label>
                  <label class="switch">
                    <input type="checkbox" name="spicy" />
                    ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†ÙƒÙ‡Ø© Ø­Ø§Ø±Ø©
                  </label>
                  <label class="switch">
                    <input type="checkbox" name="seasonal" />
                    ØµÙ†Ù Ù…ÙˆØ³Ù…ÙŠ
                  </label>
                  <label style="grid-column:1 / -1;">ÙˆØµÙ Ù…Ø®ØªØµØ±
                    <textarea name="description" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ"></textarea>
                  </label>
                </div>
                <div class="form-footer">
                  <button type="button" data-action="cancel" class="btn text">Ø¥Ù„ØºØ§Ø¡</button>
                  <button type="submit" class="btn primary">Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="usersView" class="view">
        <div class="card">
          <div class="card-header">
            <h3>Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ÙØ±Ù‚</h3>
            <button id="addUserBtn" class="btn secondary small">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          </div>
          <div class="table-wrapper" style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                  <th>Ø§Ù„Ø¯ÙˆØ±</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="userTable"></tbody>
            </table>
          </div>
          <form id="userForm" class="editor-panel hidden">
            <input type="hidden" name="id" />
            <div class="inline-form">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
                <input type="text" name="name" required />
              </label>
              <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                <input type="email" name="email" required />
              </label>
              <label>Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
                <select name="role" required>
                  <option value="admin">Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                  <option value="manager">Ù…Ø¯ÙŠØ± ÙØ±Ø¹</option>
                  <option value="staff">Ù…ÙˆØ¸Ù Ø®Ø¯Ù…Ø©</option>
                  <option value="viewer">Ø¹Ø±Ø¶ ÙÙ‚Ø·</option>
                </select>
              </label>
              <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                <input type="text" name="password" required />
              </label>
              <label>Ø§Ù„Ø­Ø§Ù„Ø©
                <select name="status" required>
                  <option value="active">Ù†Ø´Ø·</option>
                  <option value="suspended">Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªÙ‹Ø§</option>
                  <option value="invited">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„</option>
                </select>
              </label>
            </div>
            <div class="form-footer">
              <button type="button" data-action="cancel" class="btn text">Ø¥Ù„ØºØ§Ø¡</button>
              <button type="submit" class="btn primary">Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
            </div>
          </form>
        </div>
      </section>

      <section id="insightsView" class="view">
        <div class="stats-grid" id="insightHighlights"></div>
        <div class="card">
          <div class="card-header">
            <h3>Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</h3>
          </div>
          <ul id="recommendations" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px;"></ul>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</h3>
            <span class="badge" id="flaggedCount">0 ØµÙ†Ù</span>
          </div>
          <div id="flaggedItems"></div>
        </div>
      </section>

      <section id="settingsView" class="view">
        <div class="card">
          <div class="card-header">
            <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h3>
          </div>
          <div class="inline-form full">
            <label style="grid-column:1 / -1;">ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ
              <textarea id="exportTextarea" readonly style="min-height:120px;" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù…Ù„Ù JSON Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ±"></textarea>
            </label>
            <div class="form-footer" style="justify-content:flex-start;">
              <button id="exportJson" class="btn secondary" type="button">ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù JSON</button>
              <button id="copyExport" class="btn text" type="button">Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©</button>
            </div>
            <label style="grid-column:1 / -1;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† JSON
              <textarea id="importTextarea" placeholder="Ø£Ù„ØµÙ‚ Ù…Ø­ØªÙˆÙ‰ JSON Ù„Ù„Ù…Ù†ÙŠÙˆ Ù‡Ù†Ø§"></textarea>
            </label>
            <div class="form-footer" style="justify-content:flex-start;">
              <button id="importJson" class="btn primary" type="button">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ­Ø¯ÙŠØ«</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h3>Ø£Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
          </div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <p style="margin:0;color:var(--muted);">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ø¨Ø± Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ù…Ø²ÙˆØ¯ Ù‡ÙˆÙŠØ©.</p>
            <form id="passwordForm" class="inline-form" style="max-width:520px;">
              <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                <input type="password" name="current" required />
              </label>
              <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                <input type="password" name="next" required />
              </label>
              <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                <input type="password" name="confirm" required />
              </label>
              <div class="form-footer" style="grid-column:1 / -1;">
                <button type="submit" class="btn primary">ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>
  <script src="menu-data.js"></script>
  <script type="module">
    const MENU_KEY = 'neema-dashboard-menu-v1';
    const USER_KEY = 'neema-dashboard-users-v1';
    const SESSION_KEY = 'neema-dashboard-session-v1';
    const ACTIVITY_KEY = 'neema-dashboard-activity-v1';

    const DEFAULT_LABELS = {
      categories: {
        hot: { ar: 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø³Ø§Ø®Ù†Ø©', en: 'Hot Beverages' },
        cold: { ar: 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©', en: 'Cold Beverages' },
        dessert: { ar: 'Ø­Ù„ÙˆÙŠØ§Øª ÙˆÙ…Ø®Ø¨ÙˆØ²Ø§Øª', en: 'Desserts' }
      },
      groups: {
        hot: {
          coffee: { ar: 'Ù‚Ù‡ÙˆØ© Ø³Ø§Ø®Ù†Ø©', en: 'Hot Coffee' },
          tea: { ar: 'Ø´Ø§ÙŠ ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª Ø®Ø§ØµØ©', en: 'Tea & Specialties' }
        },
        cold: {
          coffee: { ar: 'Ù‚Ù‡ÙˆØ© Ø¨Ø§Ø±Ø¯Ø©', en: 'Iced Coffee' },
          mojito: { ar: 'Ù…ÙˆÙ‡ÙŠØªÙˆ ÙˆÙ…Ù†Ø¹Ø´Ø§Øª', en: 'Mojitos & Refreshers' },
          other: { ar: 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø£Ø®Ø±Ù‰', en: 'Other Drinks' }
        },
        dessert: {
          cake: { ar: 'ÙƒØ¹ÙƒØ§Øª ÙˆØ­Ù„ÙˆÙŠØ§Øª', en: 'Cakes & Desserts' },
          side: { ar: 'Ù…Ø®Ø¨ÙˆØ²Ø§Øª Ø¬Ø§Ù†Ø¨ÙŠØ©', en: 'Side Treats' }
        }
      }
    };

    const DEFAULT_ADMIN = {
      id: 'admin-account',
      name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
      email: 'admin@neema.sa',
      role: 'admin',
      status: 'active',
      password: 'Neema@123',
      updatedAt: new Date().toISOString()
    };

    const state = {
      menu: loadMenuState(),
      users: loadUserState(),
      session: loadSession(),
      activity: loadActivity(),
      view: 'overview',
      selectedCategoryId: null,
      selectedGroupId: null
    };

    ensureAdminExists();

    const loginView = document.getElementById('loginView');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('loginForm');
    const currentUserName = document.getElementById('currentUserName');
    const logoutBtn = document.getElementById('logoutBtn');
    const navButtons = document.querySelectorAll('.nav-list button');
    const viewTitle = document.getElementById('viewTitle');
    const viewSubtitle = document.getElementById('viewSubtitle');
    const quickAddItem = document.getElementById('quickAddItem');
    const quickDownload = document.getElementById('quickDownload');

    const overviewStats = document.getElementById('overviewStats');
    const urgentCount = document.getElementById('urgentCount');
    const urgentTasks = document.getElementById('urgentTasks');
    const activityCount = document.getElementById('activityCount');
    const activityLog = document.getElementById('activityLog');

    const categoryList = document.getElementById('categoryList');
    const categoryForm = document.getElementById('categoryForm');
    const addCategoryBtn = document.getElementById('addCategoryBtn');

    const groupList = document.getElementById('groupList');
    const groupForm = document.getElementById('groupForm');
    const addGroupBtn = document.getElementById('addGroupBtn');

    const itemsTableWrapper = document.getElementById('itemsTableWrapper');
    const itemForm = document.getElementById('itemForm');
    const addItemBtn = document.getElementById('addItemBtn');

    const userTable = document.getElementById('userTable');
    const userForm = document.getElementById('userForm');
    const addUserBtn = document.getElementById('addUserBtn');

    const insightHighlights = document.getElementById('insightHighlights');
    const recommendations = document.getElementById('recommendations');
    const flaggedItems = document.getElementById('flaggedItems');
    const flaggedCount = document.getElementById('flaggedCount');

    const exportTextarea = document.getElementById('exportTextarea');
    const exportJsonBtn = document.getElementById('exportJson');
    const copyExportBtn = document.getElementById('copyExport');
    const importTextarea = document.getElementById('importTextarea');
    const importJsonBtn = document.getElementById('importJson');
    const passwordForm = document.getElementById('passwordForm');

    const toast = document.getElementById('toast');

    if (state.session) {
      enterDashboard();
    }

    loginForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const formData = new FormData(loginForm);
      const email = String(formData.get('email')).trim().toLowerCase();
      const password = String(formData.get('password')).trim();

      const user = state.users.find((u) => u.email.toLowerCase() === email);
      if (!user) {
        return showToast('Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.');
      }

      if (user.password !== password) {
        return showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
      }

      if (user.status !== 'active') {
        return showToast('Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.');
      }

      if (user.role !== 'admin') {
        return showToast('ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·.');
      }

      state.session = { userId: user.id, role: user.role, time: Date.now() };
      sessionStorage.setItem(SESSION_KEY, JSON.stringify(state.session));
      addActivity(`ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ${user.name}`);
      enterDashboard();
      loginForm.reset();
    });

    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem(SESSION_KEY);
      state.session = null;
      dashboard.classList.add('hidden');
      loginView.classList.remove('hidden');
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.');
    });

    navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        if (!btn.classList.contains('active')) {
          navButtons.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          state.view = btn.dataset.view;
          updateView();
        }
      });
    });

    addCategoryBtn.addEventListener('click', () => {
      toggleEditor(categoryForm, null);
    });

    addGroupBtn.addEventListener('click', () => {
      if (!state.selectedCategoryId) {
        showToast('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø±Ø¦ÙŠØ³ÙŠÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      toggleEditor(groupForm, null);
    });

    addItemBtn.addEventListener('click', () => {
      if (!state.selectedCategoryId || !state.selectedGroupId) {
        showToast('Ø§Ø®ØªØ± ÙØ¦Ø© ÙØ±Ø¹ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù.');
        return;
      }
      toggleEditor(itemForm, null);
    });

    quickAddItem.addEventListener('click', () => {
      state.view = 'menu';
      updateView();
      toggleEditor(itemForm, null);
    });

    quickDownload.addEventListener('click', () => {
      exportJson();
      showToast('ØªÙ… ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù JSON Ù„Ù„Ù…Ù†ÙŠÙˆ.');
    });

    categoryForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const data = formToObject(categoryForm);
      const isEdit = Boolean(data.id);

      if (isEdit) {
        const category = state.menu.categories.find((cat) => cat.id === data.id);
        if (!category) return;
        category.nameAr = data.nameAr;
        category.nameEn = data.nameEn;
        category.slug = data.slug;
        addActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… ${data.nameAr}`);
      } else {
        const newCategory = {
          id: generateId('cat'),
          nameAr: data.nameAr,
          nameEn: data.nameEn,
          slug: data.slug,
          groups: []
        };
        state.menu.categories.push(newCategory);
        state.selectedCategoryId = newCategory.id;
        addActivity(`Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ ${data.nameAr}`);
      }

      saveMenuState();
      toggleEditor(categoryForm, null, true);
      renderMenuBuilder();
      showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù….');
    });

    categoryForm.querySelector('[data-action="cancel"]').addEventListener('click', () => {
      toggleEditor(categoryForm, null, true);
    });

    groupForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const data = formToObject(groupForm);
      const currentCategory = getSelectedCategory();
      if (!currentCategory) return;

      const isEdit = Boolean(data.id);
      if (isEdit) {
        const group = currentCategory.groups.find((grp) => grp.id === data.id);
        if (!group) return;
        group.nameAr = data.nameAr;
        group.nameEn = data.nameEn;
        group.slug = data.slug;
        addActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø© ${data.nameAr}`);
      } else {
        const newGroup = {
          id: generateId('grp'),
          nameAr: data.nameAr,
          nameEn: data.nameEn,
          slug: data.slug,
          items: []
        };
        currentCategory.groups.push(newGroup);
        state.selectedGroupId = newGroup.id;
        addActivity(`Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© ${data.nameAr}`);
      }

      saveMenuState();
      toggleEditor(groupForm, null, true);
      renderMenuBuilder();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­.');
    });

    groupForm.querySelector('[data-action="cancel"]').addEventListener('click', () => {
      toggleEditor(groupForm, null, true);
    });

    itemForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const data = formToObject(itemForm);
      const category = getSelectedCategory();
      const group = getSelectedGroup();
      if (!category || !group) return;

      const payload = {
        id: data.id || generateId('item'),
        nameAr: data.nameAr,
        nameEn: data.nameEn,
        price: Number(data.price) || 0,
        calories: data.calories ? Number(data.calories) : null,
        image: data.image?.trim() || '',
        tags: data.tags ? data.tags.split(',').map((tag) => tag.trim()).filter(Boolean) : [],
        available: Boolean(data.available),
        featured: Boolean(data.featured),
        spicy: Boolean(data.spicy),
        seasonal: Boolean(data.seasonal),
        description: data.description?.trim() || ''
      };

      const existingIndex = group.items.findIndex((itm) => itm.id === payload.id);
      if (existingIndex >= 0) {
        group.items[existingIndex] = payload;
        addActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù ${payload.nameAr}`);
      } else {
        group.items.push(payload);
        addActivity(`Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù ${payload.nameAr}`);
      }

      saveMenuState();
      toggleEditor(itemForm, null, true);
      renderMenuBuilder();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù.');
    });

    itemForm.querySelector('[data-action="cancel"]').addEventListener('click', () => {
      toggleEditor(itemForm, null, true);
    });

    userForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const data = formToObject(userForm);
      const isEdit = Boolean(data.id);

      if (isEdit) {
        const user = state.users.find((u) => u.id === data.id);
        if (!user) return;
        user.name = data.name;
        user.email = data.email;
        user.role = data.role;
        user.status = data.status;
        user.password = data.password;
        user.updatedAt = new Date().toISOString();
        addActivity(`ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ ${user.name}`);
      } else {
        const newUser = {
          id: generateId('user'),
          name: data.name,
          email: data.email,
          role: data.role,
          status: data.status,
          password: data.password,
          updatedAt: new Date().toISOString()
        };
        state.users.push(newUser);
        addActivity(`Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ${newUser.name}`);
      }

      saveUserState();
      toggleEditor(userForm, null, true);
      renderUsers();
      showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨.');
    });

    userForm.querySelector('[data-action="cancel"]').addEventListener('click', () => {
      toggleEditor(userForm, null, true);
    });

    exportJsonBtn.addEventListener('click', () => {
      const data = JSON.stringify(state.menu, null, 2);
      exportTextarea.value = data;
      showToast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù JSON Ù„Ù„Ù…Ù†ÙŠÙˆ.');
    });

    copyExportBtn.addEventListener('click', async () => {
      if (!exportTextarea.value) {
        showToast('Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù JSON Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      try {
        await navigator.clipboard.writeText(exportTextarea.value);
        showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.');
      } catch (error) {
        showToast('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
      }
    });

    importJsonBtn.addEventListener('click', () => {
      if (!importTextarea.value.trim()) {
        showToast('Ø£Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª JSON Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.');
        return;
      }
      try {
        const parsed = JSON.parse(importTextarea.value);
        if (!Array.isArray(parsed.categories)) {
          throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚Ø©');
        }
        state.menu = parsed;
        saveMenuState();
        renderMenuBuilder();
        updateView();
        showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
      } catch (error) {
        showToast('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù JSON.');
      }
    });

    passwordForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const data = formToObject(passwordForm);
      const sessionUser = getSessionUser();
      if (!sessionUser) return;

      if (sessionUser.password !== data.current) {
        showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
        return;
      }

      if (data.next !== data.confirm) {
        showToast('ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.');
        return;
      }

      sessionUser.password = data.next;
      sessionUser.updatedAt = new Date().toISOString();
      saveUserState();
      addActivity('ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„');
      passwordForm.reset();
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
    });

    categoryList.addEventListener('click', (event) => {
      const item = event.target.closest('li');
      if (!item) return;
      const id = item.dataset.id;
      const action = event.target.dataset.action;

      if (action === 'edit') {
        const category = state.menu.categories.find((cat) => cat.id === id);
        if (!category) return;
        populateForm(categoryForm, category);
        toggleEditor(categoryForm, category.id);
        event.stopPropagation();
        return;
      }

      if (action === 'delete') {
        if (!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
        state.menu.categories = state.menu.categories.filter((cat) => cat.id !== id);
        if (state.selectedCategoryId === id) {
          state.selectedCategoryId = state.menu.categories[0]?.id || null;
          state.selectedGroupId = null;
        }
        saveMenuState();
        renderMenuBuilder();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù….');
        event.stopPropagation();
        return;
      }

      state.selectedCategoryId = id;
      const category = getSelectedCategory();
      state.selectedGroupId = category?.groups[0]?.id || null;
      renderMenuBuilder();
    });

    groupList.addEventListener('click', (event) => {
      const item = event.target.closest('li');
      if (!item) return;
      const id = item.dataset.id;
      const action = event.target.dataset.action;
      const category = getSelectedCategory();
      if (!category) return;

      if (action === 'edit') {
        const group = category.groups.find((grp) => grp.id === id);
        if (!group) return;
        populateForm(groupForm, group);
        toggleEditor(groupForm, group.id);
        event.stopPropagation();
        return;
      }

      if (action === 'delete') {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ØŸ')) return;
        category.groups = category.groups.filter((grp) => grp.id !== id);
        if (state.selectedGroupId === id) {
          state.selectedGroupId = category.groups[0]?.id || null;
        }
        saveMenuState();
        renderMenuBuilder();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©.');
        event.stopPropagation();
        return;
      }

      state.selectedGroupId = id;
      renderMenuBuilder();
    });

    itemsTableWrapper.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) return;
      const itemId = button.dataset.id;
      const action = button.dataset.action;
      const group = getSelectedGroup();
      if (!group) return;
      const item = group.items.find((it) => it.id === itemId);
      if (!item) return;

      if (action === 'edit') {
        populateForm(itemForm, {
          ...item,
          tags: item.tags?.join(', ') || ''
        });
        toggleEditor(itemForm, item.id);
        return;
      }

      if (action === 'delete') {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ')) return;
        group.items = group.items.filter((it) => it.id !== itemId);
        saveMenuState();
        renderMenuBuilder();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù.');
        return;
      }

      if (action === 'toggle') {
        item.available = !item.available;
        addActivity(`ØªØºÙŠÙŠØ± ØªÙˆÙØ± ${item.nameAr} Ø¥Ù„Ù‰ ${item.available ? 'Ù…ØªØ§Ø­' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}`);
        saveMenuState();
        renderMenuBuilder();
        return;
      }
    });

    userTable.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) return;
      const id = button.dataset.id;
      const action = button.dataset.action;
      const user = state.users.find((u) => u.id === id);
      if (!user) return;

      if (action === 'edit') {
        populateForm(userForm, user);
        toggleEditor(userForm, user.id);
        return;
      }

      if (action === 'toggle') {
        if (user.id === DEFAULT_ADMIN.id) {
          showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ÙŠÙ‚Ø§Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.');
          return;
        }
        user.status = user.status === 'active' ? 'suspended' : 'active';
        user.updatedAt = new Date().toISOString();
        saveUserState();
        renderUsers();
        addActivity(`ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ${user.name}`);
        return;
      }

      if (action === 'reset') {
        const newPassword = generatePassword();
        user.password = newPassword;
        user.updatedAt = new Date().toISOString();
        saveUserState();
        renderUsers();
        showToast(`ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©: ${newPassword}`);
        addActivity(`Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ${user.name}`);
        return;
      }
    });

    addUserBtn.addEventListener('click', () => {
      toggleEditor(userForm, null);
    });

    updateView();

    function enterDashboard() {
      loginView.classList.add('hidden');
      dashboard.classList.remove('hidden');
      const user = getSessionUser();
      currentUserName.textContent = user ? user.name : 'â€”';
      renderMenuBuilder();
      renderUsers();
      renderOverview();
      renderInsights();
    }

    function updateView() {
      document.querySelectorAll('.view').forEach((section) => {
        section.classList.toggle('active', section.id === `${state.view}View`);
      });

      const titles = {
        overview: {
          title: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
          subtitle: 'ØªØ§Ø¨Ø¹ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†ÙŠÙˆØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§ÙØŒ ÙˆØªØ­ÙƒÙ… ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙØ±Ù‚.'
        },
        menu: {
          title: 'Ù…ØµÙ…Ù… Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ø°ÙƒÙŠ',
          subtitle: 'Ø£Ø¶Ù Ø§Ù„Ø£Ù‚Ø³Ø§Ù…ØŒ Ù†Ø¸Ù… Ø§Ù„ÙØ¦Ø§ØªØŒ ÙˆØ­Ø¯Ù‘Ø« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø¹ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ø¸Ù‡ÙˆØ±.'
        },
        users: {
          title: 'Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØµØ©',
          subtitle: 'ØªØ­ÙƒÙ… ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ Ø§Ù„ØªÙØ¹ÙŠÙ„ØŒ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±.'
        },
        insights: {
          title: 'ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ',
          subtitle: 'ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ù…ÙŠØ²Ø©ØŒ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ø§Ù„Ù…ØªØ§Ø­Ø©ØŒ ÙˆØ§Ù„ÙØ±Øµ Ø§Ù„ØªØ·ÙˆÙŠØ±ÙŠØ©.'
        },
        settings: {
          title: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØµØ©',
          subtitle: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŒ ÙˆØ£Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨.'
        }
      };

      viewTitle.textContent = titles[state.view].title;
      viewSubtitle.textContent = titles[state.view].subtitle;

      if (state.view === 'menu') {
        renderMenuBuilder();
      } else if (state.view === 'users') {
        renderUsers();
      } else if (state.view === 'overview') {
        renderOverview();
      } else if (state.view === 'insights') {
        renderInsights();
      }
    }

    function renderMenuBuilder() {
      const categories = state.menu.categories;
      if (!state.selectedCategoryId && categories.length) {
        state.selectedCategoryId = categories[0].id;
      }

      const categoryMarkup = categories.map((category) => {
        const itemCount = category.groups.reduce((acc, grp) => acc + grp.items.length, 0);
        return `
          <li data-id="${category.id}" class="${category.id === state.selectedCategoryId ? 'active' : ''}">
            <div class="entity-info">
              <strong>${category.nameAr}</strong>
              <small>${category.nameEn}</small>
            </div>
            <div class="table-actions">
              <span class="badge">${itemCount} ØµÙ†Ù</span>
              <button class="btn icon" data-action="edit" title="ØªØ¹Ø¯ÙŠÙ„" type="button">âœï¸</button>
              <button class="btn icon" data-action="delete" title="Ø­Ø°Ù" type="button">ğŸ—‘ï¸</button>
            </div>
          </li>
        `;
      }).join('');

      categoryList.innerHTML = categoryMarkup || '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¹Ø¯ØŒ Ø£Ø¶Ù Ù‚Ø³Ù…Ùƒ Ø§Ù„Ø£ÙˆÙ„.</div>';

      const category = getSelectedCategory();
      if (!category) {
        groupList.innerHTML = '<div class="empty-state">Ø­Ø¯Ø¯ Ù‚Ø³Ù…Ù‹Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ¦Ø§Øª.</div>';
        itemsTableWrapper.innerHTML = '<div class="empty-state">Ø§Ø®ØªØ± ÙØ¦Ø© ÙØ±Ø¹ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù.</div>';
        return;
      }

      if (!state.selectedGroupId && category.groups.length) {
        state.selectedGroupId = category.groups[0].id;
      }

      const groupMarkup = category.groups.map((group) => {
        return `
          <li data-id="${group.id}" class="${group.id === state.selectedGroupId ? 'active' : ''}">
            <div class="entity-info">
              <strong>${group.nameAr}</strong>
              <small>${group.nameEn}</small>
            </div>
            <div class="table-actions">
              <span class="badge">${group.items.length} Ø¹Ù†ØµØ±</span>
              <button class="btn icon" data-action="edit" title="ØªØ¹Ø¯ÙŠÙ„" type="button">âœï¸</button>
              <button class="btn icon" data-action="delete" title="Ø­Ø°Ù" type="button">ğŸ—‘ï¸</button>
            </div>
          </li>
        `;
      }).join('');

      groupList.innerHTML = groupMarkup || '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª ÙØ±Ø¹ÙŠØ© Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù….</div>';

      const group = getSelectedGroup();
      if (!group) {
        itemsTableWrapper.innerHTML = '<div class="empty-state">Ø­Ø¯Ø¯ ÙØ¦Ø© ÙØ±Ø¹ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù.</div>';
        return;
      }

      const rows = group.items.map((item) => `
        <tr>
          <td>
            <strong>${item.nameAr}</strong><br />
            <small style="color:var(--muted);">${item.nameEn}</small>
          </td>
          <td>${formatPrice(item.price)}</td>
          <td>${item.calories ?? 'â€”'}</td>
          <td>${item.tags?.map((tag) => `<span class="chip">${tag}</span>`).join('') || 'â€”'}</td>
          <td>${item.available ? '<span class="badge pill-success">Ù…ØªØ§Ø­</span>' : '<span class="badge pill-danger">ØºÙŠØ± Ù…ØªØ§Ø­</span>'}</td>
          <td>
            <div class="table-actions">
              <button class="btn small" data-action="toggle" data-id="${item.id}" type="button">${item.available ? 'Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙØ¹ÙŠÙ„'}</button>
              <button class="btn small" data-action="edit" data-id="${item.id}" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn small danger" data-action="delete" data-id="${item.id}" type="button">Ø­Ø°Ù</button>
            </div>
          </td>
        </tr>
      `).join('');

      itemsTableWrapper.innerHTML = group.items.length
        ? `<div class="table-wrapper" style="overflow:auto;"><table><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø³Ø¹Ø±Ø§Øª</th><th>ÙˆØ³ÙˆÙ…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>${rows}</tbody></table></div>`
        : '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>';
    }

    function renderUsers() {
      const rows = state.users.map((user) => `
        <tr>
          <td><strong>${user.name}</strong></td>
          <td>${user.email}</td>
          <td>${translateRole(user.role)}</td>
          <td>${translateStatus(user.status)}</td>
          <td>${formatDate(user.updatedAt)}</td>
          <td>
            <div class="table-actions">
              <button class="btn small" data-action="edit" data-id="${user.id}" type="button">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn small" data-action="toggle" data-id="${user.id}" type="button">${user.status === 'active' ? 'Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙØ¹ÙŠÙ„'}</button>
              <button class="btn small" data-action="reset" data-id="${user.id}" type="button">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
            </div>
          </td>
        </tr>
      `).join('');

      userTable.innerHTML = rows || '<tr><td colspan="6" style="text-align:center;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø¹Ø¯.</td></tr>';
    }

    function renderOverview() {
      const stats = calculateStats();
      overviewStats.innerHTML = `
        <div class="stat">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
          <strong>${stats.categoryCount}</strong>
        </div>
        <div class="stat">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</span>
          <strong>${stats.groupCount}</strong>
        </div>
        <div class="stat">
          <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</span>
          <strong>${stats.itemCount}</strong>
        </div>
        <div class="stat">
          <span>Ø£ØµÙ†Ø§Ù ØºÙŠØ± Ù…ØªØ§Ø­Ø©</span>
          <strong>${stats.unavailableItems}</strong>
        </div>
      `;

      urgentCount.textContent = `${stats.urgentTasks.length} Ø¨Ù†ÙˆØ¯`;
      urgentTasks.innerHTML = stats.urgentTasks.length
        ? `<ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px;">
            ${stats.urgentTasks.map((task) => `<li style="padding:12px 14px;border-radius:14px;background:rgba(192,57,43,0.08);">${task}</li>`).join('')}
          </ul>`
        : '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø¹Ø§Ø¬Ù„Ø©ØŒ Ø£Ø­Ø³Ù†Øª!</div>';

      const recentActivity = [...state.activity].slice(-6).reverse();
      activityCount.textContent = `${recentActivity.length} Ø­Ø±ÙƒØ©`;
      activityLog.innerHTML = recentActivity.length
        ? recentActivity.map((entry) => `<li style="padding:12px 14px;border-radius:14px;background:rgba(139,94,60,0.06);display:flex;justify-content:space-between;gap:12px;">
              <span>${entry.message}</span>
              <small style="color:var(--muted);">${formatDate(entry.time)}</small>
            </li>`).join('')
        : '<li class="empty-state" style="border:none;">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯.</li>';
    }

    function renderInsights() {
      const stats = calculateStats();
      insightHighlights.innerHTML = `
        <div class="stat">
          <span>Ø£ØµÙ†Ø§Ù Ø¨Ø§Ø±Ø²Ø©</span>
          <strong>${stats.featuredCount}</strong>
        </div>
        <div class="stat">
          <span>Ø£ØµÙ†Ø§Ù Ù…ÙˆØ³Ù…ÙŠØ©</span>
          <strong>${stats.seasonalCount}</strong>
        </div>
        <div class="stat">
          <span>Ø£ØµÙ†Ø§Ù Ø¨Ù„Ø§ ØµÙˆØ±</span>
          <strong>${stats.missingImage}</strong>
        </div>
        <div class="stat">
          <span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±</span>
          <strong>${stats.avgPrice}</strong>
        </div>
      `;

      recommendations.innerHTML = stats.recommendations.length
        ? stats.recommendations.map((rec) => `<li style="padding:14px 16px;border-radius:16px;background:rgba(139,94,60,0.08);">${rec}</li>`).join('')
        : '<li class="empty-state" style="border:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠØ§Øª Ø­Ø§Ù„ÙŠØ©.</li>';

      flaggedCount.textContent = `${stats.flaggedItems.length} ØµÙ†Ù`;
      flaggedItems.innerHTML = stats.flaggedItems.length
        ? `<ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px;">
            ${stats.flaggedItems.map((item) => `<li style="padding:12px 14px;border-radius:14px;border:1px solid rgba(139,94,60,0.2);background:#fff;">
                <div style="display:flex;justify-content:space-between;gap:10px;">
                  <div>
                    <strong>${item.nameAr}</strong>
                    <div style="color:var(--muted);font-size:13px;">${item.reason}</div>
                  </div>
                  <span class="badge">${item.category}</span>
                </div>
              </li>`).join('')}
          </ul>`
        : '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ÙÙˆØ±ÙŠØ©.</div>';
    }

    function toggleEditor(form, id, hide = false) {
      if (hide) {
        form.classList.add('hidden');
        form.reset();
        form.querySelector('[name="id"]').value = '';
        return;
      }

      form.classList.remove('hidden');
      if (id) {
        form.querySelector('[name="id"]').value = id;
      } else {
        form.reset();
        form.querySelector('[name="id"]').value = '';
        if (form === itemForm) {
          form.querySelector('[name="available"]').checked = true;
          form.querySelector('[name="featured"]').checked = false;
          form.querySelector('[name="spicy"]').checked = false;
          form.querySelector('[name="seasonal"]').checked = false;
        }
      }
    }

    function populateForm(form, data) {
      Object.entries(data).forEach(([key, value]) => {
        const field = form.querySelector(`[name="${key}"]`);
        if (!field) return;
        if (field.type === 'checkbox') {
          field.checked = Boolean(value);
        } else {
          field.value = value ?? '';
        }
      });
    }

    function formToObject(form) {
      const data = new FormData(form);
      const obj = {};
      data.forEach((value, key) => {
        if (obj[key]) {
          if (!Array.isArray(obj[key])) {
            obj[key] = [obj[key]];
          }
          obj[key].push(value);
        } else {
          obj[key] = value;
        }
      });
      form.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
        obj[checkbox.name] = checkbox.checked;
      });
      return obj;
    }

    function loadMenuState() {
      try {
        const stored = localStorage.getItem(MENU_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (error) {
        console.error('Failed to parse menu state', error);
      }

      const shared = window.NEEMA_SHARED?.MENU_DATA ?? {};
      return normalizeSharedMenu(shared);
    }

    function saveMenuState() {
      localStorage.setItem(MENU_KEY, JSON.stringify(state.menu));
    }

    function loadUserState() {
      try {
        const stored = localStorage.getItem(USER_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (error) {
        console.error('Failed to parse users', error);
      }
      return [DEFAULT_ADMIN];
    }

    function saveUserState() {
      localStorage.setItem(USER_KEY, JSON.stringify(state.users));
    }

    function loadSession() {
      try {
        const stored = sessionStorage.getItem(SESSION_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (error) {
        console.error('Failed to parse session', error);
      }
      return null;
    }

    function loadActivity() {
      try {
        const stored = localStorage.getItem(ACTIVITY_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (error) {
        console.error('Failed to parse activity log', error);
      }
      return [];
    }

    function addActivity(message) {
      const entry = { message, time: new Date().toISOString() };
      state.activity.push(entry);
      state.activity = state.activity.slice(-50);
      localStorage.setItem(ACTIVITY_KEY, JSON.stringify(state.activity));
    }

    function ensureAdminExists() {
      if (!state.users.some((user) => user.id === DEFAULT_ADMIN.id)) {
        state.users.unshift(DEFAULT_ADMIN);
        saveUserState();
      }
    }

    function getSelectedCategory() {
      return state.menu.categories.find((cat) => cat.id === state.selectedCategoryId) || null;
    }

    function getSelectedGroup() {
      const category = getSelectedCategory();
      if (!category) return null;
      return category.groups.find((grp) => grp.id === state.selectedGroupId) || null;
    }

    function getSessionUser() {
      if (!state.session) return null;
      return state.users.find((user) => user.id === state.session.userId) || null;
    }

    function normalizeSharedMenu(shared) {
      const categories = Object.entries(shared).map(([slug, groups]) => {
        const label = DEFAULT_LABELS.categories[slug] || { ar: slug, en: slug };
        return {
          id: generateId('cat'),
          nameAr: label.ar,
          nameEn: label.en,
          slug,
          groups: Object.entries(groups || {}).map(([groupSlug, items]) => {
            const groupLabel = DEFAULT_LABELS.groups[slug]?.[groupSlug] || { ar: groupSlug, en: groupSlug };
            return {
              id: generateId('grp'),
              nameAr: groupLabel.ar,
              nameEn: groupLabel.en,
              slug: groupSlug,
              items: (items || []).map((item) => ({
                id: generateId('item'),
                nameAr: item.ar,
                nameEn: item.en,
                price: item.price || 0,
                calories: item.cal ?? null,
                image: item.img || '',
                tags: item.variants ? ['Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª'] : [],
                available: true,
                featured: false,
                spicy: false,
                seasonal: false,
                description: item.desc || ''
              }))
            };
          })
        };
      });
      return { categories };
    }

    function calculateStats() {
      const categories = state.menu.categories;
      let groupCount = 0;
      let itemCount = 0;
      let unavailableItems = 0;
      let featuredCount = 0;
      let seasonalCount = 0;
      let missingImage = 0;
      let priceTotal = 0;
      let priceItems = 0;

      const urgentTasks = [];
      const recommendationsList = [];
      const flaggedItemsList = [];

      categories.forEach((category) => {
        if (!category.groups.length) {
          urgentTasks.push(`Ø§Ù„Ù‚Ø³Ù… Â«${category.nameAr}Â» Ø¨Ø¯ÙˆÙ† ÙØ¦Ø§Øª ÙØ±Ø¹ÙŠØ©.`);
        }
        category.groups.forEach((group) => {
          groupCount += 1;
          if (!group.items.length) {
            urgentTasks.push(`Ø§Ù„ÙØ¦Ø© Â«${group.nameAr}Â» Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ØµÙ†Ø§Ù.`);
          }
          group.items.forEach((item) => {
            itemCount += 1;
            priceTotal += item.price || 0;
            priceItems += item.price ? 1 : 0;
            if (!item.available) {
              unavailableItems += 1;
              flaggedItemsList.push({ nameAr: item.nameAr, category: group.nameAr, reason: 'ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø·Ù„Ø¨' });
            }
            if (item.featured) featuredCount += 1;
            if (item.seasonal) seasonalCount += 1;
            if (!item.image) {
              missingImage += 1;
              flaggedItemsList.push({ nameAr: item.nameAr, category: group.nameAr, reason: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØ±Ø©' });
            }
            if (!item.description) {
              recommendationsList.push(`Ø£Ø¶Ù ÙˆØµÙÙ‹Ø§ Ù„Ù„ØµÙ†Ù Â«${item.nameAr}Â» Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„.`);
            }
            if ((item.tags || []).includes('Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª') && !item.description) {
              flaggedItemsList.push({ nameAr: item.nameAr, category: group.nameAr, reason: 'ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø±Ø§Øª Ø¯ÙˆÙ† Ø´Ø±Ø­' });
            }
          });
        });
      });

      if (missingImage > 0) {
        recommendationsList.push('Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« ØµÙˆØ± Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù†Ø§Ù‚ØµØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ØµØ±ÙŠ.');
      }

      const avgPrice = priceItems ? `${(priceTotal / priceItems).toFixed(1)} Ø±.Ø³` : 'â€”';

      return {
        categoryCount: categories.length,
        groupCount,
        itemCount,
        unavailableItems,
        featuredCount,
        seasonalCount,
        missingImage,
        avgPrice,
        urgentTasks: [...new Set(urgentTasks)],
        recommendations: [...new Set(recommendationsList)].slice(0, 6),
        flaggedItems: flaggedItemsList.slice(0, 10)
      };
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(showToast.timer);
      showToast.timer = setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }

    function generateId(prefix) {
      if (window.crypto?.randomUUID) {
        return `${prefix}-${crypto.randomUUID().slice(0, 8)}`;
      }
      return `${prefix}-${Math.random().toString(36).slice(2, 10)}`;
    }

    function formatPrice(price) {
      return price ? `${price.toFixed(2)} Ø±.Ø³` : 'â€”';
    }

    function formatDate(date) {
      if (!date) return 'â€”';
      const d = new Date(date);
      return d.toLocaleString('ar-SA', { dateStyle: 'medium', timeStyle: 'short' });
    }

    function translateRole(role) {
      switch (role) {
        case 'admin':
          return 'Ù…Ø³Ø¤ÙˆÙ„';
        case 'manager':
          return 'Ù…Ø¯ÙŠØ±';
        case 'staff':
          return 'Ù…ÙˆØ¸Ù Ø®Ø¯Ù…Ø©';
        case 'viewer':
          return 'Ø¹Ø±Ø¶ ÙÙ‚Ø·';
        default:
          return role;
      }
    }

    function translateStatus(status) {
      switch (status) {
        case 'active':
          return '<span class="badge pill-success">Ù†Ø´Ø·</span>';
        case 'suspended':
          return '<span class="badge pill-danger">Ù…ÙˆÙ‚ÙˆÙ</span>';
        case 'invited':
          return '<span class="badge">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„</span>';
        default:
          return status;
      }
    }

    function generatePassword() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789';
      let password = '';
      for (let i = 0; i < 10; i++) {
        password += chars[Math.floor(Math.random() * chars.length)];
      }
      return password;
    }

    function exportJson() {
      const data = JSON.stringify(state.menu, null, 2);
      exportTextarea.value = data;
    }
  </script>
</body>
</html>
