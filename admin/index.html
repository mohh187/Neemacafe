<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© | Menu Dashboard</title>
<style>
:root{
  --brand:#8b5e3c;--brand-light:#d4a373;--brand-dark:#70492d;
  --bg:#fafafa;--card:#fff;--text:#1f1f1f;--muted:#6b6b6b;--border:#e9e6e3;
  --success:#27ae60;--danger:#e74c3c;--warning:#f39c12;--info:#3498db;
  --radius:12px;--shadow:0 4px 12px rgba(0,0,0,.08);
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.wrap{max-width:1200px;margin:auto;padding:20px}
h1{margin:0 0 8px;display:flex;align-items:center;gap:12px;font-size:28px}
h1 .emoji{font-size:32px}
h2{margin:20px 0 12px;font-size:20px;color:var(--brand)}
h3{margin:0 0 12px;font-size:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:16px 0;box-shadow:var(--shadow)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
.col{flex:1;min-width:200px}
input,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px;width:100%;box-sizing:border-box}
textarea{min-height:80px;resize:vertical;font-family:inherit}
button{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s}
button:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
.btn-primary{background:var(--brand);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning);color:#fff}
.btn-info{background:var(--info);color:#fff}
.btn-secondary{background:#95a5a6;color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-sm{padding:6px 10px;font-size:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;text-align:right;border-bottom:1px solid var(--border)}
th{background:#f8f8f8;font-weight:700;position:sticky;top:0;z-index:1}
.badge{font-weight:700;color:var(--brand)}
.table-wrap{overflow:auto;max-height:600px;border-radius:var(--radius);border:1px solid var(--border)}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.toolbar button{flex:1 1 140px}
.note{color:var(--muted);font-size:13px;margin-top:8px;line-height:1.6}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:var(--muted)}
.img-preview{width:100px;height:100px;border-radius:10px;border:1px solid var(--border);object-fit:contain;background:#f8f8f8;margin-top:8px}
.category-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;background:var(--brand-light);color:#fff;margin:2px}
.tabs{display:flex;gap:4px;border-bottom:2px solid var(--border);margin-bottom:16px}
.tab{padding:10px 16px;cursor:pointer;border:none;background:transparent;color:var(--muted);font-weight:600;border-bottom:3px solid transparent;transition:all .2s}
.tab.active{color:var(--brand);border-bottom-color:var(--brand)}
.tab:hover{color:var(--brand-dark)}
.hidden{display:none!important}
.alert{padding:12px 16px;border-radius:10px;margin:12px 0;font-size:14px}
.alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.alert-danger{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.alert-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
.variant-item{background:#f8f8f8;padding:10px;border-radius:8px;margin:8px 0;border:1px solid var(--border)}
.variant-item .variant-row{display:flex;gap:8px;align-items:center;margin-bottom:6px}
.variant-item .variant-row input{flex:1}
.mixin-item{background:#f0f0f0;padding:8px;border-radius:6px;margin:6px 0;display:flex;gap:8px;align-items:center}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0}
.stat-card{background:linear-gradient(135deg,var(--brand),var(--brand-light));color:#fff;padding:20px;border-radius:var(--radius);box-shadow:var(--shadow)}
.stat-card h4{margin:0;font-size:14px;opacity:.9}
.stat-card .value{font-size:32px;font-weight:800;margin:8px 0}
.stat-card .label{font-size:12px;opacity:.8}
#login{max-width:400px;margin:100px auto}
</style>
</head>
<body>
<div class="wrap">
  <h1><span class="emoji">â˜•</span> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù‚Ø§Ø¦Ù…Ø© Ù†ÙŠÙ…Ø© ÙƒØ§ÙÙŠÙ‡</h1>

  <div id="login" class="card">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <div class="form-group">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
      <input id="pw" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password"/>
    </div>
    <button id="doLogin" class="btn-primary" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
    <div class="note">Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© <code>ADMIN_PASSWORD</code></div>
  </div>

  <div id="app" class="hidden">
    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±</h4>
        <div class="value" id="stat-items">0</div>
        <div class="label">Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#27ae60,#2ecc71)">
        <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
        <div class="value" id="stat-orders">0</div>
        <div class="label">Ø·Ù„Ø¨ Ù…Ø³ØªÙ„Ù…</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#3498db,#5dade2)">
        <h4>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
        <div class="value" id="stat-customers">0</div>
        <div class="label">Ø¹Ù…ÙŠÙ„ Ù…Ø³Ø¬Ù„</div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="menu">ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      <button class="tab" data-tab="orders">ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <button class="tab" data-tab="customers">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    </div>

    <!-- Menu Management Tab -->
    <div id="tab-menu" class="tab-content">
      <div class="card">
        <h3 id="form-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯</h3>
        <div id="alert-container"></div>
        
        <form id="item-form">
          <input type="hidden" id="item-id">
          
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© *</label>
                <input id="name-ar" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø³Ø¨Ø±ÙŠØ³Ùˆ" required>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© *</label>
                <input id="name-en" placeholder="Example: Espresso" required>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="form-group">
                <label>Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„) *</label>
                <input id="price" type="number" step="0.01" min="0" placeholder="15.00" required>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©</label>
                <input id="calories" type="number" min="0" placeholder="120">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
            <input id="img-url" type="url" placeholder="https://...">
            <img id="img-preview" class="img-preview hidden" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
          </div>

          <div class="form-group">
            <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
            <select id="category">
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --</option>
              <optgroup label="Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø³Ø§Ø®Ù†Ø©">
                <option value="hot-coffee">â˜• Ù‚Ù‡ÙˆØ© Ø³Ø§Ø®Ù†Ø©</option>
                <option value="hot-tea">ğŸµ Ø´Ø§ÙŠ ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª Ø³Ø§Ø®Ù†Ø©</option>
              </optgroup>
              <optgroup label="Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ø¨Ø§Ø±Ø¯Ø©">
                <option value="cold-coffee">â„ï¸ Ù‚Ù‡ÙˆØ© Ø¨Ø§Ø±Ø¯Ø©</option>
                <option value="cold-mojito">ğŸ¹ Ù…ÙˆÙ‡ÙŠØªÙˆ</option>
                <option value="cold-other">ğŸ¥¤ Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø© Ø£Ø®Ø±Ù‰</option>
              </optgroup>
              <optgroup label="Ø§Ù„Ø­Ù„Ù‰">
                <option value="dessert-cake">ğŸ° ÙƒÙŠÙƒ</option>
                <option value="dessert-side">ğŸª Ø¬Ø§Ù†Ø¨ÙŠØ§Øª</option>
              </optgroup>
            </select>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="has-variants"> Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù‡ Ø£Ø­Ø¬Ø§Ù…/Ù†ÙƒÙ‡Ø§Øª Ù…Ø®ØªÙ„ÙØ©
            </label>
          </div>

          <div id="variants-section" class="hidden">
            <h4>Ø§Ù„Ø£Ø­Ø¬Ø§Ù…/Ø§Ù„Ù†ÙƒÙ‡Ø§Øª</h4>
            <div id="variants-container"></div>
            <button type="button" class="btn-secondary btn-sm" id="add-variant">+ Ø¥Ø¶Ø§ÙØ© Ø­Ø¬Ù…/Ù†ÙƒÙ‡Ø©</button>
          </div>

          <div class="toolbar">
            <button type="submit" class="btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù†ØµØ±</button>
            <button type="button" class="btn-ghost" id="cancel-edit">Ø¥Ù„ØºØ§Ø¡</button>
            <button type="button" class="btn-danger" id="delete-current" class="hidden">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±</h3>
        <div class="toolbar">
          <button class="btn-info" id="refresh-items">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn-warning" id="export-menu">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          <input type="text" id="search-items" placeholder="ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±..." style="flex:2">
        </div>
        
        <div class="table-wrap">
          <table id="items-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>ØµÙˆØ±Ø©</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„Ø³Ø¹Ø±Ø§Øª</th>
                <th>Ø£ÙˆØ§Ù…Ø±</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Orders Tab -->
    <div id="tab-orders" class="tab-content hidden">
      <div class="card">
        <h3>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <div class="toolbar">
          <button class="btn-info" id="refresh-orders">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn-warning" id="export-orders">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª CSV</button>
        </div>
        <div class="note">ØªØ¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¢Ø®Ø± 200 Ø·Ù„Ø¨ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¬Ù‡Ø§Ø²</div>
        <div class="table-wrap">
          <table id="orders-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø·Ø§ÙˆÙ„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                <th>Ø®ØµÙ… Ø§Ù„ÙˆÙ„Ø§Ø¡</th>
                <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</th>
                <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Customers Tab -->
    <div id="tab-customers" class="tab-content hidden">
      <div class="card">
        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
        <div class="toolbar">
          <button class="btn-info" id="refresh-customers">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn-warning" id="export-customers">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ CSV</button>
        </div>
        <div class="table-wrap">
          <table id="customers-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th>
                <th>Ø§Ù„Ø¥Ù†ÙØ§Ù‚</th>
                <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</th>
                <th>Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§</th>
                <th>Ø¢Ø®Ø± Ø¬Ù‡Ø§Ø²</th>
                <th>Ø¢Ø®Ø± IP</th>
                <th>Ø¢Ø®Ø± Ø·Ù„Ø¨</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = {
  items: 'https://neema-menu.netlify.app/api/items',
  orders: 'https://neema-menu.netlify.app/api/orders',
  customers: 'https://neema-menu.netlify.app/api/customers'
};

const CATEGORY_LABELS = {
  'hot-coffee': 'â˜• Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø³Ø§Ø®Ù†Ø©',
  'hot-tea': 'â˜• Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø³Ø§Ø®Ù†Ø©',
  'cold-coffee': 'â„ï¸ Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©',
  'cold-mojito': 'â„ï¸ Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©',
  'cold-other': 'â„ï¸ Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©',
  'dessert-cake': 'ğŸ° Ø­Ù„ÙˆÙŠØ§Øª',
  'dessert-side': 'ğŸ° Ø­Ù„ÙˆÙŠØ§Øª'
};

let TOKEN = localStorage.getItem('admin_token') || '';
let allItems = [];
let allOrders = [];
let allCustomers = [];
let currentEditId = null;
let variantCounter = 0;

function authHeaders(includeJson = true) {
  const h = {};
  if (includeJson) h['content-type'] = 'application/json';
  if (TOKEN) h['authorization'] = 'Bearer ' + TOKEN;
  return h;
}

async function login() {
  const pw = document.getElementById('pw').value.trim();
  if (!pw) {
    alert('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± / Enter password');
    return;
  }
  TOKEN = pw;
  localStorage.setItem('admin_token', TOKEN);
  
  try {
    await boot();
  } catch (err) {
    console.error('Login error:', err);
    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… / Login error. Check console');
    TOKEN = '';
    localStorage.removeItem('admin_token');
  }
}

async function listItems() { return (await fetch(API.items)).json(); }
async function addItem(it) { return (await fetch(API.items, { method: 'POST', headers: authHeaders(), body: JSON.stringify(it) })).json(); }
async function updateItem(id, it) { return (await fetch(API.items + '?id=' + id, { method: 'PUT', headers: authHeaders(), body: JSON.stringify(it) })).json(); }
async function deleteItem(id) { return (await fetch(API.items + '?id=' + id, { method: 'DELETE', headers: authHeaders(false) })).json(); }
async function listOrders() { return (await fetch(API.orders, { headers: authHeaders(false) })).json(); }
async function listCustomers() { return (await fetch(API.customers, { headers: authHeaders(false) })).json(); }

function showAlert(message, type = 'info') {
  const container = document.getElementById('alert-container');
  container.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
  setTimeout(() => container.innerHTML = '', 5000);
}

function escapeHtml(str) {
  return String(str === undefined || str === null ? '' : str).replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}

function formatCurrency(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return '-';
  return num.toLocaleString('ar-SA', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
}

function formatDate(value) {
  if (!value) return '-';
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return '-';
  return d.toLocaleString('ar-SA');
}

function csvEscape(value) {
  if (value === undefined || value === null) return '""';
  const str = String(value).replace(/"/g, '""');
  return `"${str}"`;
}

function downloadCsv(filename, rows) {
  const blob = new Blob([rows], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.remove('hidden');
}

function addVariantRow() {
  const container = document.getElementById('variants-container');
  const id = ++variantCounter;
  const div = document.createElement('div');
  div.className = 'variant-item';
  div.dataset.variantId = id;
  div.innerHTML = `
    <div class="variant-row">
      <input type="text" placeholder="Ù…ÙØªØ§Ø­ (key)" data-field="key">
      <input type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ" data-field="ar">
      <input type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ" data-field="en">
      <input type="number" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø±" data-field="price">
      <button type="button" class="btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">âœ–</button>
    </div>
  `;
  container.appendChild(div);
}

function getVariantsData() {
  const variants = [];
  document.querySelectorAll('#variants-container .variant-item').forEach(item => {
    const variant = {
      key: item.querySelector('[data-field="key"]').value.trim(),
      ar: item.querySelector('[data-field="ar"]').value.trim(),
      en: item.querySelector('[data-field="en"]').value.trim(),
      price: parseFloat(item.querySelector('[data-field="price"]').value) || 0
    };
    if (variant.key && variant.ar && variant.en) {
      variants.push(variant);
    }
  });
  return variants;
}

function setVariantsData(variants) {
  document.getElementById('variants-container').innerHTML = '';
  if (!variants || !variants.length) return;
  variants.forEach(v => {
    const id = ++variantCounter;
    const div = document.createElement('div');
    div.className = 'variant-item';
    div.dataset.variantId = id;
    div.innerHTML = `
      <div class="variant-row">
        <input type="text" placeholder="Ù…ÙØªØ§Ø­" data-field="key" value="${escapeHtml(v.key || '')}">
        <input type="text" placeholder="Ø¹Ø±Ø¨ÙŠ" data-field="ar" value="${escapeHtml(v.ar || '')}">
        <input type="text" placeholder="Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ" data-field="en" value="${escapeHtml(v.en || '')}">
        <input type="number" step="0.01" placeholder="Ø³Ø¹Ø±" data-field="price" value="${v.price || ''}">
        <button type="button" class="btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">âœ–</button>
      </div>
    `;
    document.getElementById('variants-container').appendChild(div);
  });
}

function fillItemsTable(items) {
  // Filter items to only show valid categories
  const validCategories = ['hot-coffee', 'hot-tea', 'cold-coffee', 'cold-mojito', 'cold-other', 'dessert-cake', 'dessert-side'];
  const filteredItems = items.filter(item => validCategories.includes(item.category));
  
  allItems = filteredItems || [];
  const tbody = document.querySelector('#items-table tbody');
  tbody.innerHTML = '';
  
  if (!allItems.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯</td></tr>';
    return;
  }

  // Sort items by ordering
  const sortedItems = [...allItems].sort((a, b) => (a.ordering || 0) - (b.ordering || 0));
  
  sortedItems.forEach(item => {
    const tr = document.createElement('tr');
    const categoryLabel = item.category ? (CATEGORY_LABELS[item.category] || item.category) : '-';
    const imgCell = item.img_url 
      ? `<img src="${escapeHtml(item.img_url)}" style="width:40px;height:40px;object-fit:contain;border-radius:6px;border:1px solid var(--border)" alt="">`
      : '<span style="color:var(--muted);font-size:12px">Ù„Ø§ ØªÙˆØ¬Ø¯</span>';
    
    tr.innerHTML = `
      <td>${item.id}</td>
      <td>${imgCell}</td>
      <td>
        <div class="badge">${escapeHtml(item.name_ar || '')}</div>
        <div style="font-size:12px;color:var(--muted)">${escapeHtml(item.name_en || '')}</div>
      </td>
      <td><span class="category-badge">${categoryLabel}</span></td>
      <td style="font-weight:700;color:var(--brand)">${formatCurrency(item.price)}</td>
      <td>${item.calories || 0}</td>
      <td>
        <button class="btn-info btn-sm" data-edit="${item.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn-danger btn-sm" data-del="${item.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('[data-edit]').forEach(btn => {
    btn.onclick = () => editItem(btn.getAttribute('data-edit'));
  });
  
  tbody.querySelectorAll('[data-del]').forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute('data-del');
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± #${id}ØŸ`)) return;
      try {
        await deleteItem(id);
        showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        await loadItems();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±', 'danger');
      }
    };
  });
}

function editItem(id) {
  const item = allItems.find(x => String(x.id) === String(id));
  if (!item) return;
  
  currentEditId = id;
  document.getElementById('item-id').value = id;
  // Store ordering in dataset for editing
  document.getElementById('item-id').dataset.ordering = item.ordering || 0;
  document.getElementById('name-ar').value = item.name_ar || '';
  document.getElementById('name-en').value = item.name_en || '';
  document.getElementById('price').value = item.price || '';
  document.getElementById('calories').value = item.calories || '';
  document.getElementById('img-url').value = item.img_url || '';
  document.getElementById('category').value = item.category || '';
  
  if (item.img_url) {
    const preview = document.getElementById('img-preview');
    preview.src = item.img_url;
    preview.classList.remove('hidden');
  }
  
  const hasVariants = item.variants && item.variants.length > 0;
  document.getElementById('has-variants').checked = hasVariants;
  document.getElementById('variants-section').classList.toggle('hidden', !hasVariants);
  
  if (hasVariants) {
    setVariantsData(item.variants);
  }
  
  document.getElementById('form-title').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ± #${id}`;
  document.getElementById('delete-current').classList.remove('hidden');
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
  currentEditId = null;
  document.getElementById('item-form').reset();
  // Clear ordering from dataset
  delete document.getElementById('item-id').dataset.ordering;
  document.getElementById('variants-container').innerHTML = '';
  document.getElementById('variants-section').classList.add('hidden');
  document.getElementById('has-variants').checked = false;
  document.getElementById('img-preview').classList.add('hidden');
  document.getElementById('form-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯';
  document.getElementById('delete-current').classList.add('hidden');
  document.getElementById('alert-container').innerHTML = '';
}

// Helper to get next ordering value
async function getNextOrdering() {
  try {
    const response = await fetch('/api/items');
    const items = await response.json();
    const maxOrder = Math.max(...items.map(item => item.ordering || 0), 0);
    return maxOrder + 1;
  } catch (error) {
    console.error('Error getting max ordering:', error);
    return 0;
  }
}

async function saveItemForm(e) {
  e.preventDefault();
  
  const nameAr = document.getElementById('name-ar').value.trim();
  const nameEn = document.getElementById('name-en').value.trim();
  const price = parseFloat(document.getElementById('price').value) || 0;
  const calories = parseInt(document.getElementById('calories').value) || 0;
  const imgUrl = document.getElementById('img-url').value.trim();
  const category = document.getElementById('category').value.trim();
  const hasVariants = document.getElementById('has-variants').checked;
  
  if (!nameAr || !nameEn) {
    showAlert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', 'danger');
    return;
  }
  
  // Preserve existing ordering when editing, assign new when adding
  const payload = {
    name_ar: nameAr,
    name_en: nameEn,
    price: price,
    calories: calories,
    img_url: imgUrl,
    category: category || null,
    variants: hasVariants ? getVariantsData() : null,
    ordering: currentEditId ? document.getElementById('item-id').dataset.ordering : await getNextOrdering()
  };
  
  try {
    if (currentEditId) {
      await updateItem(currentEditId, payload);
      showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } else {
      await addItem(payload);
      showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }
    cancelEdit();
    await loadItems();
  } catch (err) {
    showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸', 'danger');
  }
}

// Helper to get next ordering value
async function getNextOrdering() {
  try {
    const response = await fetch('/api/items');
    const items = await response.json();
    const maxOrder = Math.max(...items.map(item => item.ordering || 0), 0);
    return maxOrder + 1;
  } catch (error) {
    console.error('Error getting max ordering:', error);
    return 0;
  }
}

function fillOrdersTable(orders) {
  allOrders = orders || [];
  const tbody = document.querySelector('#orders-table tbody');
  tbody.innerHTML = '';
  
  if (!allOrders.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</td></tr>';
    return;
  }

  allOrders.forEach(order => {
    const deviceInfo = (order && typeof order.device_info === 'object' && order.device_info) ? order.device_info : {};
    const deviceParts = [];
    if (deviceInfo.type) deviceParts.push(deviceInfo.type);
    if (deviceInfo.platform) deviceParts.push(deviceInfo.platform);
    const deviceLabel = deviceParts.length ? deviceParts.join(' â€¢ ') : '-';
    
    const loyaltySummary = (order && order.loyalty_summary && typeof order.loyalty_summary === 'object') ? order.loyalty_summary : {};
    const drinks = Number(order.drink_units ?? (loyaltySummary.drinkUnits ?? 0));
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${order.id}</td>
      <td style="font-size:12px">${escapeHtml(formatDate(order.created_at))}</td>
      <td>${escapeHtml(order.customer_name || order.customer_key || '-')}</td>
      <td>${escapeHtml(order.customer_phone || '-')}</td>
      <td>${escapeHtml(order.table_no || '-')}</td>
      <td style="font-weight:700;color:var(--brand)">${formatCurrency(order.total)}</td>
      <td>${formatCurrency(order.loyalty_discount)}</td>
      <td>${drinks}</td>
      <td style="font-size:12px">${escapeHtml(deviceLabel)}</td>
      <td style="font-size:11px">${escapeHtml(order.ip_address || '-')}</td>
    `;
    tbody.appendChild(tr);
  });
}

function fillCustomersTable(customers) {
  allCustomers = customers || [];
  const tbody = document.querySelector('#customers-table tbody');
  tbody.innerHTML = '';
  
  if (!allCustomers.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡</td></tr>';
    return;
  }

  allCustomers.forEach(customer => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(customer.name || customer.customer_key || '-')}</td>
      <td>${escapeHtml(customer.phone || '-')}</td>
      <td>${customer.total_orders || 0}</td>
      <td style="font-weight:700;color:var(--brand)">${formatCurrency(customer.total_spent)}</td>
      <td>${customer.total_drinks || 0}</td>
      <td>${customer.total_rewards || 0}</td>
      <td style="font-size:12px">${escapeHtml(customer.last_device || '-')}</td>
      <td style="font-size:11px">${escapeHtml(customer.last_ip || '-')}</td>
      <td style="font-size:12px">${escapeHtml(formatDate(customer.last_order_at))}</td>
    `;
    tbody.appendChild(tr);
  });
}

function updateStats() {
  document.getElementById('stat-items').textContent = allItems.length;
  document.getElementById('stat-orders').textContent = allOrders.length;
  document.getElementById('stat-customers').textContent = allCustomers.length;
}

async function loadItems() {
  try {
    const items = await listItems();
    fillItemsTable(Array.isArray(items) ? items : []);
    updateStats();
  } catch (err) {
    console.error('Failed to load items', err);
  }
}

async function loadOrders() {
  try {
    const orders = await listOrders();
    fillOrdersTable(Array.isArray(orders) ? orders : []);
    updateStats();
  } catch (err) {
    console.error('Failed to load orders', err);
  }
}

async function loadCustomers() {
  try {
    const customers = await listCustomers();
    fillCustomersTable(Array.isArray(customers) ? customers : []);
    updateStats();
  } catch (err) {
    console.error('Failed to load customers', err);
  }
}

async function loadAllData() {
  if (!TOKEN) return;
  
  try {
    console.log('Loading data from API...');
    const [items, orders, customers] = await Promise.all([
      loadItems(),
      loadOrders(),
      loadCustomers()
    ]);
    console.log('Data loaded successfully');
  } catch (err) {
    console.error('Failed to load data:', err);
    alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª / Failed to load data. Check database connection');
  }
}

function exportOrdersCsv() {
  if (!allOrders.length) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  const columns = [
    { label: 'id', getter: o => o.id },
    { label: 'created_at', getter: o => o.created_at || '' },
    { label: 'table_no', getter: o => o.table_no || '' },
    { label: 'customer_name', getter: o => o.customer_name || '' },
    { label: 'customer_phone', getter: o => o.customer_phone || '' },
    { label: 'total', getter: o => o.total ?? '' },
    { label: 'loyalty_discount', getter: o => o.loyalty_discount ?? 0 },
    { label: 'drink_units', getter: o => (o.drink_units ?? ((o.loyalty_summary && o.loyalty_summary.drinkUnits) ?? 0)) },
    { label: 'ip_address', getter: o => o.ip_address || '' }
  ];
  const rows = [columns.map(col => col.label).join(',')];
  allOrders.forEach(order => {
    rows.push(columns.map(col => csvEscape(col.getter(order))).join(','));
  });
  downloadCsv(`orders-${new Date().toISOString().slice(0, 10)}.csv`, rows.join('\n'));
}

function exportCustomersCsv() {
  if (!allCustomers.length) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  const columns = [
    { label: 'customer_key', getter: c => c.customer_key || '' },
    { label: 'name', getter: c => c.name || '' },
    { label: 'phone', getter: c => c.phone || '' },
    { label: 'total_orders', getter: c => c.total_orders || 0 },
    { label: 'total_spent', getter: c => c.total_spent || 0 },
    { label: 'total_drinks', getter: c => c.total_drinks || 0 },
    { label: 'total_rewards', getter: c => c.total_rewards || 0 },
    { label: 'last_order_at', getter: c => c.last_order_at || '' },
    { label: 'last_device', getter: c => c.last_device || '' },
    { label: 'last_ip', getter: c => c.last_ip || '' }
  ];
  const rows = [columns.map(col => col.label).join(',')];
  allCustomers.forEach(customer => {
    rows.push(columns.map(col => csvEscape(col.getter(customer))).join(','));
  });
  downloadCsv(`customers-${new Date().toISOString().slice(0, 10)}.csv`, rows.join('\n'));
}

function exportMenuJson() {
  if (!allItems.length) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  const json = JSON.stringify(allItems, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `menu-${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

async function boot() {
  document.getElementById('login').classList.toggle('hidden', !!TOKEN);
  document.getElementById('app').classList.toggle('hidden', !TOKEN);
  if (!TOKEN) return;
  await loadAllData();
}

// Event Listeners
console.log('Admin dashboard script loaded');
console.log('Attaching login event listener...');

const loginBtn = document.getElementById('doLogin');
if (loginBtn) {
  loginBtn.onclick = login;
  console.log('Login button found and event attached');
} else {
  console.error('Login button not found!');
}

document.getElementById('item-form').onsubmit = saveItemForm;
document.getElementById('cancel-edit').onclick = cancelEdit;
document.getElementById('delete-current').onclick = async () => {
  if (!currentEditId) return;
  if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ`)) return;
  try {
    await deleteItem(currentEditId);
    showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
    cancelEdit();
    await loadItems();
  } catch (err) {
    showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±', 'danger');
  }
};

document.getElementById('has-variants').onchange = (e) => {
  document.getElementById('variants-section').classList.toggle('hidden', !e.target.checked);
};

document.getElementById('add-variant').onclick = addVariantRow;

document.getElementById('img-url').oninput = (e) => {
  const preview = document.getElementById('img-preview');
  if (e.target.value.trim()) {
    preview.src = e.target.value.trim();
    preview.classList.remove('hidden');
  } else {
    preview.classList.add('hidden');
  }
};

document.getElementById('search-items').oninput = (e) => {
  const query = e.target.value.toLowerCase();
  const filtered = allItems.filter(item => 
    (item.name_ar && item.name_ar.toLowerCase().includes(query)) ||
    (item.name_en && item.name_en.toLowerCase().includes(query)) ||
    (item.category && item.category.toLowerCase().includes(query))
  );
  fillItemsTable(filtered);
};

document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => switchTab(tab.dataset.tab);
});

document.getElementById('refresh-items').onclick = loadItems;
document.getElementById('refresh-orders').onclick = loadOrders;
document.getElementById('refresh-customers').onclick = loadCustomers;
document.getElementById('export-orders').onclick = exportOrdersCsv;
document.getElementById('export-customers').onclick = exportCustomersCsv;
document.getElementById('export-menu').onclick = exportMenuJson;

boot();
</script>
</body>
</html>
